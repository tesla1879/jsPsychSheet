<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Your name" />


<title>Task name</title>

<script src="data:application/javascript;base64,Ly8gUGFuZG9jIDIuOSBhZGRzIGF0dHJpYnV0ZXMgb24gYm90aCBoZWFkZXIgYW5kIGRpdi4gV2UgcmVtb3ZlIHRoZSBmb3JtZXIgKHRvCi8vIGJlIGNvbXBhdGlibGUgd2l0aCB0aGUgYmVoYXZpb3Igb2YgUGFuZG9jIDwgMi44KS4KZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGZ1bmN0aW9uKGUpIHsKICB2YXIgaHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCJkaXYuc2VjdGlvbltjbGFzcyo9J2xldmVsJ10gPiA6Zmlyc3QtY2hpbGQiKTsKICB2YXIgaSwgaCwgYTsKICBmb3IgKGkgPSAwOyBpIDwgaHMubGVuZ3RoOyBpKyspIHsKICAgIGggPSBoc1tpXTsKICAgIGlmICghL15oWzEtNl0kL2kudGVzdChoLnRhZ05hbWUpKSBjb250aW51ZTsgIC8vIGl0IHNob3VsZCBiZSBhIGhlYWRlciBoMS1oNgogICAgYSA9IGguYXR0cmlidXRlczsKICAgIHdoaWxlIChhLmxlbmd0aCA+IDApIGgucmVtb3ZlQXR0cmlidXRlKGFbMF0ubmFtZSk7CiAgfQp9KTsK"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
      .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
<link rel="stylesheet" href="https://brain2ai.github.io/jsPsychSheet/jspsychsheet.css">



</head>

<body>




<h1 class="title toc-ignore">Task name</h1>
<h4 class="author">Your name</h4>



<pre><code>## Warning: package &#39;htmltools&#39; was built under R version 4.0.5</code></pre>
<script src="data:application/javascript; charset=utf-8;base64,d2luZG93LmpzUHN5Y2ggPSAoZnVuY3Rpb24oKSB7CgogIHZhciBjb3JlID0ge307CgogIGNvcmUudmVyc2lvbiA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gIjYuMy4wIiB9OwoKICAvLwogIC8vIHByaXZhdGUgdmFyaWFibGVzCiAgLy8KCiAgLy8gb3B0aW9ucwogIHZhciBvcHRzID0ge307CiAgLy8gZXhwZXJpbWVudCB0aW1lbGluZQogIHZhciB0aW1lbGluZTsKICAvLyBmbG93IGNvbnRyb2wKICB2YXIgZ2xvYmFsX3RyaWFsX2luZGV4ID0gMDsKICB2YXIgY3VycmVudF90cmlhbCA9IHt9OwogIHZhciBjdXJyZW50X3RyaWFsX2ZpbmlzaGVkID0gZmFsc2U7CiAgLy8gdGFyZ2V0IERPTSBlbGVtZW50CiAgdmFyIERPTV9jb250YWluZXI7CiAgdmFyIERPTV90YXJnZXQ7CiAgLy8gdGltZSB0aGF0IHRoZSBleHBlcmltZW50IGJlZ2FuCiAgdmFyIGV4cF9zdGFydF90aW1lOwogIC8vIGlzIHRoZSBleHBlcmltZW50IHBhdXNlZD8KICB2YXIgcGF1c2VkID0gZmFsc2U7CiAgdmFyIHdhaXRpbmcgPSBmYWxzZTsKICAvLyBkb25lIGxvYWRpbmc/CiAgdmFyIGxvYWRlZCA9IGZhbHNlOwogIHZhciBsb2FkZmFpbCA9IGZhbHNlOwogIC8vIGlzIHRoZSBwYWdlIHJldHJpZXZlZCBkaXJlY3RseSB2aWEgZmlsZTovLyBwcm90b2NvbCAodHJ1ZSkgb3IgaG9zdGVkIG9uIGEgc2VydmVyIChmYWxzZSk/CiAgdmFyIGZpbGVfcHJvdG9jb2wgPSBmYWxzZTsKCiAgLy8gc3RvcmluZyBhIHNpbmdsZSB3ZWJhdWRpbyBjb250ZXh0IHRvIHByZXZlbnQgcHJvYmxlbXMgd2l0aCBtdWx0aXBsZSBpbml0cwogIC8vIG9mIGpzUHN5Y2gKICBjb3JlLndlYmF1ZGlvX2NvbnRleHQgPSBudWxsOwogIC8vIHRlbXBvcmFyeSBwYXRjaCBmb3IgU2FmYXJpCiAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdy5oYXNPd25Qcm9wZXJ0eSgnd2Via2l0QXVkaW9Db250ZXh0JykgJiYgIXdpbmRvdy5oYXNPd25Qcm9wZXJ0eSgnQXVkaW9Db250ZXh0JykpIHsKICAgIHdpbmRvdy5BdWRpb0NvbnRleHQgPSB3ZWJraXRBdWRpb0NvbnRleHQ7CiAgfQogIC8vIGVuZCBwYXRjaAogIGNvcmUud2ViYXVkaW9fY29udGV4dCA9ICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2Ygd2luZG93LkF1ZGlvQ29udGV4dCAhPT0gJ3VuZGVmaW5lZCcpID8gbmV3IEF1ZGlvQ29udGV4dCgpIDogbnVsbDsKCiAgLy8gZW51bWVyYXRlZCB2YXJpYWJsZXMgZm9yIHNwZWNpYWwgcGFyYW1ldGVyIHR5cGVzCiAgY29yZS5BTExfS0VZUyA9ICdhbGxrZXlzJzsKICBjb3JlLk5PX0tFWVMgPSAnbm9uZSc7CgogIC8vCiAgLy8gcHVibGljIG1ldGhvZHMKICAvLwoKICBjb3JlLmluaXQgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBmdW5jdGlvbiBpbml0KCkgewogICAgICBpZih0eXBlb2Ygb3B0aW9ucy50aW1lbGluZSA9PT0gJ3VuZGVmaW5lZCcpewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ05vIHRpbWVsaW5lIGRlY2xhcmVkIGluIGpzUHN5Y2guaW5pdC4gQ2Fubm90IHN0YXJ0IGV4cGVyaW1lbnQuJykKICAgICAgfQogIAogICAgICBpZihvcHRpb25zLnRpbWVsaW5lLmxlbmd0aCA9PSAwKXsKICAgICAgICBjb25zb2xlLmVycm9yKCdObyB0cmlhbHMgaGF2ZSBiZWVuIGFkZGVkIHRvIHRoZSB0aW1lbGluZSAodGhlIHRpbWVsaW5lIGlzIGFuIGVtcHR5IGFycmF5KS4gQ2Fubm90IHN0YXJ0IGV4cGVyaW1lbnQuJykKICAgICAgfQogIAogICAgICAvLyByZXNldCB2YXJpYWJsZXMKICAgICAgdGltZWxpbmUgPSBudWxsOwogICAgICBnbG9iYWxfdHJpYWxfaW5kZXggPSAwOwogICAgICBjdXJyZW50X3RyaWFsID0ge307CiAgICAgIGN1cnJlbnRfdHJpYWxfZmluaXNoZWQgPSBmYWxzZTsKICAgICAgcGF1c2VkID0gZmFsc2U7CiAgICAgIHdhaXRpbmcgPSBmYWxzZTsKICAgICAgbG9hZGVkID0gZmFsc2U7CiAgICAgIGxvYWRmYWlsID0gZmFsc2U7CiAgICAgIGZpbGVfcHJvdG9jb2wgPSBmYWxzZTsKICAgICAganNQc3ljaC5kYXRhLnJlc2V0KCk7CiAgCiAgICAgIHZhciBkZWZhdWx0cyA9IHsKICAgICAgICAnZGlzcGxheV9lbGVtZW50JzogdW5kZWZpbmVkLAogICAgICAgICdvbl9maW5pc2gnOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgIH0sCiAgICAgICAgJ29uX3RyaWFsX3N0YXJ0JzogZnVuY3Rpb24odHJpYWwpIHsKICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgfSwKICAgICAgICAnb25fdHJpYWxfZmluaXNoJzogZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgIH0sCiAgICAgICAgJ29uX2RhdGFfdXBkYXRlJzogZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICB9LAogICAgICAgICdvbl9pbnRlcmFjdGlvbl9kYXRhX3VwZGF0ZSc6IGZ1bmN0aW9uKGRhdGEpewogICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICB9LAogICAgICAgICdvbl9jbG9zZSc6IGZ1bmN0aW9uKCl7CiAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgIH0sCiAgICAgICAgJ3VzZV93ZWJhdWRpbyc6IHRydWUsCiAgICAgICAgJ2V4Y2x1c2lvbnMnOiB7fSwKICAgICAgICAnc2hvd19wcm9ncmVzc19iYXInOiBmYWxzZSwKICAgICAgICAnbWVzc2FnZV9wcm9ncmVzc19iYXInOiAnQ29tcGxldGlvbiBQcm9ncmVzcycsCiAgICAgICAgJ2F1dG9fdXBkYXRlX3Byb2dyZXNzX2Jhcic6IHRydWUsICAgICAgICAKICAgICAgICAnZGVmYXVsdF9pdGknOiAwLAogICAgICAgICdtaW5pbXVtX3ZhbGlkX3J0JzogMCwKICAgICAgICAnZXhwZXJpbWVudF93aWR0aCc6IG51bGwsCiAgICAgICAgJ292ZXJyaWRlX3NhZmVfbW9kZSc6IGZhbHNlLAogICAgICAgICdjYXNlX3NlbnNpdGl2ZV9yZXNwb25zZXMnOiBmYWxzZSwKICAgICAgICAnZXh0ZW5zaW9ucyc6IFtdCiAgICAgIH07CgogICAgICAvLyBkZXRlY3Qgd2hldGhlciBwYWdlIGlzIHJ1bm5pbmcgaW4gYnJvd3NlciBhcyBhIGxvY2FsIGZpbGUsIGFuZCBpZiBzbywgZGlzYWJsZSB3ZWIgYXVkaW8gYW5kIHZpZGVvIHByZWxvYWRpbmcgdG8gcHJldmVudCBDT1JTIGlzc3VlcwogICAgICBpZiAod2luZG93LmxvY2F0aW9uLnByb3RvY29sID09ICdmaWxlOicgJiYgKG9wdGlvbnMub3ZlcnJpZGVfc2FmZV9tb2RlID09PSBmYWxzZSB8fCB0eXBlb2Ygb3B0aW9ucy5vdmVycmlkZV9zYWZlX21vZGUgPT0gJ3VuZGVmaW5lZCcpKSB7CiAgICAgICAgb3B0aW9ucy51c2Vfd2ViYXVkaW8gPSBmYWxzZTsKICAgICAgICBmaWxlX3Byb3RvY29sID0gdHJ1ZTsKICAgICAgICBjb25zb2xlLndhcm4oImpzUHN5Y2ggZGV0ZWN0ZWQgdGhhdCBpdCBpcyBydW5uaW5nIHZpYSB0aGUgZmlsZTovLyBwcm90b2NvbCBhbmQgbm90IG9uIGEgd2ViIHNlcnZlci4gIisKICAgICAgICAgICJUbyBwcmV2ZW50IGlzc3VlcyB3aXRoIGNyb3NzLW9yaWdpbiByZXF1ZXN0cywgV2ViIEF1ZGlvIGFuZCB2aWRlbyBwcmVsb2FkaW5nIGhhdmUgYmVlbiBkaXNhYmxlZC4gIisKICAgICAgICAgICJJZiB5b3Ugd291bGQgbGlrZSB0byBvdmVycmlkZSB0aGlzIHNldHRpbmcsIHlvdSBjYW4gc2V0ICdvdmVycmlkZV9zYWZlX21vZGUnIHRvICd0cnVlJyBpbiBqc1BzeWNoLmluaXQuICIrCiAgICAgICAgICAiRm9yIG1vcmUgaW5mb3JtYXRpb24sIHNlZTogaHR0cHM6Ly93d3cuanNwc3ljaC5vcmcvb3ZlcnZpZXcvcnVubmluZy1leHBlcmltZW50cyIpOwogICAgICB9CgogICAgICAvLyBvdmVycmlkZSBkZWZhdWx0IG9wdGlvbnMgaWYgdXNlciBzcGVjaWZpZXMgYW4gb3B0aW9uCiAgICAgIG9wdHMgPSBPYmplY3QuYXNzaWduKHt9LCBkZWZhdWx0cywgb3B0aW9ucyk7CgogICAgICAvLyBzZXQgRE9NIGVsZW1lbnQgd2hlcmUganNQc3ljaCB3aWxsIHJlbmRlciBjb250ZW50CiAgICAgIC8vIGlmIHVuZGVmaW5lZCwgdGhlbiBqc1BzeWNoIHdpbGwgdXNlIHRoZSA8Ym9keT4gdGFnIGFuZCB0aGUgZW50aXJlIHBhZ2UKICAgICAgaWYodHlwZW9mIG9wdHMuZGlzcGxheV9lbGVtZW50ID09ICd1bmRlZmluZWQnKXsKICAgICAgICAvLyBjaGVjayBpZiB0aGVyZSBpcyBhIGJvZHkgZWxlbWVudCBvbiB0aGUgcGFnZQogICAgICAgIHZhciBib2R5ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignYm9keScpOwogICAgICAgIGlmIChib2R5ID09PSBudWxsKSB7CiAgICAgICAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYm9keScpKTsKICAgICAgICB9CiAgICAgICAgLy8gdXNpbmcgdGhlIGZ1bGwgcGFnZSwgc28gd2UgbmVlZCB0aGUgSFRNTCBlbGVtZW50IHRvCiAgICAgICAgLy8gaGF2ZSAxMDAlIGhlaWdodCwgYW5kIGJvZHkgdG8gYmUgZnVsbCB3aWR0aCBhbmQgaGVpZ2h0IHdpdGgKICAgICAgICAvLyBubyBtYXJnaW4KICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdodG1sJykuc3R5bGUuaGVpZ2h0ID0gJzEwMCUnOwogICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2JvZHknKS5zdHlsZS5tYXJnaW4gPSAnMHB4JzsKICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdib2R5Jykuc3R5bGUuaGVpZ2h0ID0gJzEwMCUnOwogICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2JvZHknKS5zdHlsZS53aWR0aCA9ICcxMDAlJzsKICAgICAgICBvcHRzLmRpc3BsYXlfZWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2JvZHknKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBtYWtlIHN1cmUgdGhhdCB0aGUgZGlzcGxheSBlbGVtZW50IGV4aXN0cyBvbiB0aGUgcGFnZQogICAgICAgIHZhciBkaXNwbGF5OwogICAgICAgIGlmIChvcHRzLmRpc3BsYXlfZWxlbWVudCBpbnN0YW5jZW9mIEVsZW1lbnQpIHsKICAgICAgICAgIHZhciBkaXNwbGF5ID0gb3B0cy5kaXNwbGF5X2VsZW1lbnQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBkaXNwbGF5ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignIycgKyBvcHRzLmRpc3BsYXlfZWxlbWVudCk7CiAgICAgICAgfQogICAgICAgIGlmKGRpc3BsYXkgPT09IG51bGwpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1RoZSBkaXNwbGF5X2VsZW1lbnQgc3BlY2lmaWVkIGluIGpzUHN5Y2guaW5pdCgpIGRvZXMgbm90IGV4aXN0IGluIHRoZSBET00uJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG9wdHMuZGlzcGxheV9lbGVtZW50ID0gZGlzcGxheTsKICAgICAgICB9CiAgICAgIH0KICAgICAgb3B0cy5kaXNwbGF5X2VsZW1lbnQuaW5uZXJIVE1MID0gJzxkaXYgY2xhc3M9ImpzcHN5Y2gtY29udGVudC13cmFwcGVyIj48ZGl2IGlkPSJqc3BzeWNoLWNvbnRlbnQiPjwvZGl2PjwvZGl2Pic7CiAgICAgIERPTV9jb250YWluZXIgPSBvcHRzLmRpc3BsYXlfZWxlbWVudDsKICAgICAgRE9NX3RhcmdldCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNqc3BzeWNoLWNvbnRlbnQnKTsKICAgIAoKICAgICAgLy8gYWRkIHRhYkluZGV4IGF0dHJpYnV0ZSB0byBzY29wZSBldmVudCBsaXN0ZW5lcnMKICAgICAgb3B0cy5kaXNwbGF5X2VsZW1lbnQudGFiSW5kZXggPSAwOwoKICAgICAgLy8gYWRkIENTUyBjbGFzcyB0byBET01fdGFyZ2V0CiAgICAgIGlmKG9wdHMuZGlzcGxheV9lbGVtZW50LmNsYXNzTmFtZS5pbmRleE9mKCdqc3BzeWNoLWRpc3BsYXktZWxlbWVudCcpID09IC0xKXsKICAgICAgICBvcHRzLmRpc3BsYXlfZWxlbWVudC5jbGFzc05hbWUgKz0gJyBqc3BzeWNoLWRpc3BsYXktZWxlbWVudCc7CiAgICAgIH0KICAgICAgRE9NX3RhcmdldC5jbGFzc05hbWUgKz0gJ2pzcHN5Y2gtY29udGVudCc7CgogICAgICAvLyBzZXQgZXhwZXJpbWVudF93aWR0aCBpZiBub3QgbnVsbAogICAgICBpZihvcHRzLmV4cGVyaW1lbnRfd2lkdGggIT09IG51bGwpewogICAgICAgIERPTV90YXJnZXQuc3R5bGUud2lkdGggPSBvcHRzLmV4cGVyaW1lbnRfd2lkdGggKyAicHgiOwogICAgICB9CgogICAgICAvLyBjcmVhdGUgZXhwZXJpbWVudCB0aW1lbGluZQogICAgICB0aW1lbGluZSA9IG5ldyBUaW1lbGluZU5vZGUoewogICAgICAgIHRpbWVsaW5lOiBvcHRzLnRpbWVsaW5lCiAgICAgIH0pOwoKICAgICAgLy8gaW5pdGlhbGl6ZSBhdWRpbyBjb250ZXh0IGJhc2VkIG9uIG9wdGlvbnMgYW5kIGJyb3dzZXIgY2FwYWJpbGl0aWVzCiAgICAgIGpzUHN5Y2gucGx1Z2luQVBJLmluaXRBdWRpbygpOwoKICAgICAgLy8gYmVsb3cgY29kZSByZXNldHMgZXZlbnQgbGlzdGVuZXJzIHRoYXQgbWF5IGhhdmUgbGluZ2VyZWQgZnJvbQogICAgICAvLyBhIHByZXZpb3VzIGluY29tcGxldGUgZXhwZXJpbWVudCBsb2FkZWQgaW4gc2FtZSBET00uCiAgICAgIGpzUHN5Y2gucGx1Z2luQVBJLnJlc2V0KG9wdHMuZGlzcGxheV9lbGVtZW50KTsKICAgICAgLy8gY3JlYXRlIGtleWJvYXJkIGV2ZW50IGxpc3RlbmVycwogICAgICBqc1BzeWNoLnBsdWdpbkFQSS5jcmVhdGVLZXlib2FyZEV2ZW50TGlzdGVuZXJzKG9wdHMuZGlzcGxheV9lbGVtZW50KTsKICAgICAgLy8gY3JlYXRlIGxpc3RlbmVycyBmb3IgdXNlciBicm93c2VyIGludGVyYWN0aW9uCiAgICAgIGpzUHN5Y2guZGF0YS5jcmVhdGVJbnRlcmFjdGlvbkxpc3RlbmVycygpOwoKICAgICAgLy8gYWRkIGV2ZW50IGZvciBjbG9zaW5nIHdpbmRvdwogICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignYmVmb3JldW5sb2FkJywgb3B0cy5vbl9jbG9zZSk7CgogICAgICAvLyBjaGVjayBleGNsdXNpb25zIGJlZm9yZSBjb250aW51aW5nCiAgICAgIGNoZWNrRXhjbHVzaW9ucyhvcHRzLmV4Y2x1c2lvbnMsCiAgICAgICAgZnVuY3Rpb24oKXsKICAgICAgICAgIC8vIHN1Y2Nlc3MhIHVzZXIgY2FuIGNvbnRpbnVlLi4uCiAgICAgICAgICAvLyBzdGFydCBleHBlcmltZW50CiAgICAgICAgICBsb2FkRXh0ZW5zaW9ucygpOwogICAgICAgIH0sCiAgICAgICAgZnVuY3Rpb24oKXsKICAgICAgICAgIC8vIGZhaWwuIGluY29tcGF0aWJsZSB1c2VyLgogICAgICAgIH0KICAgICAgKTsKCiAgICAgIGZ1bmN0aW9uIGxvYWRFeHRlbnNpb25zKCkgewogICAgICAgIC8vIHJ1biB0aGUgLmluaXRpYWxpemUgbWV0aG9kIG9mIGFueSBleHRlbnNpb25zIHRoYXQgYXJlIGluIHVzZQogICAgICAgIC8vIHRoZXNlIHNob3VsZCByZXR1cm4gYSBQcm9taXNlIHRvIGluZGljYXRlIHdoZW4gbG9hZGluZyBpcyBjb21wbGV0ZQogICAgICAgIGlmIChvcHRzLmV4dGVuc2lvbnMubGVuZ3RoID09IDApIHsKICAgICAgICAgIHN0YXJ0RXhwZXJpbWVudCgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgbG9hZGVkX2V4dGVuc2lvbnMgPSAwOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvcHRzLmV4dGVuc2lvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIGV4dF9wYXJhbXMgPSBvcHRzLmV4dGVuc2lvbnNbaV0ucGFyYW1zOwogICAgICAgICAgICBpZiAoIWV4dF9wYXJhbXMpIHsKICAgICAgICAgICAgICBleHRfcGFyYW1zID0ge30KICAgICAgICAgICAgfQogICAgICAgICAgICBqc1BzeWNoLmV4dGVuc2lvbnNbb3B0cy5leHRlbnNpb25zW2ldLnR5cGVdLmluaXRpYWxpemUoZXh0X3BhcmFtcykKICAgICAgICAgICAgICAudGhlbigoKSA9PiB7CiAgICAgICAgICAgICAgICBsb2FkZWRfZXh0ZW5zaW9ucysrOwogICAgICAgICAgICAgICAgaWYgKGxvYWRlZF9leHRlbnNpb25zID09IG9wdHMuZXh0ZW5zaW9ucy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgc3RhcnRFeHBlcmltZW50KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAuY2F0Y2goKGVycm9yX21lc3NhZ2UpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3JfbWVzc2FnZSk7CiAgICAgICAgICAgICAgfSkKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICB9OwogICAgCiAgICAvLyBleGVjdXRlIGluaXQoKSB3aGVuIHRoZSBkb2N1bWVudCBpcyByZWFkeQogICAgaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICJjb21wbGV0ZSIpIHsKICAgICAgaW5pdCgpOwogICAgfSBlbHNlIHsKICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImxvYWQiLCBpbml0KTsKICAgIH0KICB9CgogIGNvcmUucHJvZ3Jlc3MgPSBmdW5jdGlvbigpIHsKCiAgICB2YXIgcGVyY2VudF9jb21wbGV0ZSA9IHR5cGVvZiB0aW1lbGluZSA9PSAndW5kZWZpbmVkJyA/IDAgOiB0aW1lbGluZS5wZXJjZW50Q29tcGxldGUoKTsKCiAgICB2YXIgb2JqID0gewogICAgICAidG90YWxfdHJpYWxzIjogdHlwZW9mIHRpbWVsaW5lID09ICd1bmRlZmluZWQnID8gdW5kZWZpbmVkIDogdGltZWxpbmUubGVuZ3RoKCksCiAgICAgICJjdXJyZW50X3RyaWFsX2dsb2JhbCI6IGdsb2JhbF90cmlhbF9pbmRleCwKICAgICAgInBlcmNlbnRfY29tcGxldGUiOiBwZXJjZW50X2NvbXBsZXRlCiAgICB9OwoKICAgIHJldHVybiBvYmo7CiAgfTsKCiAgY29yZS5zdGFydFRpbWUgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBleHBfc3RhcnRfdGltZTsKICB9OwoKICBjb3JlLnRvdGFsVGltZSA9IGZ1bmN0aW9uKCkgewogICAgaWYodHlwZW9mIGV4cF9zdGFydF90aW1lID09ICd1bmRlZmluZWQnKXsgcmV0dXJuIDA7IH0KICAgIHJldHVybiAobmV3IERhdGUoKSkuZ2V0VGltZSgpIC0gZXhwX3N0YXJ0X3RpbWUuZ2V0VGltZSgpOwogIH07CgogIGNvcmUuZ2V0RGlzcGxheUVsZW1lbnQgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBET01fdGFyZ2V0OwogIH07CgogIGNvcmUuZ2V0RGlzcGxheUNvbnRhaW5lckVsZW1lbnQgPSBmdW5jdGlvbigpewogICAgcmV0dXJuIERPTV9jb250YWluZXI7CiAgfQoKICBjb3JlLmZpbmlzaFRyaWFsID0gZnVuY3Rpb24oZGF0YSkgewoKICAgIGlmKGN1cnJlbnRfdHJpYWxfZmluaXNoZWQpeyByZXR1cm47IH0KICAgIGN1cnJlbnRfdHJpYWxfZmluaXNoZWQgPSB0cnVlOwoKICAgIC8vIHJlbW92ZSBhbnkgQ1NTIGNsYXNzZXMgdGhhdCB3ZXJlIGFkZGVkIHRvIHRoZSBET00gdmlhIGNzc19jbGFzc2VzIHBhcmFtZXRlcgogICAgaWYodHlwZW9mIGN1cnJlbnRfdHJpYWwuY3NzX2NsYXNzZXMgIT09ICd1bmRlZmluZWQnICYmIEFycmF5LmlzQXJyYXkoY3VycmVudF90cmlhbC5jc3NfY2xhc3NlcykpewogICAgICBET01fdGFyZ2V0LmNsYXNzTGlzdC5yZW1vdmUoLi4uY3VycmVudF90cmlhbC5jc3NfY2xhc3Nlcyk7CiAgICB9CgogICAgLy8gd3JpdGUgdGhlIGRhdGEgZnJvbSB0aGUgdHJpYWwKICAgIGRhdGEgPSB0eXBlb2YgZGF0YSA9PSAndW5kZWZpbmVkJyA/IHt9IDogZGF0YTsKICAgIGpzUHN5Y2guZGF0YS53cml0ZShkYXRhKTsKCiAgICAvLyBnZXQgYmFjayB0aGUgZGF0YSB3aXRoIGFsbCBvZiB0aGUgZGVmYXVsdHMgaW4KICAgIHZhciB0cmlhbF9kYXRhID0ganNQc3ljaC5kYXRhLmdldCgpLmZpbHRlcih7dHJpYWxfaW5kZXg6IGdsb2JhbF90cmlhbF9pbmRleH0pOwoKICAgIC8vIGZvciB0cmlhbC1sZXZlbCBjYWxsYmFja3MsIHdlIGp1c3Qgd2FudCB0byBwYXNzIGluIGEgcmVmZXJlbmNlIHRvIHRoZSB2YWx1ZXMKICAgIC8vIG9mIHRoZSBEYXRhQ29sbGVjdGlvbiwgZm9yIGVhc3kgYWNjZXNzIGFuZCBlZGl0aW5nLgogICAgdmFyIHRyaWFsX2RhdGFfdmFsdWVzID0gdHJpYWxfZGF0YS52YWx1ZXMoKVswXTsKCiAgICBpZih0eXBlb2YgY3VycmVudF90cmlhbC5zYXZlX3RyaWFsX3BhcmFtZXRlcnMgPT0gJ29iamVjdCcpewogICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGN1cnJlbnRfdHJpYWwuc2F2ZV90cmlhbF9wYXJhbWV0ZXJzKTsKICAgICAgZm9yKHZhciBpPTA7IGk8a2V5cy5sZW5ndGg7IGkrKyl7CiAgICAgICAgdmFyIGtleV92YWwgPSBjdXJyZW50X3RyaWFsLnNhdmVfdHJpYWxfcGFyYW1ldGVyc1trZXlzW2ldXTsKICAgICAgICBpZihrZXlfdmFsID09PSB0cnVlKXsKICAgICAgICAgIGlmKHR5cGVvZiBjdXJyZW50X3RyaWFsW2tleXNbaV1dID09ICd1bmRlZmluZWQnKXsKICAgICAgICAgICAgY29uc29sZS53YXJuKGBJbnZhbGlkIHBhcmFtZXRlciBzcGVjaWZpZWQgaW4gc2F2ZV90cmlhbF9wYXJhbWV0ZXJzLiBUcmlhbCBoYXMgbm8gcHJvcGVydHkgY2FsbGVkICIke2tleXNbaV19Ii5gKQogICAgICAgICAgfSBlbHNlIGlmKHR5cGVvZiBjdXJyZW50X3RyaWFsW2tleXNbaV1dID09ICdmdW5jdGlvbicpewogICAgICAgICAgICB0cmlhbF9kYXRhX3ZhbHVlc1trZXlzW2ldXSA9IGN1cnJlbnRfdHJpYWxba2V5c1tpXV0udG9TdHJpbmcoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRyaWFsX2RhdGFfdmFsdWVzW2tleXNbaV1dID0gY3VycmVudF90cmlhbFtrZXlzW2ldXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYoa2V5X3ZhbCA9PT0gZmFsc2UpewogICAgICAgICAgLy8gd2UgZG9uJ3QgYWxsb3cgaW50ZXJuYWxfbm9kZV9pZCBvciB0cmlhbF9pbmRleCB0byBiZSBkZWxldGVkIGJlY2F1c2UgaXQgd291bGQgYnJlYWsgb3RoZXIgdGhpbmdzCiAgICAgICAgICBpZihrZXlzW2ldICE9PSAnaW50ZXJuYWxfbm9kZV9pZCcgJiYga2V5c1tpXSAhPT0gJ3RyaWFsX2luZGV4Jyl7CiAgICAgICAgICAgIGRlbGV0ZSB0cmlhbF9kYXRhX3ZhbHVlc1trZXlzW2ldXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8vIGhhbmRsZSBleHRlbnNpb24gY2FsbGJhY2tzCiAgICBpZihBcnJheS5pc0FycmF5KGN1cnJlbnRfdHJpYWwuZXh0ZW5zaW9ucykpewogICAgICBmb3IodmFyIGk9MDsgaTxjdXJyZW50X3RyaWFsLmV4dGVuc2lvbnMubGVuZ3RoOyBpKyspewogICAgICAgIHZhciBleHRfZGF0YV92YWx1ZXMgPSBqc1BzeWNoLmV4dGVuc2lvbnNbY3VycmVudF90cmlhbC5leHRlbnNpb25zW2ldLnR5cGVdLm9uX2ZpbmlzaChjdXJyZW50X3RyaWFsLmV4dGVuc2lvbnNbaV0ucGFyYW1zKTsKICAgICAgICBPYmplY3QuYXNzaWduKHRyaWFsX2RhdGFfdmFsdWVzLCBleHRfZGF0YV92YWx1ZXMpOwogICAgICB9CiAgICB9CiAgICAKICAgIC8vIGFib3V0IHRvIGV4ZWN1dGUgbG90cyBvZiBjYWxsYmFja3MsIHNvIHN3aXRjaCBjb250ZXh0LgogICAganNQc3ljaC5pbnRlcm5hbC5jYWxsX2ltbWVkaWF0ZSA9IHRydWU7CgogICAgLy8gaGFuZGxlIGNhbGxiYWNrIGF0IHBsdWdpbiBsZXZlbAogICAgaWYgKHR5cGVvZiBjdXJyZW50X3RyaWFsLm9uX2ZpbmlzaCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjdXJyZW50X3RyaWFsLm9uX2ZpbmlzaCh0cmlhbF9kYXRhX3ZhbHVlcyk7CiAgICB9CgogICAgLy8gaGFuZGxlIGNhbGxiYWNrIGF0IHdob2xlLWV4cGVyaW1lbnQgbGV2ZWwKICAgIG9wdHMub25fdHJpYWxfZmluaXNoKHRyaWFsX2RhdGFfdmFsdWVzKTsKCiAgICAvLyBhZnRlciB0aGUgYWJvdmUgY2FsbGJhY2tzIGFyZSBjb21wbGV0ZSwgdGhlbiB0aGUgZGF0YSBzaG91bGQgYmUgZmluYWxpemVkCiAgICAvLyBmb3IgdGhpcyB0cmlhbC4gY2FsbCB0aGUgb25fZGF0YV91cGRhdGUgaGFuZGxlciwgcGFzc2luZyBpbiB0aGUgc2FtZQogICAgLy8gZGF0YSBvYmplY3QgdGhhdCBqdXN0IHdlbnQgdGhyb3VnaCB0aGUgdHJpYWwncyBmaW5pc2ggaGFuZGxlcnMuCiAgICBvcHRzLm9uX2RhdGFfdXBkYXRlKHRyaWFsX2RhdGFfdmFsdWVzKTsKCiAgICAvLyBkb25lIHdpdGggY2FsbGJhY2tzCiAgICBqc1BzeWNoLmludGVybmFsLmNhbGxfaW1tZWRpYXRlID0gZmFsc2U7CgogICAgLy8gd2FpdCBmb3IgaXRpCiAgICBpZiAodHlwZW9mIGN1cnJlbnRfdHJpYWwucG9zdF90cmlhbF9nYXAgPT09IG51bGwgfHwgdHlwZW9mIGN1cnJlbnRfdHJpYWwucG9zdF90cmlhbF9nYXAgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgIGlmIChvcHRzLmRlZmF1bHRfaXRpID4gMCkgewogICAgICAgIHNldFRpbWVvdXQobmV4dFRyaWFsLCBvcHRzLmRlZmF1bHRfaXRpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBuZXh0VHJpYWwoKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKGN1cnJlbnRfdHJpYWwucG9zdF90cmlhbF9nYXAgPiAwKSB7CiAgICAgICAgc2V0VGltZW91dChuZXh0VHJpYWwsIGN1cnJlbnRfdHJpYWwucG9zdF90cmlhbF9nYXApOwogICAgICB9IGVsc2UgewogICAgICAgIG5leHRUcmlhbCgpOwogICAgICB9CiAgICB9CiAgfQoKICBjb3JlLmVuZEV4cGVyaW1lbnQgPSBmdW5jdGlvbihlbmRfbWVzc2FnZSkgewogICAgdGltZWxpbmUuZW5kX21lc3NhZ2UgPSBlbmRfbWVzc2FnZTsKICAgIHRpbWVsaW5lLmVuZCgpOwogICAganNQc3ljaC5wbHVnaW5BUEkuY2FuY2VsQWxsS2V5Ym9hcmRSZXNwb25zZXMoKTsKICAgIGpzUHN5Y2gucGx1Z2luQVBJLmNsZWFyQWxsVGltZW91dHMoKTsKICAgIGNvcmUuZmluaXNoVHJpYWwoKTsKICB9CgogIGNvcmUuZW5kQ3VycmVudFRpbWVsaW5lID0gZnVuY3Rpb24oKSB7CiAgICB0aW1lbGluZS5lbmRBY3RpdmVOb2RlKCk7CiAgfQoKICBjb3JlLmN1cnJlbnRUcmlhbCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGN1cnJlbnRfdHJpYWw7CiAgfTsKCiAgY29yZS5pbml0U2V0dGluZ3MgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBvcHRzOwogIH07CgogIGNvcmUuY3VycmVudFRpbWVsaW5lTm9kZUlEID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGltZWxpbmUuYWN0aXZlSUQoKTsKICB9OwoKICBjb3JlLnRpbWVsaW5lVmFyaWFibGUgPSBmdW5jdGlvbih2YXJuYW1lLCBpbW1lZGlhdGUpewogICAgaWYodHlwZW9mIGltbWVkaWF0ZSA9PSAndW5kZWZpbmVkJyl7IGltbWVkaWF0ZSA9IGZhbHNlOyB9CiAgICBpZihqc1BzeWNoLmludGVybmFsLmNhbGxfaW1tZWRpYXRlIHx8IGltbWVkaWF0ZSA9PT0gdHJ1ZSl7CiAgICAgIHJldHVybiB0aW1lbGluZS50aW1lbGluZVZhcmlhYmxlKHZhcm5hbWUpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgeyByZXR1cm4gdGltZWxpbmUudGltZWxpbmVWYXJpYWJsZSh2YXJuYW1lKTsgfQogICAgfQogIH0KCiAgY29yZS5hbGxUaW1lbGluZVZhcmlhYmxlcyA9IGZ1bmN0aW9uKCl7CiAgICByZXR1cm4gdGltZWxpbmUuYWxsVGltZWxpbmVWYXJpYWJsZXMoKTsKICB9CgogIGNvcmUuYWRkTm9kZVRvRW5kT2ZUaW1lbGluZSA9IGZ1bmN0aW9uKG5ld190aW1lbGluZSwgcHJlbG9hZF9jYWxsYmFjayl7CiAgICB0aW1lbGluZS5pbnNlcnQobmV3X3RpbWVsaW5lKTsKICB9CgogIGNvcmUucGF1c2VFeHBlcmltZW50ID0gZnVuY3Rpb24oKXsKICAgIHBhdXNlZCA9IHRydWU7CiAgfQoKICBjb3JlLnJlc3VtZUV4cGVyaW1lbnQgPSBmdW5jdGlvbigpewogICAgcGF1c2VkID0gZmFsc2U7CiAgICBpZih3YWl0aW5nKXsKICAgICAgd2FpdGluZyA9IGZhbHNlOwogICAgICBuZXh0VHJpYWwoKTsKICAgIH0KICB9CgogIGNvcmUubG9hZEZhaWwgPSBmdW5jdGlvbihtZXNzYWdlKXsKICAgIG1lc3NhZ2UgPSBtZXNzYWdlIHx8ICc8cD5UaGUgZXhwZXJpbWVudCBmYWlsZWQgdG8gbG9hZC48L3A+JzsKICAgIGxvYWRmYWlsID0gdHJ1ZTsKICAgIERPTV90YXJnZXQuaW5uZXJIVE1MID0gbWVzc2FnZTsKICB9CgogIGNvcmUuZ2V0U2FmZU1vZGVTdGF0dXMgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBmaWxlX3Byb3RvY29sOwogIH0KCiAgZnVuY3Rpb24gVGltZWxpbmVOb2RlKHBhcmFtZXRlcnMsIHBhcmVudCwgcmVsYXRpdmVJRCkgewoKICAgIC8vIGEgdW5pcXVlIElEIGZvciB0aGlzIG5vZGUsIHJlbGF0aXZlIHRvIHRoZSBwYXJlbnQKICAgIHZhciByZWxhdGl2ZV9pZDsKCiAgICAvLyBzdG9yZSB0aGUgcGFyZW50IGZvciB0aGlzIG5vZGUKICAgIHZhciBwYXJlbnRfbm9kZTsKCiAgICAvLyBwYXJhbWV0ZXJzIGZvciB0aGUgdHJpYWwgaWYgdGhlIG5vZGUgY29udGFpbnMgYSB0cmlhbAogICAgdmFyIHRyaWFsX3BhcmFtZXRlcnM7CgogICAgLy8gcGFyYW1ldGVycyBmb3Igbm9kZXMgdGhhdCBjb250YWluIHRpbWVsaW5lcwogICAgdmFyIHRpbWVsaW5lX3BhcmFtZXRlcnM7CgogICAgLy8gc3RvcmVzIHRyaWFsIGluZm9ybWF0aW9uIG9uIGEgbm9kZSB0aGF0IGNvbnRhaW5zIGEgdGltZWxpbmUKICAgIC8vIHVzZWQgZm9yIGFkZGluZyBuZXcgdHJpYWxzCiAgICB2YXIgbm9kZV90cmlhbF9kYXRhOwoKICAgIC8vIHRyYWNrIHByb2dyZXNzIHRocm91Z2ggdGhlIG5vZGUKICAgIHZhciBwcm9ncmVzcyA9IHsKICAgICAgY3VycmVudF9sb2NhdGlvbjogLTEsIC8vIHdoZXJlIG9uIHRoZSB0aW1lbGluZSAod2hpY2ggdGltZWxpbmVub2RlKQogICAgICBjdXJyZW50X3ZhcmlhYmxlX3NldDogMCwgLy8gd2hpY2ggc2V0IG9mIHZhcmlhYmxlcyB0byB1c2UgZnJvbSB0aW1lbGluZV92YXJpYWJsZXMKICAgICAgY3VycmVudF9yZXBldGl0aW9uOiAwLCAvLyBob3cgbWFueSB0aW1lcyB0aHJvdWdoIHRoZSB2YXJpYWJsZSBzZXQgb24gdGhpcyBydW4gb2YgdGhlIG5vZGUKICAgICAgY3VycmVudF9pdGVyYXRpb246IDAsIC8vIGhvdyBtYW55IHRpbWVzIHRoaXMgbm9kZSBoYXMgYmVlbiByZXZpc2l0ZWQKICAgICAgZG9uZTogZmFsc2UKICAgIH0KCiAgICAvLyByZWZlcmVuY2UgdG8gc2VsZgogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIC8vIHJlY3Vyc2l2ZWx5IGdldCB0aGUgbmV4dCB0cmlhbCB0byBydW4uCiAgICAvLyBpZiB0aGlzIG5vZGUgaXMgYSBsZWFmICh0cmlhbCksIHRoZW4gcmV0dXJuIHRoZSB0cmlhbC4KICAgIC8vIG90aGVyd2lzZSwgcmVjdXJzaXZlbHkgZmluZCB0aGUgbmV4dCB0cmlhbCBpbiB0aGUgY2hpbGQgdGltZWxpbmUuCiAgICB0aGlzLnRyaWFsID0gZnVuY3Rpb24oKSB7CiAgICAgIGlmICh0eXBlb2YgdGltZWxpbmVfcGFyYW1ldGVycyA9PSAndW5kZWZpbmVkJykgewogICAgICAgIC8vIHJldHVybnMgYSBjbG9uZSBvZiB0aGUgdHJpYWxfcGFyYW1ldGVycyB0bwogICAgICAgIC8vIHByb3RlY3QgZnVuY3Rpb25zLgogICAgICAgIHJldHVybiBqc1BzeWNoLnV0aWxzLmRlZXBDb3B5KHRyaWFsX3BhcmFtZXRlcnMpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmIChwcm9ncmVzcy5jdXJyZW50X2xvY2F0aW9uID49IHRpbWVsaW5lX3BhcmFtZXRlcnMudGltZWxpbmUubGVuZ3RoKSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIHRpbWVsaW5lX3BhcmFtZXRlcnMudGltZWxpbmVbcHJvZ3Jlc3MuY3VycmVudF9sb2NhdGlvbl0udHJpYWwoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICB0aGlzLm1hcmtDdXJyZW50VHJpYWxDb21wbGV0ZSA9IGZ1bmN0aW9uKCkgewogICAgICBpZih0eXBlb2YgdGltZWxpbmVfcGFyYW1ldGVycyA9PSAndW5kZWZpbmVkJyl7CiAgICAgICAgcHJvZ3Jlc3MuZG9uZSA9IHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGltZWxpbmVfcGFyYW1ldGVycy50aW1lbGluZVtwcm9ncmVzcy5jdXJyZW50X2xvY2F0aW9uXS5tYXJrQ3VycmVudFRyaWFsQ29tcGxldGUoKTsKICAgICAgfQogICAgfQoKICAgIHRoaXMubmV4dFJlcGV0aXRvbiA9IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnNldFRpbWVsaW5lVmFyaWFibGVzT3JkZXIoKTsKICAgICAgcHJvZ3Jlc3MuY3VycmVudF9sb2NhdGlvbiA9IC0xOwogICAgICBwcm9ncmVzcy5jdXJyZW50X3ZhcmlhYmxlX3NldCA9IDA7CiAgICAgIHByb2dyZXNzLmN1cnJlbnRfcmVwZXRpdGlvbisrOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRpbWVsaW5lX3BhcmFtZXRlcnMudGltZWxpbmUubGVuZ3RoOyBpKyspIHsKICAgICAgICB0aW1lbGluZV9wYXJhbWV0ZXJzLnRpbWVsaW5lW2ldLnJlc2V0KCk7CiAgICAgIH0KICAgIH0KCiAgICAvLyBzZXQgdGhlIG9yZGVyIGZvciBnb2luZyB0aHJvdWdoIHRoZSB0aW1lbGluZSB2YXJpYWJsZXMgYXJyYXkKICAgIHRoaXMuc2V0VGltZWxpbmVWYXJpYWJsZXNPcmRlciA9IGZ1bmN0aW9uKCkgewoKICAgICAgLy8gY2hlY2sgdG8gbWFrZSBzdXJlIHRoaXMgbm9kZSBoYXMgdmFyaWFibGVzCiAgICAgIGlmKHR5cGVvZiB0aW1lbGluZV9wYXJhbWV0ZXJzID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgdGltZWxpbmVfcGFyYW1ldGVycy50aW1lbGluZV92YXJpYWJsZXMgPT09ICd1bmRlZmluZWQnKXsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBvcmRlciA9IFtdOwogICAgICBmb3IodmFyIGk9MDsgaTx0aW1lbGluZV9wYXJhbWV0ZXJzLnRpbWVsaW5lX3ZhcmlhYmxlcy5sZW5ndGg7IGkrKyl7CiAgICAgICAgb3JkZXIucHVzaChpKTsKICAgICAgfQoKICAgICAgaWYodHlwZW9mIHRpbWVsaW5lX3BhcmFtZXRlcnMuc2FtcGxlICE9PSAndW5kZWZpbmVkJyl7CiAgICAgICAgaWYodGltZWxpbmVfcGFyYW1ldGVycy5zYW1wbGUudHlwZSA9PSAnY3VzdG9tJyl7CiAgICAgICAgICBvcmRlciA9IHRpbWVsaW5lX3BhcmFtZXRlcnMuc2FtcGxlLmZuKG9yZGVyKTsKICAgICAgICB9IGVsc2UgaWYodGltZWxpbmVfcGFyYW1ldGVycy5zYW1wbGUudHlwZSA9PSAnd2l0aC1yZXBsYWNlbWVudCcpewogICAgICAgICAgb3JkZXIgPSBqc1BzeWNoLnJhbmRvbWl6YXRpb24uc2FtcGxlV2l0aFJlcGxhY2VtZW50KG9yZGVyLCB0aW1lbGluZV9wYXJhbWV0ZXJzLnNhbXBsZS5zaXplLCB0aW1lbGluZV9wYXJhbWV0ZXJzLnNhbXBsZS53ZWlnaHRzKTsKICAgICAgICB9IGVsc2UgaWYodGltZWxpbmVfcGFyYW1ldGVycy5zYW1wbGUudHlwZSA9PSAnd2l0aG91dC1yZXBsYWNlbWVudCcpewogICAgICAgICAgb3JkZXIgPSBqc1BzeWNoLnJhbmRvbWl6YXRpb24uc2FtcGxlV2l0aG91dFJlcGxhY2VtZW50KG9yZGVyLCB0aW1lbGluZV9wYXJhbWV0ZXJzLnNhbXBsZS5zaXplKTsKICAgICAgICB9IGVsc2UgaWYodGltZWxpbmVfcGFyYW1ldGVycy5zYW1wbGUudHlwZSA9PSAnZml4ZWQtcmVwZXRpdGlvbnMnKXsKICAgICAgICAgIG9yZGVyID0ganNQc3ljaC5yYW5kb21pemF0aW9uLnJlcGVhdChvcmRlciwgdGltZWxpbmVfcGFyYW1ldGVycy5zYW1wbGUuc2l6ZSwgZmFsc2UpOwogICAgICAgIH0gZWxzZSBpZih0aW1lbGluZV9wYXJhbWV0ZXJzLnNhbXBsZS50eXBlID09ICdhbHRlcm5hdGUtZ3JvdXBzJyl7CiAgICAgICAgICBvcmRlciA9IGpzUHN5Y2gucmFuZG9taXphdGlvbi5zaHVmZmxlQWx0ZXJuYXRlR3JvdXBzKHRpbWVsaW5lX3BhcmFtZXRlcnMuc2FtcGxlLmdyb3VwcywgdGltZWxpbmVfcGFyYW1ldGVycy5zYW1wbGUucmFuZG9taXplX2dyb3VwX29yZGVyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc29sZS5lcnJvcignSW52YWxpZCB0eXBlIGluIHRpbWVsaW5lIHNhbXBsZSBwYXJhbWV0ZXJzLiBWYWxpZCBvcHRpb25zIGZvciB0eXBlIGFyZSAiY3VzdG9tIiwgIndpdGgtcmVwbGFjZW1lbnQiLCAid2l0aG91dC1yZXBsYWNlbWVudCIsICJmaXhlZC1yZXBldGl0aW9ucyIsIGFuZCAiYWx0ZXJuYXRlLWdyb3VwcyInKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmKHRpbWVsaW5lX3BhcmFtZXRlcnMucmFuZG9taXplX29yZGVyKSB7CiAgICAgICAgb3JkZXIgPSBqc1BzeWNoLnJhbmRvbWl6YXRpb24uc2h1ZmZsZShvcmRlcik7CiAgICAgIH0KCiAgICAgIHByb2dyZXNzLm9yZGVyID0gb3JkZXI7CiAgICB9CgogICAgLy8gbmV4dCB2YXJpYWJsZSBzZXQKICAgIHRoaXMubmV4dFNldCA9IGZ1bmN0aW9uKCkgewogICAgICBwcm9ncmVzcy5jdXJyZW50X2xvY2F0aW9uID0gLTE7CiAgICAgIHByb2dyZXNzLmN1cnJlbnRfdmFyaWFibGVfc2V0Kys7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGltZWxpbmVfcGFyYW1ldGVycy50aW1lbGluZS5sZW5ndGg7IGkrKykgewogICAgICAgIHRpbWVsaW5lX3BhcmFtZXRlcnMudGltZWxpbmVbaV0ucmVzZXQoKTsKICAgICAgfQogICAgfQoKICAgIC8vIHVwZGF0ZSB0aGUgY3VycmVudCB0cmlhbCBub2RlIHRvIGJlIGNvbXBsZXRlZAogICAgLy8gcmV0dXJucyB0cnVlIGlmIHRoZSBub2RlIGlzIGNvbXBsZXRlIGFmdGVyIGFkdmFuY2UgKGFsbCBzdWJub2RlcyBhcmUgYWxzbyBjb21wbGV0ZSkKICAgIC8vIHJldHVybnMgZmFsc2Ugb3RoZXJ3aXNlCiAgICB0aGlzLmFkdmFuY2UgPSBmdW5jdGlvbiAoKSB7CgogICAgICAvLyBmaXJzdCBjaGVjayB0byBzZWUgaWYgZG9uZQogICAgICBpZiAocHJvZ3Jlc3MuZG9uZSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICAvLyBpZiBub2RlIGhhcyBub3Qgc3RhcnRlZCB5ZXQgKHByb2dyZXNzLmN1cnJlbnRfbG9jYXRpb24gPT0gLTEpLAogICAgICAvLyB0aGVuIHRyeSB0byBzdGFydCB0aGUgbm9kZS4KICAgICAgaWYgKHByb2dyZXNzLmN1cnJlbnRfbG9jYXRpb24gPT0gLTEpIHsKICAgICAgICAvLyBjaGVjayBmb3Igb25fdGltZWxpbmVfc3RhcnQgYW5kIGNvbmRpdG9uYWwgZnVuY3Rpb24gb24gbm9kZXMgd2l0aCB0aW1lbGluZXMKICAgICAgICBpZiAodHlwZW9mIHRpbWVsaW5lX3BhcmFtZXRlcnMgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAvLyBvbmx5IHJ1biB0aGUgY29uZGl0aW9uYWwgZnVuY3Rpb24gaWYgdGhpcyBpcyB0aGUgZmlyc3QgcmVwZXRpdGlvbiBvZiB0aGUgdGltZWxpbmUgd2hlbgogICAgICAgICAgLy8gcmVwZXRpdGlvbnMgPiAxLCBhbmQgb25seSB3aGVuIG9uIHRoZSBmaXJzdCB2YXJpYWJsZSBzZXQKICAgICAgICAgIGlmICh0eXBlb2YgdGltZWxpbmVfcGFyYW1ldGVycy5jb25kaXRpb25hbF9mdW5jdGlvbiAhPT0gJ3VuZGVmaW5lZCcgJiYgcHJvZ3Jlc3MuY3VycmVudF9yZXBldGl0aW9uID09IDAgJiYgcHJvZ3Jlc3MuY3VycmVudF92YXJpYWJsZV9zZXQgPT0gMCkgewogICAgICAgICAgICBqc1BzeWNoLmludGVybmFsLmNhbGxfaW1tZWRpYXRlID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIGNvbmRpdGlvbmFsX3Jlc3VsdCA9IHRpbWVsaW5lX3BhcmFtZXRlcnMuY29uZGl0aW9uYWxfZnVuY3Rpb24oKTsKICAgICAgICAgICAganNQc3ljaC5pbnRlcm5hbC5jYWxsX2ltbWVkaWF0ZSA9IGZhbHNlOwogICAgICAgICAgICAvLyBpZiB0aGUgY29uZGl0aW9uYWxfZnVuY3Rpb24oKSByZXR1cm5zIGZhbHNlLCB0aGVuIHRoZSB0aW1lbGluZQogICAgICAgICAgICAvLyBkb2Vzbid0IHJ1biBhbmQgaXMgbWFya2VkIGFzIGNvbXBsZXRlLgogICAgICAgICAgICBpZiAoY29uZGl0aW9uYWxfcmVzdWx0ID09IGZhbHNlKSB7CiAgICAgICAgICAgICAgcHJvZ3Jlc3MuZG9uZSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBpZiB3ZSByZWFjaCB0aGlzIHBvaW50IHRoZW4gdGhlIG5vZGUgaGFzIGl0cyBvd24gdGltZWxpbmUgYW5kIHdpbGwgc3RhcnQKICAgICAgICAgIC8vIHNvIHdlIG5lZWQgdG8gY2hlY2sgaWYgdGhlcmUgaXMgYW4gb25fdGltZWxpbmVfc3RhcnQgZnVuY3Rpb24gaWYgd2UgYXJlIG9uIHRoZSBmaXJzdCB2YXJpYWJsZSBzZXQKICAgICAgICAgIGlmICh0eXBlb2YgdGltZWxpbmVfcGFyYW1ldGVycy5vbl90aW1lbGluZV9zdGFydCAhPT0gJ3VuZGVmaW5lZCcgJiYgcHJvZ3Jlc3MuY3VycmVudF92YXJpYWJsZV9zZXQgPT0gMCkgewogICAgICAgICAgICB0aW1lbGluZV9wYXJhbWV0ZXJzLm9uX3RpbWVsaW5lX3N0YXJ0KCk7CiAgICAgICAgICB9CiAgICAgICAgICAKCiAgICAgICAgfQogICAgICAgIC8vIGlmIHdlIHJlYWNoIHRoaXMgcG9pbnQsIHRoZW4gZWl0aGVyIHRoZSBub2RlIGRvZXNuJ3QgaGF2ZSBhIHRpbWVsaW5lIG9mIHRoZSAKICAgICAgICAvLyBjb25kaXRpb25hbCBmdW5jdGlvbiByZXR1cm5lZCB0cnVlIGFuZCBpdCBjYW4gc3RhcnQKICAgICAgICBwcm9ncmVzcy5jdXJyZW50X2xvY2F0aW9uID0gMDsKICAgICAgICAvLyBjYWxsIGFkdmFuY2UgYWdhaW4gb24gdGhpcyBub2RlIG5vdyB0aGF0IGl0IGlzIHBvaW50aW5nIHRvIGEgbmV3IGxvY2F0aW9uCiAgICAgICAgcmV0dXJuIHRoaXMuYWR2YW5jZSgpOwogICAgICB9CgogICAgICAvLyBpZiB0aGlzIG5vZGUgaGFzIGEgdGltZWxpbmUsIHByb3BvZ2F0ZSBkb3duIHRvIHRoZSBjdXJyZW50IHRyaWFsLgogICAgICBpZiAodHlwZW9mIHRpbWVsaW5lX3BhcmFtZXRlcnMgIT09ICd1bmRlZmluZWQnKSB7CgogICAgICAgIHZhciBoYXZlX25vZGVfdG9fcnVuID0gZmFsc2U7CiAgICAgICAgLy8ga2VlcCBpbmNyZW1lbnRpbmcgdGhlIGxvY2F0aW9uIGluIHRoZSB0aW1lbGluZSB1bnRpbCBvbmUgb2YgdGhlIG5vZGVzIHJlYWNoZWQgaXMgaW5jb21wbGV0ZQogICAgICAgIHdoaWxlIChwcm9ncmVzcy5jdXJyZW50X2xvY2F0aW9uIDwgdGltZWxpbmVfcGFyYW1ldGVycy50aW1lbGluZS5sZW5ndGggJiYgaGF2ZV9ub2RlX3RvX3J1biA9PSBmYWxzZSkgewoKICAgICAgICAgIC8vIGNoZWNrIHRvIHNlZSBpZiB0aGUgbm9kZSBjdXJyZW50bHkgcG9pbnRlZCBhdCBpcyBkb25lCiAgICAgICAgICB2YXIgdGFyZ2V0X2NvbXBsZXRlID0gdGltZWxpbmVfcGFyYW1ldGVycy50aW1lbGluZVtwcm9ncmVzcy5jdXJyZW50X2xvY2F0aW9uXS5hZHZhbmNlKCk7CiAgICAgICAgICBpZiAoIXRhcmdldF9jb21wbGV0ZSkgewogICAgICAgICAgICBoYXZlX25vZGVfdG9fcnVuID0gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHJvZ3Jlc3MuY3VycmVudF9sb2NhdGlvbisrOwogICAgICAgICAgfQoKICAgICAgICB9CgogICAgICAgIC8vIGlmIHdlJ3ZlIHJlYWNoZWQgdGhlIGVuZCBvZiB0aGUgdGltZWxpbmUgKHdoaWNoLCBpZiB0aGUgY29kZSBpcyBoZXJlLCB3ZSBoYXZlKQoKICAgICAgICAvLyB0aGVyZSBhcmUgYSBmZXcgc3RlcHMgdG8gc2VlIHdoYXQgdG8gZG8gbmV4dC4uLgoKICAgICAgICAvLyBmaXJzdCwgY2hlY2sgdGhlIHRpbWVsaW5lX3ZhcmlhYmxlcyB0byBzZWUgaWYgd2UgbmVlZCB0byBsb29wIHRocm91Z2ggYWdhaW4KICAgICAgICAvLyB3aXRoIGEgbmV3IHNldCBvZiB2YXJpYWJsZXMKICAgICAgICBpZiAocHJvZ3Jlc3MuY3VycmVudF92YXJpYWJsZV9zZXQgPCBwcm9ncmVzcy5vcmRlci5sZW5ndGggLSAxKSB7CiAgICAgICAgICAvLyByZXNldCB0aGUgcHJvZ3Jlc3Mgb2YgdGhlIG5vZGUgdG8gYmUgd2l0aCB0aGUgbmV3IHNldAogICAgICAgICAgdGhpcy5uZXh0U2V0KCk7CiAgICAgICAgICAvLyB0aGVuIHRyeSB0byBhZHZhbmNlIHRoaXMgbm9kZSBhZ2Fpbi4KICAgICAgICAgIHJldHVybiB0aGlzLmFkdmFuY2UoKTsKICAgICAgICB9CgogICAgICAgIC8vIGlmIHdlJ3JlIGFsbCBkb25lIHdpdGggdGhlIHRpbWVsaW5lX3ZhcmlhYmxlcywgdGhlbiBjaGVjayB0byBzZWUgaWYgdGhlcmUgYXJlIG1vcmUgcmVwZXRpdGlvbnMKICAgICAgICBlbHNlIGlmIChwcm9ncmVzcy5jdXJyZW50X3JlcGV0aXRpb24gPCB0aW1lbGluZV9wYXJhbWV0ZXJzLnJlcGV0aXRpb25zIC0gMSkgewogICAgICAgICAgdGhpcy5uZXh0UmVwZXRpdG9uKCk7CiAgICAgICAgICAvLyBjaGVjayB0byBzZWUgaWYgdGhlcmUgaXMgYW4gb25fdGltZWxpbmVfZmluaXNoIGZ1bmN0aW9uCiAgICAgICAgICBpZiAodHlwZW9mIHRpbWVsaW5lX3BhcmFtZXRlcnMub25fdGltZWxpbmVfZmluaXNoICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICB0aW1lbGluZV9wYXJhbWV0ZXJzLm9uX3RpbWVsaW5lX2ZpbmlzaCgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXMuYWR2YW5jZSgpOwogICAgICAgIH0KCgogICAgICAgIC8vIGlmIHdlJ3JlIGFsbCBkb25lIHdpdGggdGhlIHJlcGV0aXRpb25zLi4uCiAgICAgICAgZWxzZSB7CiAgICAgICAgICAvLyBjaGVjayB0byBzZWUgaWYgdGhlcmUgaXMgYW4gb25fdGltZWxpbmVfZmluaXNoIGZ1bmN0aW9uCiAgICAgICAgICBpZiAodHlwZW9mIHRpbWVsaW5lX3BhcmFtZXRlcnMub25fdGltZWxpbmVfZmluaXNoICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICB0aW1lbGluZV9wYXJhbWV0ZXJzLm9uX3RpbWVsaW5lX2ZpbmlzaCgpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIGlmIHdlJ3JlIGFsbCBkb25lIHdpdGggdGhlIHJlcGV0aXRpb25zLCBjaGVjayBpZiB0aGVyZSBpcyBhIGxvb3AgZnVuY3Rpb24uCiAgICAgICAgICBpZiAodHlwZW9mIHRpbWVsaW5lX3BhcmFtZXRlcnMubG9vcF9mdW5jdGlvbiAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAganNQc3ljaC5pbnRlcm5hbC5jYWxsX2ltbWVkaWF0ZSA9IHRydWU7CiAgICAgICAgICAgIGlmICh0aW1lbGluZV9wYXJhbWV0ZXJzLmxvb3BfZnVuY3Rpb24odGhpcy5nZW5lcmF0ZWREYXRhKCkpKSB7CiAgICAgICAgICAgICAgdGhpcy5yZXNldCgpOwogICAgICAgICAgICAgIGpzUHN5Y2guaW50ZXJuYWwuY2FsbF9pbW1lZGlhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICByZXR1cm4gcGFyZW50X25vZGUuYWR2YW5jZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHByb2dyZXNzLmRvbmUgPSB0cnVlOwogICAgICAgICAgICAgIGpzUHN5Y2guaW50ZXJuYWwuY2FsbF9pbW1lZGlhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKCiAgICAgICAgfQoKICAgICAgICAvLyBubyBtb3JlIGxvb3BzIG9uIHRoaXMgdGltZWxpbmUsIHdlJ3JlIGRvbmUhCiAgICAgICAgcHJvZ3Jlc3MuZG9uZSA9IHRydWU7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0KCiAgICAvLyBjaGVjayB0aGUgc3RhdHVzIG9mIHRoZSBkb25lIGZsYWcKICAgIHRoaXMuaXNDb21wbGV0ZSA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gcHJvZ3Jlc3MuZG9uZTsKICAgIH0KCiAgICAvLyBnZXR0ZXIgbWV0aG9kIGZvciB0aW1lbGluZSB2YXJpYWJsZXMKICAgIHRoaXMuZ2V0VGltZWxpbmVWYXJpYWJsZVZhbHVlID0gZnVuY3Rpb24odmFyaWFibGVfbmFtZSl7CiAgICAgIGlmKHR5cGVvZiB0aW1lbGluZV9wYXJhbWV0ZXJzID09ICd1bmRlZmluZWQnKXsKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICB9CiAgICAgIHZhciB2ID0gdGltZWxpbmVfcGFyYW1ldGVycy50aW1lbGluZV92YXJpYWJsZXNbcHJvZ3Jlc3Mub3JkZXJbcHJvZ3Jlc3MuY3VycmVudF92YXJpYWJsZV9zZXRdXVt2YXJpYWJsZV9uYW1lXTsKICAgICAgcmV0dXJuIHY7CiAgICB9CgogICAgLy8gcmVjdXJzaXZlIHVwd2FyZCBzZWFyY2ggZm9yIHRpbWVsaW5lIHZhcmlhYmxlcwogICAgdGhpcy5maW5kVGltZWxpbmVWYXJpYWJsZSA9IGZ1bmN0aW9uKHZhcmlhYmxlX25hbWUpewogICAgICB2YXIgdiA9IHRoaXMuZ2V0VGltZWxpbmVWYXJpYWJsZVZhbHVlKHZhcmlhYmxlX25hbWUpOwogICAgICBpZih0eXBlb2YgdiA9PSAndW5kZWZpbmVkJyl7CiAgICAgICAgaWYodHlwZW9mIHBhcmVudF9ub2RlICE9PSAndW5kZWZpbmVkJyl7CiAgICAgICAgICByZXR1cm4gcGFyZW50X25vZGUuZmluZFRpbWVsaW5lVmFyaWFibGUodmFyaWFibGVfbmFtZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB2OwogICAgICB9CiAgICB9CgogICAgLy8gcmVjdXJzaXZlIGRvd253YXJkIHNlYXJjaCBmb3IgYWN0aXZlIHRyaWFsIHRvIGV4dHJhY3QgdGltZWxpbmUgdmFyaWFibGUKICAgIHRoaXMudGltZWxpbmVWYXJpYWJsZSA9IGZ1bmN0aW9uKHZhcmlhYmxlX25hbWUpewogICAgICBpZih0eXBlb2YgdGltZWxpbmVfcGFyYW1ldGVycyA9PSAndW5kZWZpbmVkJyl7CiAgICAgICAgcmV0dXJuIHRoaXMuZmluZFRpbWVsaW5lVmFyaWFibGUodmFyaWFibGVfbmFtZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gaWYgcHJvZ3Jlc3MuY3VycmVudF9sb2NhdGlvbiBpcyAtMSwgdGhlbiB0aGUgdGltZWxpbmUgdmFyaWFibGUgaXMgYmVpbmcgZXZhbHVhdGVkCiAgICAgICAgLy8gaW4gYSBmdW5jdGlvbiB0aGF0IHJ1bnMgcHJpb3IgdG8gdGhlIHRyaWFsIHN0YXJ0aW5nLCBzbyB3ZSBzaG91bGQgdHJlYXQgdGhhdCB0cmlhbAogICAgICAgIC8vIGFzIGJlaW5nIHRoZSBhY3RpdmUgdHJpYWwgZm9yIHB1cnBvc2VzIG9mIGZpbmRpbmcgdGhlIHZhbHVlIG9mIHRoZSB0aW1lbGluZSB2YXJpYWJsZQogICAgICAgIHZhciBsb2MgPSBNYXRoLm1heCgwLCBwcm9ncmVzcy5jdXJyZW50X2xvY2F0aW9uKTsKICAgICAgICAvLyBpZiBsb2MgaXMgZ3JlYXRlciB0aGFuIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgb24gdGhpcyB0aW1lbGluZSwgdGhlbiB0aGUgdGltZWxpbmUKICAgICAgICAvLyB2YXJpYWJsZSBpcyBiZWluZyBldmFsdWF0ZWQgaW4gYSBmdW5jdGlvbiB0aGF0IHJ1bnMgYWZ0ZXIgdGhlIHRyaWFsIG9uIHRoZSB0aW1lbGluZQogICAgICAgIC8vIGFyZSBjb21wbGV0ZSBidXQgYmVmb3JlIGFkdmFuY2luZyB0byB0aGUgbmV4dCAobGlrZSBhIGxvb3BfZnVuY3Rpb24pLgogICAgICAgIC8vIHRyZWF0IHRoZSBsYXN0IGFjdGl2ZSB0cmlhbCBhcyB0aGUgYWN0aXZlIHRyaWFsIGZvciB0aGlzIHB1cnBvc2UuCiAgICAgICAgaWYobG9jID09IHRpbWVsaW5lX3BhcmFtZXRlcnMudGltZWxpbmUubGVuZ3RoKXsKICAgICAgICAgIGxvYyA9IGxvYyAtIDE7CiAgICAgICAgfQogICAgICAgIC8vIG5vdyBmaW5kIHRoZSB2YXJpYWJsZQogICAgICAgIHJldHVybiB0aW1lbGluZV9wYXJhbWV0ZXJzLnRpbWVsaW5lW2xvY10udGltZWxpbmVWYXJpYWJsZSh2YXJpYWJsZV9uYW1lKTsgCiAgICAgIH0KICAgIH0KCiAgICAvLyByZWN1cnNpdmVseSBnZXQgYWxsIHRoZSB0aW1lbGluZSB2YXJpYWJsZXMgZm9yIHRoaXMgdHJpYWwKICAgIHRoaXMuYWxsVGltZWxpbmVWYXJpYWJsZXMgPSBmdW5jdGlvbigpewogICAgICB2YXIgYWxsX3R2cyA9IHRoaXMuYWxsVGltZWxpbmVWYXJpYWJsZXNOYW1lcygpOwogICAgICB2YXIgYWxsX3R2c192YWxzID0ge307CiAgICAgIGZvcih2YXIgaT0wOyBpPGFsbF90dnMubGVuZ3RoOyBpKyspewogICAgICAgIGFsbF90dnNfdmFsc1thbGxfdHZzW2ldXSA9IHRoaXMudGltZWxpbmVWYXJpYWJsZShhbGxfdHZzW2ldKQogICAgICB9CiAgICAgIHJldHVybiBhbGxfdHZzX3ZhbHM7CiAgICB9CgogICAgLy8gaGVscGVyIHRvIGdldCBhbGwgdGhlIG5hbWVzIGF0IHRoaXMgc3RhZ2UuCiAgICB0aGlzLmFsbFRpbWVsaW5lVmFyaWFibGVzTmFtZXMgPSBmdW5jdGlvbihzb19mYXIpewogICAgICBpZih0eXBlb2Ygc29fZmFyID09ICd1bmRlZmluZWQnKXsKICAgICAgICBzb19mYXIgPSBbXTsKICAgICAgfQogICAgICBpZih0eXBlb2YgdGltZWxpbmVfcGFyYW1ldGVycyAhPT0gJ3VuZGVmaW5lZCcpewogICAgICAgIHNvX2ZhciA9IHNvX2Zhci5jb25jYXQoT2JqZWN0LmtleXModGltZWxpbmVfcGFyYW1ldGVycy50aW1lbGluZV92YXJpYWJsZXNbcHJvZ3Jlc3Mub3JkZXJbcHJvZ3Jlc3MuY3VycmVudF92YXJpYWJsZV9zZXRdXSkpOwogICAgICAgIC8vIGlmIHByb2dyZXNzLmN1cnJlbnRfbG9jYXRpb24gaXMgLTEsIHRoZW4gdGhlIHRpbWVsaW5lIHZhcmlhYmxlIGlzIGJlaW5nIGV2YWx1YXRlZAogICAgICAgIC8vIGluIGEgZnVuY3Rpb24gdGhhdCBydW5zIHByaW9yIHRvIHRoZSB0cmlhbCBzdGFydGluZywgc28gd2Ugc2hvdWxkIHRyZWF0IHRoYXQgdHJpYWwKICAgICAgICAvLyBhcyBiZWluZyB0aGUgYWN0aXZlIHRyaWFsIGZvciBwdXJwb3NlcyBvZiBmaW5kaW5nIHRoZSB2YWx1ZSBvZiB0aGUgdGltZWxpbmUgdmFyaWFibGUKICAgICAgICB2YXIgbG9jID0gTWF0aC5tYXgoMCwgcHJvZ3Jlc3MuY3VycmVudF9sb2NhdGlvbik7CiAgICAgICAgLy8gaWYgbG9jIGlzIGdyZWF0ZXIgdGhhbiB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIG9uIHRoaXMgdGltZWxpbmUsIHRoZW4gdGhlIHRpbWVsaW5lCiAgICAgICAgLy8gdmFyaWFibGUgaXMgYmVpbmcgZXZhbHVhdGVkIGluIGEgZnVuY3Rpb24gdGhhdCBydW5zIGFmdGVyIHRoZSB0cmlhbCBvbiB0aGUgdGltZWxpbmUKICAgICAgICAvLyBhcmUgY29tcGxldGUgYnV0IGJlZm9yZSBhZHZhbmNpbmcgdG8gdGhlIG5leHQgKGxpa2UgYSBsb29wX2Z1bmN0aW9uKS4KICAgICAgICAvLyB0cmVhdCB0aGUgbGFzdCBhY3RpdmUgdHJpYWwgYXMgdGhlIGFjdGl2ZSB0cmlhbCBmb3IgdGhpcyBwdXJwb3NlLgogICAgICAgIGlmKGxvYyA9PSB0aW1lbGluZV9wYXJhbWV0ZXJzLnRpbWVsaW5lLmxlbmd0aCl7CiAgICAgICAgICBsb2MgPSBsb2MgLSAxOwogICAgICAgIH0KICAgICAgICAvLyBub3cgZmluZCB0aGUgdmFyaWFibGUKICAgICAgICByZXR1cm4gdGltZWxpbmVfcGFyYW1ldGVycy50aW1lbGluZVtsb2NdLmFsbFRpbWVsaW5lVmFyaWFibGVzTmFtZXMoc29fZmFyKTsKICAgICAgfQogICAgICBpZih0eXBlb2YgdGltZWxpbmVfcGFyYW1ldGVycyA9PSAndW5kZWZpbmVkJyl7CiAgICAgICAgcmV0dXJuIHNvX2ZhcjsKICAgICAgfQogICAgfQoKICAgIC8vIHJlY3Vyc2l2ZWx5IGdldCB0aGUgbnVtYmVyIG9mICoqdHJpYWxzKiogY29udGFpbmVkIGluIHRoZSB0aW1lbGluZQogICAgLy8gYXNzdW1pbmcgdGhhdCB3aGlsZSBsb29wcyBleGVjdXRlIGV4YWN0bHkgb25jZSBhbmQgaWYgY29uZGl0aW9uYWxzCiAgICAvLyBhbHdheXMgcnVuCiAgICB0aGlzLmxlbmd0aCA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgbGVuZ3RoID0gMDsKICAgICAgaWYgKHR5cGVvZiB0aW1lbGluZV9wYXJhbWV0ZXJzICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGltZWxpbmVfcGFyYW1ldGVycy50aW1lbGluZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgbGVuZ3RoICs9IHRpbWVsaW5lX3BhcmFtZXRlcnMudGltZWxpbmVbaV0ubGVuZ3RoKCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiAxOwogICAgICB9CiAgICAgIHJldHVybiBsZW5ndGg7CiAgICB9CgogICAgLy8gcmV0dXJuIHRoZSBwZXJjZW50YWdlIG9mIHRyaWFscyBjb21wbGV0ZWQsIGdyb3VwZWQgYXQgdGhlIGZpcnN0IGNoaWxkIGxldmVsCiAgICAvLyBjb3VudHMgYSBzZXQgb2YgdHJpYWxzIGFzIGNvbXBsZXRlIHdoZW4gdGhlIGNoaWxkIG5vZGUgaXMgZG9uZQogICAgdGhpcy5wZXJjZW50Q29tcGxldGUgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHRvdGFsX3RyaWFscyA9IHRoaXMubGVuZ3RoKCk7CiAgICAgIHZhciBjb21wbGV0ZWRfdHJpYWxzID0gMDsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aW1lbGluZV9wYXJhbWV0ZXJzLnRpbWVsaW5lLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKHRpbWVsaW5lX3BhcmFtZXRlcnMudGltZWxpbmVbaV0uaXNDb21wbGV0ZSgpKSB7CiAgICAgICAgICBjb21wbGV0ZWRfdHJpYWxzICs9IHRpbWVsaW5lX3BhcmFtZXRlcnMudGltZWxpbmVbaV0ubGVuZ3RoKCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiAoY29tcGxldGVkX3RyaWFscyAvIHRvdGFsX3RyaWFscyAqIDEwMCkKICAgIH0KCiAgICAvLyByZXNldHMgdGhlIG5vZGUgYW5kIGFsbCBzdWJub2RlcyB0byBvcmlnaW5hbCBzdGF0ZQogICAgLy8gYnV0IGluY3JlbWVudHMgdGhlIGN1cnJlbnRfaXRlcmF0aW9uIGNvdW50ZXIKICAgIHRoaXMucmVzZXQgPSBmdW5jdGlvbigpIHsKICAgICAgcHJvZ3Jlc3MuY3VycmVudF9sb2NhdGlvbiA9IC0xOwogICAgICBwcm9ncmVzcy5jdXJyZW50X3JlcGV0aXRpb24gPSAwOwogICAgICBwcm9ncmVzcy5jdXJyZW50X3ZhcmlhYmxlX3NldCA9IDA7CiAgICAgIHByb2dyZXNzLmN1cnJlbnRfaXRlcmF0aW9uKys7CiAgICAgIHByb2dyZXNzLmRvbmUgPSBmYWxzZTsKICAgICAgdGhpcy5zZXRUaW1lbGluZVZhcmlhYmxlc09yZGVyKCk7CiAgICAgIGlmICh0eXBlb2YgdGltZWxpbmVfcGFyYW1ldGVycyAhPSAndW5kZWZpbmVkJykgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGltZWxpbmVfcGFyYW1ldGVycy50aW1lbGluZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgdGltZWxpbmVfcGFyYW1ldGVycy50aW1lbGluZVtpXS5yZXNldCgpOwogICAgICAgIH0KICAgICAgfQoKICAgIH0KCiAgICAvLyBtYXJrIHRoaXMgbm9kZSBhcyBmaW5pc2hlZAogICAgdGhpcy5lbmQgPSBmdW5jdGlvbigpIHsKICAgICAgcHJvZ3Jlc3MuZG9uZSA9IHRydWU7CiAgICB9CgogICAgLy8gcmVjdXJzaXZlbHkgZW5kIHdoYXRldmVyIHN1Yi1ub2RlIGlzIHJ1bm5pbmcgdGhlIGN1cnJlbnQgdHJpYWwKICAgIHRoaXMuZW5kQWN0aXZlTm9kZSA9IGZ1bmN0aW9uKCkgewogICAgICBpZiAodHlwZW9mIHRpbWVsaW5lX3BhcmFtZXRlcnMgPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICB0aGlzLmVuZCgpOwogICAgICAgIHBhcmVudF9ub2RlLmVuZCgpOwogICAgICB9IGVsc2UgewogICAgICAgIHRpbWVsaW5lX3BhcmFtZXRlcnMudGltZWxpbmVbcHJvZ3Jlc3MuY3VycmVudF9sb2NhdGlvbl0uZW5kQWN0aXZlTm9kZSgpOwogICAgICB9CiAgICB9CgogICAgLy8gZ2V0IGEgdW5pcXVlIElEIGFzc29jaWF0ZWQgd2l0aCB0aGlzIG5vZGUKICAgIC8vIHRoZSBJRCByZWZsZWN0cyB0aGUgY3VycmVudCBpdGVyYXRpb24gdGhyb3VnaCB0aGlzIG5vZGUuCiAgICB0aGlzLklEID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBpZCA9ICIiOwogICAgICBpZiAodHlwZW9mIHBhcmVudF9ub2RlID09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgcmV0dXJuICIwLiIgKyBwcm9ncmVzcy5jdXJyZW50X2l0ZXJhdGlvbjsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZCArPSBwYXJlbnRfbm9kZS5JRCgpICsgIi0iOwogICAgICAgIGlkICs9IHJlbGF0aXZlX2lkICsgIi4iICsgcHJvZ3Jlc3MuY3VycmVudF9pdGVyYXRpb247CiAgICAgICAgcmV0dXJuIGlkOwogICAgICB9CiAgICB9CgogICAgLy8gZ2V0IHRoZSBJRCBvZiB0aGUgYWN0aXZlIHRyaWFsCiAgICB0aGlzLmFjdGl2ZUlEID0gZnVuY3Rpb24oKSB7CiAgICAgIGlmICh0eXBlb2YgdGltZWxpbmVfcGFyYW1ldGVycyA9PSAndW5kZWZpbmVkJykgewogICAgICAgIHJldHVybiB0aGlzLklEKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRpbWVsaW5lX3BhcmFtZXRlcnMudGltZWxpbmVbcHJvZ3Jlc3MuY3VycmVudF9sb2NhdGlvbl0uYWN0aXZlSUQoKTsKICAgICAgfQogICAgfQoKICAgIC8vIGdldCBhbGwgdGhlIGRhdGEgZ2VuZXJhdGVkIHdpdGhpbiB0aGlzIG5vZGUKICAgIHRoaXMuZ2VuZXJhdGVkRGF0YSA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4ganNQc3ljaC5kYXRhLmdldERhdGFCeVRpbWVsaW5lTm9kZSh0aGlzLklEKCkpOwogICAgfQoKICAgIC8vIGdldCBhbGwgdGhlIHRyaWFscyBvZiBhIHBhcnRpY3VsYXIgdHlwZQogICAgdGhpcy50cmlhbHNPZlR5cGUgPSBmdW5jdGlvbih0eXBlKSB7CiAgICAgIGlmICh0eXBlb2YgdGltZWxpbmVfcGFyYW1ldGVycyA9PSAndW5kZWZpbmVkJyl7CiAgICAgICAgaWYgKHRyaWFsX3BhcmFtZXRlcnMudHlwZSA9PSB0eXBlKSB7CiAgICAgICAgICByZXR1cm4gdHJpYWxfcGFyYW1ldGVyczsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgdHJpYWxzID0gW107CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aW1lbGluZV9wYXJhbWV0ZXJzLnRpbWVsaW5lLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgdCA9IHRpbWVsaW5lX3BhcmFtZXRlcnMudGltZWxpbmVbaV0udHJpYWxzT2ZUeXBlKHR5cGUpOwogICAgICAgICAgdHJpYWxzID0gdHJpYWxzLmNvbmNhdCh0KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRyaWFsczsKICAgICAgfQogICAgfQoKICAgIC8vIGFkZCBuZXcgdHJpYWxzIHRvIGVuZCBvZiB0aGlzIHRpbWVsaW5lCiAgICB0aGlzLmluc2VydCA9IGZ1bmN0aW9uKHBhcmFtZXRlcnMpewogICAgICBpZih0eXBlb2YgdGltZWxpbmVfcGFyYW1ldGVycyA9PSAndW5kZWZpbmVkJyl7CiAgICAgICAgY29uc29sZS5lcnJvcignQ2Fubm90IGFkZCBuZXcgdHJpYWxzIHRvIGEgdHJpYWwtbGV2ZWwgbm9kZS4nKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aW1lbGluZV9wYXJhbWV0ZXJzLnRpbWVsaW5lLnB1c2goCiAgICAgICAgICBuZXcgVGltZWxpbmVOb2RlKE9iamVjdC5hc3NpZ24oe30sIG5vZGVfdHJpYWxfZGF0YSwgcGFyYW1ldGVycyksIHNlbGYsIHRpbWVsaW5lX3BhcmFtZXRlcnMudGltZWxpbmUubGVuZ3RoKQogICAgICAgICk7CiAgICAgIH0KICAgIH0KCiAgICAvLyBjb25zdHJ1Y3RvcgogICAgdmFyIF9jb25zdHJ1Y3QgPSBmdW5jdGlvbigpIHsKCiAgICAgIC8vIHN0b3JlIGEgbGluayB0byB0aGUgcGFyZW50IG9mIHRoaXMgbm9kZQogICAgICBwYXJlbnRfbm9kZSA9IHBhcmVudDsKCiAgICAgIC8vIGNyZWF0ZSB0aGUgSUQgZm9yIHRoaXMgbm9kZQogICAgICBpZiAodHlwZW9mIHBhcmVudCA9PSAndW5kZWZpbmVkJykgewogICAgICAgIHJlbGF0aXZlX2lkID0gMDsKICAgICAgfSBlbHNlIHsKICAgICAgICByZWxhdGl2ZV9pZCA9IHJlbGF0aXZlSUQ7CiAgICAgIH0KCiAgICAgIC8vIGNoZWNrIGlmIHRoZXJlIGlzIGEgdGltZWxpbmUgcGFyYW1ldGVyCiAgICAgIC8vIGlmIHRoZXJlIGlzLCB0aGVuIHRoaXMgbm9kZSBoYXMgaXRzIG93biB0aW1lbGluZQogICAgICBpZiAoKHR5cGVvZiBwYXJhbWV0ZXJzLnRpbWVsaW5lICE9PSAndW5kZWZpbmVkJykgfHwgKHR5cGVvZiBqc1BzeWNoLnBsdWdpbnNbdHJpYWxfdHlwZV0gPT0gJ2Z1bmN0aW9uJykpIHsKCiAgICAgICAgLy8gY3JlYXRlIHRpbWVsaW5lIHByb3BlcnRpZXMKICAgICAgICB0aW1lbGluZV9wYXJhbWV0ZXJzID0gewogICAgICAgICAgdGltZWxpbmU6IFtdLAogICAgICAgICAgbG9vcF9mdW5jdGlvbjogcGFyYW1ldGVycy5sb29wX2Z1bmN0aW9uLAogICAgICAgICAgY29uZGl0aW9uYWxfZnVuY3Rpb246IHBhcmFtZXRlcnMuY29uZGl0aW9uYWxfZnVuY3Rpb24sCiAgICAgICAgICBzYW1wbGU6IHBhcmFtZXRlcnMuc2FtcGxlLAogICAgICAgICAgcmFuZG9taXplX29yZGVyOiB0eXBlb2YgcGFyYW1ldGVycy5yYW5kb21pemVfb3JkZXIgPT0gJ3VuZGVmaW5lZCcgPyBmYWxzZSA6IHBhcmFtZXRlcnMucmFuZG9taXplX29yZGVyLAogICAgICAgICAgcmVwZXRpdGlvbnM6IHR5cGVvZiBwYXJhbWV0ZXJzLnJlcGV0aXRpb25zID09ICd1bmRlZmluZWQnID8gMSA6IHBhcmFtZXRlcnMucmVwZXRpdGlvbnMsCiAgICAgICAgICB0aW1lbGluZV92YXJpYWJsZXM6IHR5cGVvZiBwYXJhbWV0ZXJzLnRpbWVsaW5lX3ZhcmlhYmxlcyA9PSAndW5kZWZpbmVkJyA/IFt7fV0gOiBwYXJhbWV0ZXJzLnRpbWVsaW5lX3ZhcmlhYmxlcywKICAgICAgICAgIG9uX3RpbWVsaW5lX2ZpbmlzaDogcGFyYW1ldGVycy5vbl90aW1lbGluZV9maW5pc2gsCiAgICAgICAgICBvbl90aW1lbGluZV9zdGFydDogcGFyYW1ldGVycy5vbl90aW1lbGluZV9zdGFydCwKICAgICAgICB9OwoKICAgICAgICBzZWxmLnNldFRpbWVsaW5lVmFyaWFibGVzT3JkZXIoKTsKCiAgICAgICAgLy8gZXh0cmFjdCBhbGwgb2YgdGhlIG5vZGUgbGV2ZWwgZGF0YSBhbmQgcGFyYW1ldGVycwogICAgICAgIC8vIGJ1dCByZW1vdmUgYWxsIG9mIHRoZSB0aW1lbGluZS1sZXZlbCBzcGVjaWZpYyBpbmZvcm1hdGlvbgogICAgICAgIC8vIHNpbmNlIHRoaXMgd2lsbCBiZSB1c2VkIHRvIGNvcHkgdGhpbmdzIGRvd24gaGllcmFyY2hpY2FsbHkKICAgICAgICB2YXIgbm9kZV9kYXRhID0gT2JqZWN0LmFzc2lnbih7fSwgcGFyYW1ldGVycyk7CiAgICAgICAgZGVsZXRlIG5vZGVfZGF0YS50aW1lbGluZTsKICAgICAgICBkZWxldGUgbm9kZV9kYXRhLmNvbmRpdGlvbmFsX2Z1bmN0aW9uOwogICAgICAgIGRlbGV0ZSBub2RlX2RhdGEubG9vcF9mdW5jdGlvbjsKICAgICAgICBkZWxldGUgbm9kZV9kYXRhLnJhbmRvbWl6ZV9vcmRlcjsKICAgICAgICBkZWxldGUgbm9kZV9kYXRhLnJlcGV0aXRpb25zOwogICAgICAgIGRlbGV0ZSBub2RlX2RhdGEudGltZWxpbmVfdmFyaWFibGVzOwogICAgICAgIGRlbGV0ZSBub2RlX2RhdGEuc2FtcGxlOwogICAgICAgIGRlbGV0ZSBub2RlX2RhdGEub25fdGltZWxpbmVfc3RhcnQ7CiAgICAgICAgZGVsZXRlIG5vZGVfZGF0YS5vbl90aW1lbGluZV9maW5pc2g7CiAgICAgICAgbm9kZV90cmlhbF9kYXRhID0gbm9kZV9kYXRhOyAvLyBzdG9yZSBmb3IgbGF0ZXIuLi4KCiAgICAgICAgLy8gY3JlYXRlIGEgVGltZWxpbmVOb2RlIGZvciBlYWNoIGVsZW1lbnQgaW4gdGhlIHRpbWVsaW5lCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJhbWV0ZXJzLnRpbWVsaW5lLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAvLyBtZXJnZSBwYXJhbWV0ZXJzCiAgICAgICAgICB2YXIgbWVyZ2VkX3BhcmFtZXRlcnMgPSBPYmplY3QuYXNzaWduKHt9LCBub2RlX2RhdGEsIHBhcmFtZXRlcnMudGltZWxpbmVbaV0pOwogICAgICAgICAgLy8gbWVyZ2UgYW55IGRhdGEgZnJvbSB0aGUgcGFyZW50IG5vZGUgaW50byBjaGlsZCBub2RlcwogICAgICAgICAgaWYodHlwZW9mIG5vZGVfZGF0YS5kYXRhID09ICdvYmplY3QnICYmIHR5cGVvZiBwYXJhbWV0ZXJzLnRpbWVsaW5lW2ldLmRhdGEgPT0gJ29iamVjdCcpewogICAgICAgICAgICB2YXIgbWVyZ2VkX2RhdGEgPSBPYmplY3QuYXNzaWduKHt9LCBub2RlX2RhdGEuZGF0YSwgcGFyYW1ldGVycy50aW1lbGluZVtpXS5kYXRhKTsKICAgICAgICAgICAgbWVyZ2VkX3BhcmFtZXRlcnMuZGF0YSA9IG1lcmdlZF9kYXRhOwogICAgICAgICAgfQogICAgICAgICAgdGltZWxpbmVfcGFyYW1ldGVycy50aW1lbGluZS5wdXNoKG5ldyBUaW1lbGluZU5vZGUobWVyZ2VkX3BhcmFtZXRlcnMsIHNlbGYsIGkpKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gaWYgdGhlcmUgaXMgbm8gdGltZWxpbmUgcGFyYW1ldGVyLCB0aGVuIHRoaXMgbm9kZSBpcyBhIHRyaWFsIG5vZGUKICAgICAgZWxzZSB7CiAgICAgICAgLy8gY2hlY2sgdG8gc2VlIGlmIGEgdmFsaWQgdHJpYWwgdHlwZSBpcyBkZWZpbmVkCiAgICAgICAgdmFyIHRyaWFsX3R5cGUgPSBwYXJhbWV0ZXJzLnR5cGU7CiAgICAgICAgaWYgKHR5cGVvZiB0cmlhbF90eXBlID09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKCdUcmlhbCBsZXZlbCBub2RlIGlzIG1pc3NpbmcgdGhlICJ0eXBlIiBwYXJhbWV0ZXIuIFRoZSBwYXJhbWV0ZXJzIGZvciB0aGUgbm9kZSBhcmU6ICcgKyBKU09OLnN0cmluZ2lmeShwYXJhbWV0ZXJzKSk7CiAgICAgICAgfSBlbHNlIGlmICgodHlwZW9mIGpzUHN5Y2gucGx1Z2luc1t0cmlhbF90eXBlXSA9PSAndW5kZWZpbmVkJykgJiYgKHRyaWFsX3R5cGUudG9TdHJpbmcoKS5yZXBsYWNlKC9ccy9nLCcnKSAhPSAiZnVuY3Rpb24oKXtyZXR1cm50aW1lbGluZS50aW1lbGluZVZhcmlhYmxlKHZhcm5hbWUpO30iKSkgewogICAgICAgICAgY29uc29sZS5lcnJvcignTm8gcGx1Z2luIGxvYWRlZCBmb3IgdHJpYWxzIG9mIHR5cGUgIicgKyB0cmlhbF90eXBlICsgJyInKTsKICAgICAgICB9CiAgICAgICAgLy8gY3JlYXRlIGEgZGVlcCBjb3B5IG9mIHRoZSBwYXJhbWV0ZXJzIGZvciB0aGUgdHJpYWwKICAgICAgICB0cmlhbF9wYXJhbWV0ZXJzID0gT2JqZWN0LmFzc2lnbih7fSwgcGFyYW1ldGVycyk7CiAgICAgIH0KCiAgICB9KCk7CiAgfQoKICBmdW5jdGlvbiBzdGFydEV4cGVyaW1lbnQoKSB7CgogICAgbG9hZGVkID0gdHJ1ZTsKCiAgICAvLyBzaG93IHByb2dyZXNzIGJhciBpZiByZXF1ZXN0ZWQKICAgIGlmIChvcHRzLnNob3dfcHJvZ3Jlc3NfYmFyID09PSB0cnVlKSB7CiAgICAgIGRyYXdQcm9ncmVzc0JhcihvcHRzLm1lc3NhZ2VfcHJvZ3Jlc3NfYmFyKTsKICAgIH0KCiAgICAvLyByZWNvcmQgdGhlIHN0YXJ0IHRpbWUKICAgIGV4cF9zdGFydF90aW1lID0gbmV3IERhdGUoKTsKCiAgICAvLyBiZWdpbiEKICAgIHRpbWVsaW5lLmFkdmFuY2UoKTsKICAgIGRvVHJpYWwodGltZWxpbmUudHJpYWwoKSk7CgogIH0KCiAgZnVuY3Rpb24gZmluaXNoRXhwZXJpbWVudCgpIHsKCiAgICBpZih0eXBlb2YgdGltZWxpbmUuZW5kX21lc3NhZ2UgIT09ICd1bmRlZmluZWQnKXsKICAgICAgRE9NX3RhcmdldC5pbm5lckhUTUwgPSB0aW1lbGluZS5lbmRfbWVzc2FnZTsKICAgIH0KCiAgICBvcHRzLm9uX2ZpbmlzaChqc1BzeWNoLmRhdGEuZ2V0KCkpOwoKICB9CgogIGZ1bmN0aW9uIG5leHRUcmlhbCgpIHsKICAgIC8vIGlmIGV4cGVyaW1lbnQgaXMgcGF1c2VkLCBkb24ndCBkbyBhbnl0aGluZy4KICAgIGlmKHBhdXNlZCkgewogICAgICB3YWl0aW5nID0gdHJ1ZTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGdsb2JhbF90cmlhbF9pbmRleCsrOwoKICAgIC8vIGFkdmFuY2UgdGltZWxpbmUKICAgIHRpbWVsaW5lLm1hcmtDdXJyZW50VHJpYWxDb21wbGV0ZSgpOwogICAgdmFyIGNvbXBsZXRlID0gdGltZWxpbmUuYWR2YW5jZSgpOwoKICAgIC8vIHVwZGF0ZSBwcm9ncmVzcyBiYXIgaWYgc2hvd24KICAgIGlmIChvcHRzLnNob3dfcHJvZ3Jlc3NfYmFyID09PSB0cnVlICYmIG9wdHMuYXV0b191cGRhdGVfcHJvZ3Jlc3NfYmFyID09IHRydWUpIHsKICAgICAgdXBkYXRlUHJvZ3Jlc3NCYXIoKTsKICAgIH0KCiAgICAvLyBjaGVjayBpZiBleHBlcmltZW50IGlzIG92ZXIKICAgIGlmIChjb21wbGV0ZSkgewogICAgICBmaW5pc2hFeHBlcmltZW50KCk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBkb1RyaWFsKHRpbWVsaW5lLnRyaWFsKCkpOwogIH0KCiAgZnVuY3Rpb24gZG9UcmlhbCh0cmlhbCkgewoKICAgIGN1cnJlbnRfdHJpYWwgPSB0cmlhbDsKICAgIGN1cnJlbnRfdHJpYWxfZmluaXNoZWQgPSBmYWxzZTsKCiAgICAvLyBwcm9jZXNzIGFsbCB0aW1lbGluZSB2YXJpYWJsZXMgZm9yIHRoaXMgdHJpYWwKICAgIGV2YWx1YXRlVGltZWxpbmVWYXJpYWJsZXModHJpYWwpOwoKICAgIC8vIGV2YWx1YXRlIHZhcmlhYmxlcyB0aGF0IGFyZSBmdW5jdGlvbnMKICAgIGV2YWx1YXRlRnVuY3Rpb25QYXJhbWV0ZXJzKHRyaWFsKTsKCiAgICAvLyBnZXQgZGVmYXVsdCB2YWx1ZXMgZm9yIHBhcmFtZXRlcnMKICAgIHNldERlZmF1bHRWYWx1ZXModHJpYWwpOwoKICAgIC8vIGFib3V0IHRvIGV4ZWN1dGUgY2FsbGJhY2tzCiAgICBqc1BzeWNoLmludGVybmFsLmNhbGxfaW1tZWRpYXRlID0gdHJ1ZTsKCiAgICAvLyBjYWxsIGV4cGVyaW1lbnQgd2lkZSBjYWxsYmFjawogICAgb3B0cy5vbl90cmlhbF9zdGFydCh0cmlhbCk7CgogICAgLy8gY2FsbCB0cmlhbCBzcGVjaWZpYyBjYWxsYmFjayBpZiBpdCBleGlzdHMKICAgIGlmKHR5cGVvZiB0cmlhbC5vbl9zdGFydCA9PSAnZnVuY3Rpb24nKXsKICAgICAgdHJpYWwub25fc3RhcnQodHJpYWwpOwogICAgfQoKICAgIC8vIGNhbGwgYW55IG9uX3N0YXJ0IGZ1bmN0aW9ucyBmb3IgZXh0ZW5zaW9ucwogICAgaWYoQXJyYXkuaXNBcnJheSh0cmlhbC5leHRlbnNpb25zKSl7CiAgICAgIGZvcih2YXIgaT0wOyBpPHRyaWFsLmV4dGVuc2lvbnMubGVuZ3RoOyBpKyspewogICAgICAgIGpzUHN5Y2guZXh0ZW5zaW9uc1t0cmlhbC5leHRlbnNpb25zW2ldLnR5cGVdLm9uX3N0YXJ0KGN1cnJlbnRfdHJpYWwuZXh0ZW5zaW9uc1tpXS5wYXJhbXMpOwogICAgICB9CiAgICB9CgogICAgLy8gYXBwbHkgdGhlIGZvY3VzIHRvIHRoZSBlbGVtZW50IGNvbnRhaW5pbmcgdGhlIGV4cGVyaW1lbnQuCiAgICBET01fY29udGFpbmVyLmZvY3VzKCk7CgogICAgLy8gcmVzZXQgdGhlIHNjcm9sbCBvbiB0aGUgRE9NIHRhcmdldAogICAgRE9NX3RhcmdldC5zY3JvbGxUb3AgPSAwOwoKICAgIC8vIGFkZCBDU1MgY2xhc3NlcyB0byB0aGUgRE9NX3RhcmdldCBpZiB0aGV5IGV4aXN0IGluIHRyaWFsLmNzc19jbGFzc2VzCiAgICBpZih0eXBlb2YgdHJpYWwuY3NzX2NsYXNzZXMgIT09ICd1bmRlZmluZWQnKXsKICAgICAgaWYoIUFycmF5LmlzQXJyYXkodHJpYWwuY3NzX2NsYXNzZXMpICYmIHR5cGVvZiB0cmlhbC5jc3NfY2xhc3NlcyA9PSAnc3RyaW5nJyl7CiAgICAgICAgdHJpYWwuY3NzX2NsYXNzZXMgPSBbdHJpYWwuY3NzX2NsYXNzZXNdOwogICAgICB9CiAgICAgIGlmKEFycmF5LmlzQXJyYXkodHJpYWwuY3NzX2NsYXNzZXMpKXsKICAgICAgICBET01fdGFyZ2V0LmNsYXNzTGlzdC5hZGQoLi4udHJpYWwuY3NzX2NsYXNzZXMpCiAgICAgIH0KICAgIH0KCiAgICAvLyBleGVjdXRlIHRyaWFsIG1ldGhvZAogICAganNQc3ljaC5wbHVnaW5zW3RyaWFsLnR5cGVdLnRyaWFsKERPTV90YXJnZXQsIHRyaWFsKTsKCiAgICAvLyBjYWxsIHRyaWFsIHNwZWNpZmljIGxvYWRlZCBjYWxsYmFjayBpZiBpdCBleGlzdHMKICAgIGlmKHR5cGVvZiB0cmlhbC5vbl9sb2FkID09ICdmdW5jdGlvbicpewogICAgICB0cmlhbC5vbl9sb2FkKCk7CiAgICB9CgogICAgLy8gY2FsbCBhbnkgb25fbG9hZCBmdW5jdGlvbnMgZm9yIGV4dGVuc2lvbnMKICAgIGlmKEFycmF5LmlzQXJyYXkodHJpYWwuZXh0ZW5zaW9ucykpewogICAgICBmb3IodmFyIGk9MDsgaTx0cmlhbC5leHRlbnNpb25zLmxlbmd0aDsgaSsrKXsKICAgICAgICBqc1BzeWNoLmV4dGVuc2lvbnNbdHJpYWwuZXh0ZW5zaW9uc1tpXS50eXBlXS5vbl9sb2FkKGN1cnJlbnRfdHJpYWwuZXh0ZW5zaW9uc1tpXS5wYXJhbXMpOwogICAgICB9CiAgICB9CiAgICAKICAgIC8vIGRvbmUgd2l0aCBjYWxsYmFja3MKICAgIGpzUHN5Y2guaW50ZXJuYWwuY2FsbF9pbW1lZGlhdGUgPSBmYWxzZTsKICB9CgogIGZ1bmN0aW9uIGV2YWx1YXRlVGltZWxpbmVWYXJpYWJsZXModHJpYWwpewogICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyh0cmlhbCk7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIC8vIHRpbWVsaW5lIHZhcmlhYmxlcyBvbiB0aGUgcm9vdCBsZXZlbAogICAgICBpZiAodHlwZW9mIHRyaWFsW2tleXNbaV1dID09ICJmdW5jdGlvbiIgJiYgdHJpYWxba2V5c1tpXV0udG9TdHJpbmcoKS5yZXBsYWNlKC9ccy9nLCcnKSA9PSAiZnVuY3Rpb24oKXtyZXR1cm50aW1lbGluZS50aW1lbGluZVZhcmlhYmxlKHZhcm5hbWUpO30iKSB7CiAgICAgICAgdHJpYWxba2V5c1tpXV0gPSB0cmlhbFtrZXlzW2ldXS5jYWxsKCk7CiAgICAgIH0KICAgICAgLy8gdGltZWxpbmUgdmFyaWFibGVzIHRoYXQgYXJlIG5lc3RlZCBpbiBvYmplY3RzCiAgICAgIGlmICh0eXBlb2YgdHJpYWxba2V5c1tpXV0gPT0gIm9iamVjdCIgJiYgdHJpYWxba2V5c1tpXV0gIT09IG51bGwpewogICAgICAgIGV2YWx1YXRlVGltZWxpbmVWYXJpYWJsZXModHJpYWxba2V5c1tpXV0pOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBldmFsdWF0ZUZ1bmN0aW9uUGFyYW1ldGVycyh0cmlhbCl7CgogICAgLy8gc2V0IGEgZmxhZyBzbyB0aGF0IGpzUHN5Y2gudGltZWxpbmVWYXJpYWJsZSgpIGlzIGltbWVkaWF0ZWx5IGV4ZWN1dGVkIGluIHRoaXMgY29udGV4dAogICAganNQc3ljaC5pbnRlcm5hbC5jYWxsX2ltbWVkaWF0ZSA9IHRydWU7CgogICAgLy8gZmlyc3QsIGV2YWwgdGhlIHRyaWFsIHR5cGUgaWYgaXQgaXMgYSBmdW5jdGlvbgogICAgLy8gdGhpcyBsZXRzIHVzZXJzIHNldCB0aGUgcGx1Z2luIHR5cGUgd2l0aCBhIGZ1bmN0aW9uCiAgICBpZih0eXBlb2YgdHJpYWwudHlwZSA9PT0gJ2Z1bmN0aW9uJyl7CiAgICAgIHRyaWFsLnR5cGUgPSB0cmlhbC50eXBlLmNhbGwoKTsKICAgIH0KCiAgICAvLyBub3cgZXZhbCB0aGUgd2hvbGUgdHJpYWwKCiAgICAvLyBzdGFydCBieSBnZXR0aW5nIGEgbGlzdCBvZiB0aGUgcGFyYW1ldGVycwogICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyh0cmlhbCk7CgogICAgLy8gaXRlcmF0ZSBvdmVyIGVhY2ggcGFyYW1ldGVyCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgLy8gY2hlY2sgdG8gbWFrZSBzdXJlIHBhcmFtZXRlciBpcyBub3QgInR5cGUiLCBzaW5jZSB0aGF0IHdhcyBldmFsJ2QgYWJvdmUuCiAgICAgIGlmKGtleXNbaV0gIT09ICd0eXBlJyl7CiAgICAgICAgLy8gdGhpcyBpZiBzdGF0ZW1lbnQgaXMgY2hlY2tpbmcgdG8gc2VlIGlmIHRoZSBwYXJhbWV0ZXIgdHlwZSBpcyBleHBlY3RlZCB0byBiZSBhIGZ1bmN0aW9uLCBpbiB3aGljaCBjYXNlIHdlIHNob3VsZCBOT1QgZXZhbHVhdGUgaXQuCiAgICAgICAgLy8gdGhlIGZpcnN0IGxpbmUgY2hlY2tzIGlmIHRoZSBwYXJhbWV0ZXIgaXMgZGVmaW5lZCBpbiB0aGUgdW5pdmVyc2FsUGx1Z2luUGFyYW1ldGVycyBzZXQKICAgICAgICAvLyB0aGUgc2Vjb25kIGxpbmUgY2hlY2tzIHRoZSBwbHVnaW4tc3BlY2lmaWMgcGFyYW1ldGVycwogICAgICAgIGlmKHR5cGVvZiBqc1BzeWNoLnBsdWdpbnMudW5pdmVyc2FsUGx1Z2luUGFyYW1ldGVyc1trZXlzW2ldXSAhPT0gJ3VuZGVmaW5lZCcgJiYgCiAgICAgICAgICBqc1BzeWNoLnBsdWdpbnMudW5pdmVyc2FsUGx1Z2luUGFyYW1ldGVyc1trZXlzW2ldXS50eXBlICE9PSBqc1BzeWNoLnBsdWdpbnMucGFyYW1ldGVyVHlwZS5GVU5DVElPTiApewogICAgICAgICAgdHJpYWxba2V5c1tpXV0gPSByZXBsYWNlRnVuY3Rpb25zV2l0aFZhbHVlcyh0cmlhbFtrZXlzW2ldXSwgbnVsbCk7CiAgICAgICAgfQogICAgICAgIGlmKHR5cGVvZiBqc1BzeWNoLnBsdWdpbnNbdHJpYWwudHlwZV0uaW5mby5wYXJhbWV0ZXJzW2tleXNbaV1dICE9PSAndW5kZWZpbmVkJyAmJiAKICAgICAgICAgIGpzUHN5Y2gucGx1Z2luc1t0cmlhbC50eXBlXS5pbmZvLnBhcmFtZXRlcnNba2V5c1tpXV0udHlwZSAhPT0ganNQc3ljaC5wbHVnaW5zLnBhcmFtZXRlclR5cGUuRlVOQ1RJT04pewogICAgICAgICAgdHJpYWxba2V5c1tpXV0gPSByZXBsYWNlRnVuY3Rpb25zV2l0aFZhbHVlcyh0cmlhbFtrZXlzW2ldXSwganNQc3ljaC5wbHVnaW5zW3RyaWFsLnR5cGVdLmluZm8ucGFyYW1ldGVyc1trZXlzW2ldXSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvLyByZXNldCBzbyBqc1BzeWNoLnRpbWVsaW5lVmFyaWFibGUoKSBpcyBubyBsb25nZXIgaW1tZWRpYXRlbHkgZXhlY3V0ZWQKICAgIGpzUHN5Y2guaW50ZXJuYWwuY2FsbF9pbW1lZGlhdGUgPSBmYWxzZTsKICB9CgogIGZ1bmN0aW9uIHJlcGxhY2VGdW5jdGlvbnNXaXRoVmFsdWVzKG9iaiwgaW5mbyl7CiAgICAvLyBudWxsIHR5cGVvZiBpcyAnb2JqZWN0JyAoPyE/ISksIHNvIG5lZWQgdG8gcnVuIHRoaXMgZmlyc3QhCiAgICBpZihvYmogPT09IG51bGwpewogICAgICByZXR1cm4gb2JqOwogICAgfQogICAgLy8gYXJyYXlzIAogICAgZWxzZSBpZihBcnJheS5pc0FycmF5KG9iaikpewogICAgICBmb3IodmFyIGk9MDsgaTxvYmoubGVuZ3RoOyBpKyspewogICAgICAgIG9ialtpXSA9IHJlcGxhY2VGdW5jdGlvbnNXaXRoVmFsdWVzKG9ialtpXSwgaW5mbyk7CiAgICAgIH0KICAgIH0KICAgIC8vIG9iamVjdHMKICAgIGVsc2UgaWYodHlwZW9mIG9iaiA9PT0gJ29iamVjdCcpewogICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKG9iaik7CiAgICAgIGlmKGluZm8gPT0gbnVsbCB8fCAhaW5mby5uZXN0ZWQpewogICAgICAgIGZvcih2YXIgaT0wOyBpPGtleXMubGVuZ3RoOyBpKyspewogICAgICAgICAgb2JqW2tleXNbaV1dID0gcmVwbGFjZUZ1bmN0aW9uc1dpdGhWYWx1ZXMob2JqW2tleXNbaV1dLCBudWxsKQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBmb3IodmFyIGk9MDsgaTxrZXlzLmxlbmd0aDsgaSsrKXsKICAgICAgICAgIGlmKHR5cGVvZiBpbmZvLm5lc3RlZFtrZXlzW2ldXSA9PSAnb2JqZWN0JyAmJiBpbmZvLm5lc3RlZFtrZXlzW2ldXS50eXBlICE9PSBqc1BzeWNoLnBsdWdpbnMucGFyYW1ldGVyVHlwZS5GVU5DVElPTil7CiAgICAgICAgICAgIG9ialtrZXlzW2ldXSA9IHJlcGxhY2VGdW5jdGlvbnNXaXRoVmFsdWVzKG9ialtrZXlzW2ldXSwgaW5mby5uZXN0ZWRba2V5c1tpXV0pCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBlbHNlIGlmKHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbicpewogICAgICByZXR1cm4gb2JqKCk7CiAgICB9CiAgICByZXR1cm4gb2JqOwogIH0KCiAgZnVuY3Rpb24gc2V0RGVmYXVsdFZhbHVlcyh0cmlhbCl7CiAgICBmb3IodmFyIHBhcmFtIGluIGpzUHN5Y2gucGx1Z2luc1t0cmlhbC50eXBlXS5pbmZvLnBhcmFtZXRlcnMpewogICAgICAvLyBjaGVjayBpZiBwYXJhbWV0ZXIgaXMgY29tcGxleCB3aXRoIG5lc3RlZCBkZWZhdWx0cwogICAgICBpZihqc1BzeWNoLnBsdWdpbnNbdHJpYWwudHlwZV0uaW5mby5wYXJhbWV0ZXJzW3BhcmFtXS50eXBlID09IGpzUHN5Y2gucGx1Z2lucy5wYXJhbWV0ZXJUeXBlLkNPTVBMRVgpewogICAgICAgIGlmKGpzUHN5Y2gucGx1Z2luc1t0cmlhbC50eXBlXS5pbmZvLnBhcmFtZXRlcnNbcGFyYW1dLmFycmF5ID09IHRydWUpewogICAgICAgICAgLy8gaXRlcmF0ZSBvdmVyIGVhY2ggZW50cnkgaW4gdGhlIGFycmF5CiAgICAgICAgICB0cmlhbFtwYXJhbV0uZm9yRWFjaChmdW5jdGlvbihpcCwgaSl7CiAgICAgICAgICAgIC8vIGNoZWNrIGVhY2ggcGFyYW1ldGVyIGluIHRoZSBwbHVnaW4gZGVzY3JpcHRpb24KICAgICAgICAgICAgZm9yKHZhciBwIGluIGpzUHN5Y2gucGx1Z2luc1t0cmlhbC50eXBlXS5pbmZvLnBhcmFtZXRlcnNbcGFyYW1dLm5lc3RlZCl7CiAgICAgICAgICAgICAgaWYodHlwZW9mIHRyaWFsW3BhcmFtXVtpXVtwXSA9PSAndW5kZWZpbmVkJyB8fCB0cmlhbFtwYXJhbV1baV1bcF0gPT09IG51bGwpewogICAgICAgICAgICAgICAgaWYodHlwZW9mIGpzUHN5Y2gucGx1Z2luc1t0cmlhbC50eXBlXS5pbmZvLnBhcmFtZXRlcnNbcGFyYW1dLm5lc3RlZFtwXS5kZWZhdWx0ID09ICd1bmRlZmluZWQnKXsKICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignWW91IG11c3Qgc3BlY2lmeSBhIHZhbHVlIGZvciB0aGUgJytwKycgcGFyYW1ldGVyIChuZXN0ZWQgaW4gdGhlICcrcGFyYW0rJyBwYXJhbWV0ZXIpIGluIHRoZSAnK3RyaWFsLnR5cGUrJyBwbHVnaW4uJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0cmlhbFtwYXJhbV1baV1bcF0gPSBqc1BzeWNoLnBsdWdpbnNbdHJpYWwudHlwZV0uaW5mby5wYXJhbWV0ZXJzW3BhcmFtXS5uZXN0ZWRbcF0uZGVmYXVsdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSAgICAgIAogICAgICAvLyBpZiBpdCdzIG5vdCBuZXN0ZWQsIGNoZWNraW5nIGlzIG11Y2ggZWFzaWVyIGFuZCBkbyB0aGF0IGhlcmU6CiAgICAgIGVsc2UgaWYodHlwZW9mIHRyaWFsW3BhcmFtXSA9PSAndW5kZWZpbmVkJyB8fCB0cmlhbFtwYXJhbV0gPT09IG51bGwpewogICAgICAgIGlmKHR5cGVvZiBqc1BzeWNoLnBsdWdpbnNbdHJpYWwudHlwZV0uaW5mby5wYXJhbWV0ZXJzW3BhcmFtXS5kZWZhdWx0ID09ICd1bmRlZmluZWQnKXsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1lvdSBtdXN0IHNwZWNpZnkgYSB2YWx1ZSBmb3IgdGhlICcrcGFyYW0rJyBwYXJhbWV0ZXIgaW4gdGhlICcrdHJpYWwudHlwZSsnIHBsdWdpbi4nKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdHJpYWxbcGFyYW1dID0ganNQc3ljaC5wbHVnaW5zW3RyaWFsLnR5cGVdLmluZm8ucGFyYW1ldGVyc1twYXJhbV0uZGVmYXVsdDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGNoZWNrRXhjbHVzaW9ucyhleGNsdXNpb25zLCBzdWNjZXNzLCBmYWlsKXsKICAgIHZhciBjbGVhciA9IHRydWU7CgogICAgLy8gTUlOSU1VTSBTSVpFCiAgICBpZih0eXBlb2YgZXhjbHVzaW9ucy5taW5fd2lkdGggIT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZiBleGNsdXNpb25zLm1pbl9oZWlnaHQgIT09ICd1bmRlZmluZWQnKXsKICAgICAgdmFyIG13ID0gdHlwZW9mIGV4Y2x1c2lvbnMubWluX3dpZHRoICE9PSAndW5kZWZpbmVkJyA/IGV4Y2x1c2lvbnMubWluX3dpZHRoIDogMDsKICAgICAgdmFyIG1oID0gdHlwZW9mIGV4Y2x1c2lvbnMubWluX2hlaWdodCAhPT0gJ3VuZGVmaW5lZCcgPyBleGNsdXNpb25zLm1pbl9oZWlnaHQgOiAwOwogICAgICB2YXIgdyA9IHdpbmRvdy5pbm5lcldpZHRoOwogICAgICB2YXIgaCA9IHdpbmRvdy5pbm5lckhlaWdodDsKICAgICAgaWYodyA8IG13IHx8IGggPCBtaCl7CiAgICAgICAgY2xlYXIgPSBmYWxzZTsKICAgICAgICB2YXIgaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChmdW5jdGlvbigpewogICAgICAgICAgdmFyIHcgPSB3aW5kb3cuaW5uZXJXaWR0aDsKICAgICAgICAgIHZhciBoID0gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgaWYodyA8IG13IHx8IGggPCBtaCl7CiAgICAgICAgICAgIHZhciBtc2cgPSAnPHA+WW91ciBicm93c2VyIHdpbmRvdyBpcyB0b28gc21hbGwgdG8gY29tcGxldGUgdGhpcyBleHBlcmltZW50LiAnKwogICAgICAgICAgICAgICdQbGVhc2UgbWF4aW1pemUgdGhlIHNpemUgb2YgeW91ciBicm93c2VyIHdpbmRvdy4gSWYgeW91ciBicm93c2VyIHdpbmRvdyBpcyBhbHJlYWR5IG1heGltaXplZCwgJysKICAgICAgICAgICAgICAneW91IHdpbGwgbm90IGJlIGFibGUgdG8gY29tcGxldGUgdGhpcyBleHBlcmltZW50LjwvcD4nKwogICAgICAgICAgICAgICc8cD5UaGUgbWluaW11bSB3aWR0aCBpcyAnK213KydweC4gWW91ciBjdXJyZW50IHdpZHRoIGlzICcrdysncHguPC9wPicrCiAgICAgICAgICAgICAgJzxwPlRoZSBtaW5pbXVtIGhlaWdodCBpcyAnK21oKydweC4gWW91ciBjdXJyZW50IGhlaWdodCBpcyAnK2grJ3B4LjwvcD4nOwogICAgICAgICAgICBjb3JlLmdldERpc3BsYXlFbGVtZW50KCkuaW5uZXJIVE1MID0gbXNnOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbCk7CiAgICAgICAgICAgIGNvcmUuZ2V0RGlzcGxheUVsZW1lbnQoKS5pbm5lckhUTUwgPSAnJzsKICAgICAgICAgICAgY2hlY2tFeGNsdXNpb25zKGV4Y2x1c2lvbnMsIHN1Y2Nlc3MsIGZhaWwpOwogICAgICAgICAgfQogICAgICAgIH0sIDEwMCk7CiAgICAgICAgcmV0dXJuOyAvLyBwcmV2ZW50cyBjaGVja2luZyBvdGhlciBleGNsdXNpb25zIHdoaWxlIHRoaXMgaXMgYmVpbmcgZml4ZWQKICAgICAgfQogICAgfQoKICAgIC8vIFdFQiBBVURJTyBBUEkKICAgIGlmKHR5cGVvZiBleGNsdXNpb25zLmF1ZGlvICE9PSAndW5kZWZpbmVkJyAmJiBleGNsdXNpb25zLmF1ZGlvKSB7CiAgICAgIGlmKHdpbmRvdy5oYXNPd25Qcm9wZXJ0eSgnQXVkaW9Db250ZXh0JykgfHwgd2luZG93Lmhhc093blByb3BlcnR5KCd3ZWJraXRBdWRpb0NvbnRleHQnKSl7CiAgICAgICAgLy8gY2xlYXIKICAgICAgfSBlbHNlIHsKICAgICAgICBjbGVhciA9IGZhbHNlOwogICAgICAgIHZhciBtc2cgPSAnPHA+WW91ciBicm93c2VyIGRvZXMgbm90IHN1cHBvcnQgdGhlIFdlYkF1ZGlvIEFQSSwgd2hpY2ggbWVhbnMgdGhhdCB5b3Ugd2lsbCBub3QgJysKICAgICAgICAgICdiZSBhYmxlIHRvIGNvbXBsZXRlIHRoZSBleHBlcmltZW50LjwvcD48cD5Ccm93c2VycyB0aGF0IHN1cHBvcnQgdGhlIFdlYkF1ZGlvIEFQSSBpbmNsdWRlICcrCiAgICAgICAgICAnQ2hyb21lLCBGaXJlZm94LCBTYWZhcmksIGFuZCBFZGdlLjwvcD4nOwogICAgICAgIGNvcmUuZ2V0RGlzcGxheUVsZW1lbnQoKS5pbm5lckhUTUwgPSBtc2c7CiAgICAgICAgZmFpbCgpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQoKICAgIC8vIEdPPwogICAgaWYoY2xlYXIpeyBzdWNjZXNzKCk7IH0KICB9CgogIGZ1bmN0aW9uIGRyYXdQcm9ncmVzc0Jhcihtc2cpIHsKICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5qc3BzeWNoLWRpc3BsYXktZWxlbWVudCcpLmluc2VydEFkamFjZW50SFRNTCgnYWZ0ZXJiZWdpbicsCiAgICAgICc8ZGl2IGlkPSJqc3BzeWNoLXByb2dyZXNzYmFyLWNvbnRhaW5lciI+JysKICAgICAgJzxzcGFuPicrCiAgICAgIG1zZysgCiAgICAgICc8L3NwYW4+JysKICAgICAgJzxkaXYgaWQ9ImpzcHN5Y2gtcHJvZ3Jlc3NiYXItb3V0ZXIiPicrCiAgICAgICAgJzxkaXYgaWQ9ImpzcHN5Y2gtcHJvZ3Jlc3NiYXItaW5uZXIiPjwvZGl2PicrCiAgICAgICc8L2Rpdj48L2Rpdj4nKTsKICB9CgogIGZ1bmN0aW9uIHVwZGF0ZVByb2dyZXNzQmFyKCkgewogICAgdmFyIHByb2dyZXNzID0ganNQc3ljaC5wcm9ncmVzcygpLnBlcmNlbnRfY29tcGxldGU7CiAgICBjb3JlLnNldFByb2dyZXNzQmFyKHByb2dyZXNzIC8gMTAwKTsKICB9CgogIHZhciBwcm9ncmVzc19iYXJfYW1vdW50ID0gMDsKCiAgY29yZS5zZXRQcm9ncmVzc0JhciA9IGZ1bmN0aW9uKHByb3BvcnRpb25fY29tcGxldGUpewogICAgcHJvcG9ydGlvbl9jb21wbGV0ZSA9IE1hdGgubWF4KE1hdGgubWluKDEscHJvcG9ydGlvbl9jb21wbGV0ZSksMCk7CiAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjanNwc3ljaC1wcm9ncmVzc2Jhci1pbm5lcicpLnN0eWxlLndpZHRoID0gKHByb3BvcnRpb25fY29tcGxldGUqMTAwKSArICIlIjsKICAgIHByb2dyZXNzX2Jhcl9hbW91bnQgPSBwcm9wb3J0aW9uX2NvbXBsZXRlOwogIH0KCiAgY29yZS5nZXRQcm9ncmVzc0JhckNvbXBsZXRlZCA9IGZ1bmN0aW9uKCl7CiAgICByZXR1cm4gcHJvZ3Jlc3NfYmFyX2Ftb3VudDsKICB9CgogIC8vTGVhdmUgYSB0cmFjZSBpbiB0aGUgRE9NIHRoYXQganNwc3ljaCB3YXMgbG9hZGVkCiAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNldEF0dHJpYnV0ZSgnanNwc3ljaCcsICdwcmVzZW50Jyk7CgogIHJldHVybiBjb3JlOwp9KSgpOwoKanNQc3ljaC5pbnRlcm5hbCA9IChmdW5jdGlvbigpIHsKICB2YXIgbW9kdWxlID0ge307CgogIC8vIHRoaXMgZmxhZyBpcyB1c2VkIHRvIGRldGVybWluZSB3aGV0aGVyIHdlIGFyZSBpbiBhIHNjb3BlIHdoZXJlCiAgLy8ganNQc3ljaC50aW1lbGluZVZhcmlhYmxlKCkgc2hvdWxkIGJlIGV4ZWN1dGVkIGltbWVkaWF0ZWx5IG9yCiAgLy8gd2hldGhlciBpdCBzaG91bGQgcmV0dXJuIGEgZnVuY3Rpb24gdG8gYWNjZXNzIHRoZSB2YXJpYWJsZSBsYXRlci4KICBtb2R1bGUuY2FsbF9pbW1lZGlhdGUgPSBmYWxzZTsKCiAgcmV0dXJuIG1vZHVsZTsKfSkoKTsKCmpzUHN5Y2gucGx1Z2lucyA9IChmdW5jdGlvbigpIHsKCiAgdmFyIG1vZHVsZSA9IHt9OwoKICAvLyBlbnVtZXJhdGUgcG9zc2libGUgcGFyYW1ldGVyIHR5cGVzIGZvciBwbHVnaW5zCiAgbW9kdWxlLnBhcmFtZXRlclR5cGUgPSB7CiAgICBCT09MOiAwLAogICAgU1RSSU5HOiAxLAogICAgSU5UOiAyLAogICAgRkxPQVQ6IDMsCiAgICBGVU5DVElPTjogNCwKICAgIEtFWTogNSwKICAgIFNFTEVDVDogNiwKICAgIEhUTUxfU1RSSU5HOiA3LAogICAgSU1BR0U6IDgsCiAgICBBVURJTzogOSwKICAgIFZJREVPOiAxMCwKICAgIE9CSkVDVDogMTEsCiAgICBDT01QTEVYOiAxMiwKICAgIFRJTUVMSU5FOiAxMwogIH0KCiAgbW9kdWxlLnVuaXZlcnNhbFBsdWdpblBhcmFtZXRlcnMgPSB7CiAgICBkYXRhOiB7CiAgICAgIHR5cGU6IG1vZHVsZS5wYXJhbWV0ZXJUeXBlLk9CSkVDVCwKICAgICAgcHJldHR5X25hbWU6ICdEYXRhJywKICAgICAgZGVmYXVsdDoge30sCiAgICAgIGRlc2NyaXB0aW9uOiAnRGF0YSB0byBhZGQgdG8gdGhpcyB0cmlhbCAoa2V5LXZhbHVlIHBhaXJzKScKICAgIH0sCiAgICBvbl9zdGFydDogewogICAgICB0eXBlOiBtb2R1bGUucGFyYW1ldGVyVHlwZS5GVU5DVElPTiwKICAgICAgcHJldHR5X25hbWU6ICdPbiBzdGFydCcsCiAgICAgIGRlZmF1bHQ6IGZ1bmN0aW9uKCkgeyByZXR1cm47IH0sCiAgICAgIGRlc2NyaXB0aW9uOiAnRnVuY3Rpb24gdG8gZXhlY3V0ZSB3aGVuIHRyaWFsIGJlZ2lucycKICAgIH0sCiAgICBvbl9maW5pc2g6IHsKICAgICAgdHlwZTogbW9kdWxlLnBhcmFtZXRlclR5cGUuRlVOQ1RJT04sCiAgICAgIHByZXR0eV9uYW1lOiAnT24gZmluaXNoJywKICAgICAgZGVmYXVsdDogZnVuY3Rpb24oKSB7IHJldHVybjsgfSwKICAgICAgZGVzY3JpcHRpb246ICdGdW5jdGlvbiB0byBleGVjdXRlIHdoZW4gdHJpYWwgaXMgZmluaXNoZWQnCiAgICB9LAogICAgb25fbG9hZDogewogICAgICB0eXBlOiBtb2R1bGUucGFyYW1ldGVyVHlwZS5GVU5DVElPTiwKICAgICAgcHJldHR5X25hbWU6ICdPbiBsb2FkJywKICAgICAgZGVmYXVsdDogZnVuY3Rpb24oKSB7IHJldHVybjsgfSwKICAgICAgZGVzY3JpcHRpb246ICdGdW5jdGlvbiB0byBleGVjdXRlIGFmdGVyIHRoZSB0cmlhbCBoYXMgbG9hZGVkJwogICAgfSwKICAgIHBvc3RfdHJpYWxfZ2FwOiB7CiAgICAgIHR5cGU6IG1vZHVsZS5wYXJhbWV0ZXJUeXBlLklOVCwKICAgICAgcHJldHR5X25hbWU6ICdQb3N0IHRyaWFsIGdhcCcsCiAgICAgIGRlZmF1bHQ6IG51bGwsCiAgICAgIGRlc2NyaXB0aW9uOiAnTGVuZ3RoIG9mIGdhcCBiZXR3ZWVuIHRoZSBlbmQgb2YgdGhpcyB0cmlhbCBhbmQgdGhlIHN0YXJ0IG9mIHRoZSBuZXh0IHRyaWFsJwogICAgfSwKICAgIGNzc19jbGFzc2VzOiB7CiAgICAgIHR5cGU6IG1vZHVsZS5wYXJhbWV0ZXJUeXBlLlNUUklORywKICAgICAgcHJldHR5X25hbWU6ICdDdXN0b20gQ1NTIGNsYXNzZXMnLAogICAgICBkZWZhdWx0OiBudWxsLAogICAgICBkZXNjcmlwdGlvbjogJ0EgbGlzdCBvZiBDU1MgY2xhc3NlcyB0byBhZGQgdG8gdGhlIGpzUHN5Y2ggZGlzcGxheSBlbGVtZW50IGZvciB0aGUgZHVyYXRpb24gb2YgdGhpcyB0cmlhbCcKICAgIH0KICB9CgogIHJldHVybiBtb2R1bGU7Cn0pKCk7Cgpqc1BzeWNoLmV4dGVuc2lvbnMgPSAoZnVuY3Rpb24oKXsKICByZXR1cm4ge307Cn0pKCk7Cgpqc1BzeWNoLmRhdGEgPSAoZnVuY3Rpb24oKSB7CgogIHZhciBtb2R1bGUgPSB7fTsKCiAgLy8gZGF0YSBzdG9yYWdlIG9iamVjdAogIHZhciBhbGxEYXRhID0gRGF0YUNvbGxlY3Rpb24oKTsKCiAgLy8gYnJvd3NlciBpbnRlcmFjdGlvbiBldmVudCBkYXRhCiAgdmFyIGludGVyYWN0aW9uRGF0YSA9IERhdGFDb2xsZWN0aW9uKCk7CgogIC8vIGRhdGEgcHJvcGVydGllcyBmb3IgYWxsIHRyaWFscwogIHZhciBkYXRhUHJvcGVydGllcyA9IHt9OwoKICAvLyBjYWNoZSB0aGUgcXVlcnlfc3RyaW5nCiAgdmFyIHF1ZXJ5X3N0cmluZzsKCiAgLy8gRGF0YUNvbGxlY3Rpb24KICBmdW5jdGlvbiBEYXRhQ29sbGVjdGlvbihkYXRhKXsKCiAgICB2YXIgZGF0YV9jb2xsZWN0aW9uID0ge307CgogICAgdmFyIHRyaWFscyA9IHR5cGVvZiBkYXRhID09PSAndW5kZWZpbmVkJyA/IFtdIDogZGF0YTsKCiAgICBkYXRhX2NvbGxlY3Rpb24ucHVzaCA9IGZ1bmN0aW9uKG5ld19kYXRhKXsKICAgICAgdHJpYWxzLnB1c2gobmV3X2RhdGEpOwogICAgICByZXR1cm4gZGF0YV9jb2xsZWN0aW9uOwogICAgfQoKICAgIGRhdGFfY29sbGVjdGlvbi5qb2luID0gZnVuY3Rpb24ob3RoZXJfZGF0YV9jb2xsZWN0aW9uKXsKICAgICAgdHJpYWxzID0gdHJpYWxzLmNvbmNhdChvdGhlcl9kYXRhX2NvbGxlY3Rpb24udmFsdWVzKCkpOwogICAgICByZXR1cm4gZGF0YV9jb2xsZWN0aW9uOwogICAgfQoKICAgIGRhdGFfY29sbGVjdGlvbi50b3AgPSBmdW5jdGlvbigpewogICAgICBpZih0cmlhbHMubGVuZ3RoIDw9IDEpewogICAgICAgIHJldHVybiBkYXRhX2NvbGxlY3Rpb247CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIERhdGFDb2xsZWN0aW9uKFt0cmlhbHNbdHJpYWxzLmxlbmd0aC0xXV0pOwogICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBRdWVyaWVzIHRoZSBmaXJzdCBuIGVsZW1lbnRzIGluIGEgY29sbGVjdGlvbiBvZiB0cmlhbHMuCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IG4gQSBwb3NpdGl2ZSBpbnRlZ2VyIG9mIGVsZW1lbnRzIHRvIHJldHVybi4gQSB2YWx1ZSBvZgogICAgICogICAgICAgICAgICAgICAgICAgbiB0aGF0IGlzIGxlc3MgdGhhbiAxIHdpbGwgdGhyb3cgYW4gZXJyb3IuCiAgICAgKgogICAgICogQHJldHVybiB7QXJyYXl9IEZpcnN0IG4gb2JqZWN0cyBvZiBhIGNvbGxlY3Rpb24gb2YgdHJpYWxzLiBJZiBmZXdlciB0aGFuCiAgICAgKiAgICAgICAgICAgICAgICAgbiB0cmlhbHMgYXJlIGF2YWlsYWJsZSwgdGhlIHRyaWFscy5sZW5ndGggZWxlbWVudHMgd2lsbAogICAgICogICAgICAgICAgICAgICAgIGJlIHJldHVybmVkLgogICAgICoKICAgICAqLwogICAgZGF0YV9jb2xsZWN0aW9uLmZpcnN0ID0gZnVuY3Rpb24obil7CiAgICAgIGlmICh0eXBlb2YgbiA9PSAndW5kZWZpbmVkJykgeyBuID0gMSB9CiAgICAgIGlmIChuIDwgMSkgewogICAgICAgIHRocm93IGBZb3UgbXVzdCBxdWVyeSB3aXRoIGEgcG9zaXRpdmUgbm9uemVybyBpbnRlZ2VyLiBQbGVhc2UgdXNlIGEgCiAgICAgICAgICAgICAgIGRpZmZlcmVudCB2YWx1ZSBmb3Igbi5gOwogICAgICB9CiAgICAgIGlmICh0cmlhbHMubGVuZ3RoID09IDApIHJldHVybiBEYXRhQ29sbGVjdGlvbihbXSk7CiAgICAgIGlmIChuID4gdHJpYWxzLmxlbmd0aCkgbiA9IHRyaWFscy5sZW5ndGg7CiAgICAgIHJldHVybiBEYXRhQ29sbGVjdGlvbih0cmlhbHMuc2xpY2UoMCwgbikpOwogICAgfQoKICAgIC8qKgogICAgICogUXVlcmllcyB0aGUgbGFzdCBuIGVsZW1lbnRzIGluIGEgY29sbGVjdGlvbiBvZiB0cmlhbHMuCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IG4gQSBwb3NpdGl2ZSBpbnRlZ2VyIG9mIGVsZW1lbnRzIHRvIHJldHVybi4gQSB2YWx1ZSBvZgogICAgICogICAgICAgICAgICAgICAgICAgbiB0aGF0IGlzIGxlc3MgdGhhbiAxIHdpbGwgdGhyb3cgYW4gZXJyb3IuCiAgICAgKgogICAgICogQHJldHVybiB7QXJyYXl9IExhc3QgbiBvYmplY3RzIG9mIGEgY29sbGVjdGlvbiBvZiB0cmlhbHMuIElmIGZld2VyIHRoYW4KICAgICAqICAgICAgICAgICAgICAgICBuIHRyaWFscyBhcmUgYXZhaWxhYmxlLCB0aGUgdHJpYWxzLmxlbmd0aCBlbGVtZW50cyB3aWxsCiAgICAgKiAgICAgICAgICAgICAgICAgYmUgcmV0dXJuZWQuCiAgICAgKgogICAgICovCiAgICBkYXRhX2NvbGxlY3Rpb24ubGFzdCA9IGZ1bmN0aW9uKG4pIHsKICAgICAgaWYgKHR5cGVvZiBuID09ICd1bmRlZmluZWQnKSB7IG4gPSAxIH0KICAgICAgaWYgKG4gPCAxKSB7CiAgICAgICAgdGhyb3cgYFlvdSBtdXN0IHF1ZXJ5IHdpdGggYSBwb3NpdGl2ZSBub256ZXJvIGludGVnZXIuIFBsZWFzZSB1c2UgYSAKICAgICAgICAgICAgICAgZGlmZmVyZW50IHZhbHVlIGZvciBuLmA7CiAgICAgIH0KICAgICAgaWYgKHRyaWFscy5sZW5ndGggPT0gMCkgcmV0dXJuIERhdGFDb2xsZWN0aW9uKFtdKTsKICAgICAgaWYgKG4gPiB0cmlhbHMubGVuZ3RoKSBuID0gdHJpYWxzLmxlbmd0aDsKICAgICAgcmV0dXJuIERhdGFDb2xsZWN0aW9uKHRyaWFscy5zbGljZSh0cmlhbHMubGVuZ3RoIC0gbiwgdHJpYWxzLmxlbmd0aCkpOwogICAgfQoKICAgIGRhdGFfY29sbGVjdGlvbi52YWx1ZXMgPSBmdW5jdGlvbigpewogICAgICByZXR1cm4gdHJpYWxzOwogICAgfQoKICAgIGRhdGFfY29sbGVjdGlvbi5jb3VudCA9IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiB0cmlhbHMubGVuZ3RoOwogICAgfQoKICAgIGRhdGFfY29sbGVjdGlvbi5yZWFkT25seSA9IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiBEYXRhQ29sbGVjdGlvbihqc1BzeWNoLnV0aWxzLmRlZXBDb3B5KHRyaWFscykpOwogICAgfQoKICAgIGRhdGFfY29sbGVjdGlvbi5hZGRUb0FsbCA9IGZ1bmN0aW9uKHByb3BlcnRpZXMpewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRyaWFscy5sZW5ndGg7IGkrKykgewogICAgICAgIGZvciAodmFyIGtleSBpbiBwcm9wZXJ0aWVzKSB7CiAgICAgICAgICB0cmlhbHNbaV1ba2V5XSA9IHByb3BlcnRpZXNba2V5XTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGRhdGFfY29sbGVjdGlvbjsKICAgIH0KCiAgICBkYXRhX2NvbGxlY3Rpb24uYWRkVG9MYXN0ID0gZnVuY3Rpb24ocHJvcGVydGllcyl7CiAgICAgIGlmKHRyaWFscy5sZW5ndGggIT0gMCl7CiAgICAgICAgZm9yICh2YXIga2V5IGluIHByb3BlcnRpZXMpIHsKICAgICAgICAgIHRyaWFsc1t0cmlhbHMubGVuZ3RoLTFdW2tleV0gPSBwcm9wZXJ0aWVzW2tleV07CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBkYXRhX2NvbGxlY3Rpb247CiAgICB9CgogICAgZGF0YV9jb2xsZWN0aW9uLmZpbHRlciA9IGZ1bmN0aW9uKGZpbHRlcnMpewogICAgICAvLyBbe3AxOiB2MSwgcDI6djJ9LCB7cDE6djJ9XQogICAgICAvLyB7cDE6IHYxfQogICAgICBpZighQXJyYXkuaXNBcnJheShmaWx0ZXJzKSl7CiAgICAgICAgdmFyIGYgPSBqc1BzeWNoLnV0aWxzLmRlZXBDb3B5KFtmaWx0ZXJzXSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGYgPSBqc1BzeWNoLnV0aWxzLmRlZXBDb3B5KGZpbHRlcnMpOwogICAgICB9CgogICAgICB2YXIgZmlsdGVyZWRfZGF0YSA9IFtdOwogICAgICBmb3IodmFyIHg9MDsgeCA8IHRyaWFscy5sZW5ndGg7IHgrKyl7CiAgICAgICAgdmFyIGtlZXAgPSBmYWxzZTsKICAgICAgICBmb3IodmFyIGk9MDsgaTxmLmxlbmd0aDsgaSsrKXsKICAgICAgICAgIHZhciBtYXRjaCA9IHRydWU7CiAgICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGZbaV0pOwogICAgICAgICAgZm9yKHZhciBrPTA7IGs8a2V5cy5sZW5ndGg7IGsrKyl7CiAgICAgICAgICAgIGlmKHR5cGVvZiB0cmlhbHNbeF1ba2V5c1trXV0gIT09ICd1bmRlZmluZWQnICYmIHRyaWFsc1t4XVtrZXlzW2tdXSA9PSBmW2ldW2tleXNba11dKXsKICAgICAgICAgICAgICAvLyBtYXRjaGVzIG9uIHRoaXMga2V5IQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG1hdGNoID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmKG1hdGNoKSB7IGtlZXAgPSB0cnVlOyBicmVhazsgfSAvLyBjYW4gYnJlYWsgYmVjYXVzZSBlYWNoIGZpbHRlciBpcyBPUi4KICAgICAgICB9CiAgICAgICAgaWYoa2VlcCl7CiAgICAgICAgICBmaWx0ZXJlZF9kYXRhLnB1c2godHJpYWxzW3hdKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciBvdXQgPSBEYXRhQ29sbGVjdGlvbihmaWx0ZXJlZF9kYXRhKTsKCiAgICAgIHJldHVybiBvdXQ7CiAgICB9CgogICAgZGF0YV9jb2xsZWN0aW9uLmZpbHRlckN1c3RvbSA9IGZ1bmN0aW9uKGZuKXsKICAgICAgdmFyIGluY2x1ZGVkID0gW107CiAgICAgIGZvcih2YXIgaT0wOyBpPHRyaWFscy5sZW5ndGg7IGkrKyl7CiAgICAgICAgaWYoZm4odHJpYWxzW2ldKSl7CiAgICAgICAgICBpbmNsdWRlZC5wdXNoKHRyaWFsc1tpXSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBEYXRhQ29sbGVjdGlvbihpbmNsdWRlZCk7CiAgICB9CgogICAgZGF0YV9jb2xsZWN0aW9uLnNlbGVjdCA9IGZ1bmN0aW9uKGNvbHVtbil7CiAgICAgIHZhciB2YWx1ZXMgPSBbXTsKICAgICAgZm9yKHZhciBpPTA7IGk8dHJpYWxzLmxlbmd0aDsgaSsrKXsKICAgICAgICBpZih0eXBlb2YgdHJpYWxzW2ldW2NvbHVtbl0gIT09ICd1bmRlZmluZWQnKXsKICAgICAgICAgIHZhbHVlcy5wdXNoKHRyaWFsc1tpXVtjb2x1bW5dKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdmFyIG91dCA9IERhdGFDb2x1bW4oKTsKICAgICAgb3V0LnZhbHVlcyA9IHZhbHVlczsKICAgICAgcmV0dXJuIG91dDsKICAgIH0KCiAgICBkYXRhX2NvbGxlY3Rpb24uaWdub3JlID0gZnVuY3Rpb24oY29sdW1ucyl7CiAgICAgIGlmKCFBcnJheS5pc0FycmF5KGNvbHVtbnMpKXsKICAgICAgICBjb2x1bW5zID0gW2NvbHVtbnNdOwogICAgICB9CiAgICAgIHZhciBvID0ganNQc3ljaC51dGlscy5kZWVwQ29weSh0cmlhbHMpOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG8ubGVuZ3RoOyBpKyspIHsKICAgICAgICBmb3IgKHZhciBqIGluIGNvbHVtbnMpIHsKICAgICAgICAgIGRlbGV0ZSBvW2ldW2NvbHVtbnNbal1dOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gRGF0YUNvbGxlY3Rpb24obyk7CiAgICB9CgogICAgZGF0YV9jb2xsZWN0aW9uLnVuaXF1ZU5hbWVzID0gZnVuY3Rpb24oKXsKICAgICAgdmFyIG5hbWVzID0gW107CgogICAgICBmb3IodmFyIGk9MDsgaTx0cmlhbHMubGVuZ3RoOyBpKyspewogICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXModHJpYWxzW2ldKTsKICAgICAgICBmb3IodmFyIGo9MDsgajxrZXlzLmxlbmd0aDsgaisrKXsKICAgICAgICAgIGlmKCFuYW1lcy5pbmNsdWRlcyhrZXlzW2pdKSl7CiAgICAgICAgICAgIG5hbWVzLnB1c2goa2V5c1tqXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gbmFtZXM7CiAgICB9CgogICAgZGF0YV9jb2xsZWN0aW9uLmNzdiA9IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiBKU09OMkNTVih0cmlhbHMpOwogICAgfQoKICAgIGRhdGFfY29sbGVjdGlvbi5qc29uID0gZnVuY3Rpb24ocHJldHR5KXsKICAgICAgaWYocHJldHR5KXsKICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkodHJpYWxzLCBudWxsLCAnXHQnKTsKICAgICAgfQogICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkodHJpYWxzKTsKICAgIH0KCiAgICBkYXRhX2NvbGxlY3Rpb24ubG9jYWxTYXZlID0gZnVuY3Rpb24oZm9ybWF0LCBmaWxlbmFtZSl7CiAgICAgIHZhciBkYXRhX3N0cmluZzsKCiAgICAgIGlmIChmb3JtYXQgPT0gJ0pTT04nIHx8IGZvcm1hdCA9PSAnanNvbicpIHsKICAgICAgICBkYXRhX3N0cmluZyA9IGRhdGFfY29sbGVjdGlvbi5qc29uKCk7CiAgICAgIH0gZWxzZSBpZiAoZm9ybWF0ID09ICdDU1YnIHx8IGZvcm1hdCA9PSAnY3N2JykgewogICAgICAgIGRhdGFfc3RyaW5nID0gZGF0YV9jb2xsZWN0aW9uLmNzdigpOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBmb3JtYXQgc3BlY2lmaWVkIGZvciBsb2NhbFNhdmUuIE11c3QgYmUgIkpTT04iIG9yICJDU1YiLicpOwogICAgICB9CgogICAgICBzYXZlVGV4dFRvRmlsZShkYXRhX3N0cmluZywgZmlsZW5hbWUpOwogICAgfQoKICAgIHJldHVybiBkYXRhX2NvbGxlY3Rpb247CiAgfQoKICAvLyBEYXRhQ29sdW1uIGNsYXNzCiAgZnVuY3Rpb24gRGF0YUNvbHVtbigpewogICAgdmFyIGRhdGFfY29sdW1uID0ge307CgogICAgZGF0YV9jb2x1bW4udmFsdWVzID0gW107CgogICAgZGF0YV9jb2x1bW4uc3VtID0gZnVuY3Rpb24oKXsKICAgICAgdmFyIHMgPSAwOwogICAgICBmb3IodmFyIGk9MDsgaTxkYXRhX2NvbHVtbi52YWx1ZXMubGVuZ3RoOyBpKyspewogICAgICAgIHMgKz0gZGF0YV9jb2x1bW4udmFsdWVzW2ldOwogICAgICB9CiAgICAgIHJldHVybiBzOwogICAgfQoKICAgIGRhdGFfY29sdW1uLm1lYW4gPSBmdW5jdGlvbigpewogICAgICByZXR1cm4gZGF0YV9jb2x1bW4uc3VtKCkgLyBkYXRhX2NvbHVtbi5jb3VudCgpOwogICAgfQoKICAgIGRhdGFfY29sdW1uLm1lZGlhbiA9IGZ1bmN0aW9uKCl7CiAgICAgIGlmIChkYXRhX2NvbHVtbi52YWx1ZXMubGVuZ3RoID09IDApIHtyZXR1cm4gdW5kZWZpbmVkfTsKICAgICAgdmFyIG51bWJlcnMgPSBkYXRhX2NvbHVtbi52YWx1ZXMuc2xpY2UoMCkuc29ydChmdW5jdGlvbihhLGIpeyByZXR1cm4gYSAtIGI7IH0pOwogICAgICB2YXIgbWlkZGxlID0gTWF0aC5mbG9vcihudW1iZXJzLmxlbmd0aCAvIDIpOwogICAgICB2YXIgaXNFdmVuID0gbnVtYmVycy5sZW5ndGggJSAyID09PSAwOwogICAgICByZXR1cm4gaXNFdmVuID8gKG51bWJlcnNbbWlkZGxlXSArIG51bWJlcnNbbWlkZGxlIC0gMV0pIC8gMiA6IG51bWJlcnNbbWlkZGxlXTsKICAgIH0KCiAgICBkYXRhX2NvbHVtbi5taW4gPSBmdW5jdGlvbigpewogICAgICByZXR1cm4gTWF0aC5taW4uYXBwbHkobnVsbCwgZGF0YV9jb2x1bW4udmFsdWVzKTsKICAgIH0KCiAgICBkYXRhX2NvbHVtbi5tYXggPSBmdW5jdGlvbigpewogICAgICByZXR1cm4gTWF0aC5tYXguYXBwbHkobnVsbCwgZGF0YV9jb2x1bW4udmFsdWVzKTsKICAgIH0KCiAgICBkYXRhX2NvbHVtbi5jb3VudCA9IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiBkYXRhX2NvbHVtbi52YWx1ZXMubGVuZ3RoOwogICAgfQoKICAgIGRhdGFfY29sdW1uLnZhcmlhbmNlID0gZnVuY3Rpb24oKXsKICAgICAgdmFyIG1lYW4gPSBkYXRhX2NvbHVtbi5tZWFuKCk7CiAgICAgIHZhciBzdW1fc3F1YXJlX2Vycm9yID0gMDsKICAgICAgZm9yKHZhciBpPTA7IGk8ZGF0YV9jb2x1bW4udmFsdWVzLmxlbmd0aDsgaSsrKXsKICAgICAgICBzdW1fc3F1YXJlX2Vycm9yICs9IE1hdGgucG93KGRhdGFfY29sdW1uLnZhbHVlc1tpXSAtIG1lYW4sMik7CiAgICAgIH0KICAgICAgdmFyIG1zZSA9IHN1bV9zcXVhcmVfZXJyb3IgLyAoZGF0YV9jb2x1bW4udmFsdWVzLmxlbmd0aCAtIDEpOwogICAgICByZXR1cm4gbXNlOwogICAgfQoKICAgIGRhdGFfY29sdW1uLnNkID0gZnVuY3Rpb24oKXsKICAgICAgdmFyIG1zZSA9IGRhdGFfY29sdW1uLnZhcmlhbmNlKCk7CiAgICAgIHZhciBybXNlID0gTWF0aC5zcXJ0KG1zZSk7CiAgICAgIHJldHVybiBybXNlOwogICAgfQoKICAgIGRhdGFfY29sdW1uLmZyZXF1ZW5jaWVzID0gZnVuY3Rpb24oKXsKICAgICAgdmFyIHVuaXF1ZSA9IHt9CiAgICAgIGZvcih2YXIgaT0wOyBpPGRhdGFfY29sdW1uLnZhbHVlcy5sZW5ndGg7IGkrKyl7CiAgICAgICAgdmFyIHYgPSBkYXRhX2NvbHVtbi52YWx1ZXNbaV07CiAgICAgICAgaWYodHlwZW9mIHVuaXF1ZVt2XSA9PSAndW5kZWZpbmVkJyl7CiAgICAgICAgICB1bmlxdWVbdl0gPSAxOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB1bmlxdWVbdl0rKzsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHVuaXF1ZTsKICAgIH0KCiAgICBkYXRhX2NvbHVtbi5hbGwgPSBmdW5jdGlvbihldmFsX2ZuKXsKICAgICAgZm9yKHZhciBpPTA7IGk8ZGF0YV9jb2x1bW4udmFsdWVzLmxlbmd0aDsgaSsrKXsKICAgICAgICBpZighZXZhbF9mbihkYXRhX2NvbHVtbi52YWx1ZXNbaV0pKXsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgZGF0YV9jb2x1bW4uc3Vic2V0ID0gZnVuY3Rpb24oZXZhbF9mbil7CiAgICAgIHZhciBvdXQgPSBbXTsKICAgICAgZm9yKHZhciBpPTA7IGk8ZGF0YV9jb2x1bW4udmFsdWVzLmxlbmd0aDsgaSsrKXsKICAgICAgICBpZihldmFsX2ZuKGRhdGFfY29sdW1uLnZhbHVlc1tpXSkpewogICAgICAgICAgb3V0LnB1c2goZGF0YV9jb2x1bW4udmFsdWVzW2ldKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdmFyIG8gPSBEYXRhQ29sdW1uKCk7CiAgICAgIG8udmFsdWVzID0gb3V0OwogICAgICByZXR1cm4gbzsKICAgIH0KCiAgICByZXR1cm4gZGF0YV9jb2x1bW47CiAgfQoKICBtb2R1bGUucmVzZXQgPSBmdW5jdGlvbigpewogICAgYWxsRGF0YSA9IERhdGFDb2xsZWN0aW9uKCk7CiAgICBpbnRlcmFjdGlvbkRhdGEgPSBEYXRhQ29sbGVjdGlvbigpOwogIH0KCiAgbW9kdWxlLmdldCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGFsbERhdGE7CiAgfTsKCiAgbW9kdWxlLmdldEludGVyYWN0aW9uRGF0YSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGludGVyYWN0aW9uRGF0YTsKICB9CgogIG1vZHVsZS53cml0ZSA9IGZ1bmN0aW9uKGRhdGFfb2JqZWN0KSB7CgogICAgdmFyIHByb2dyZXNzID0ganNQc3ljaC5wcm9ncmVzcygpOwogICAgdmFyIHRyaWFsID0ganNQc3ljaC5jdXJyZW50VHJpYWwoKTsKCiAgICAvL3ZhciB0cmlhbF9vcHRfZGF0YSA9IHR5cGVvZiB0cmlhbC5kYXRhID09ICdmdW5jdGlvbicgPyB0cmlhbC5kYXRhKCkgOiB0cmlhbC5kYXRhOwoKICAgIHZhciBkZWZhdWx0X2RhdGEgPSB7CiAgICAgICd0cmlhbF90eXBlJzogdHJpYWwudHlwZSwKICAgICAgJ3RyaWFsX2luZGV4JzogcHJvZ3Jlc3MuY3VycmVudF90cmlhbF9nbG9iYWwsCiAgICAgICd0aW1lX2VsYXBzZWQnOiBqc1BzeWNoLnRvdGFsVGltZSgpLAogICAgICAnaW50ZXJuYWxfbm9kZV9pZCc6IGpzUHN5Y2guY3VycmVudFRpbWVsaW5lTm9kZUlEKCkKICAgIH07CgogICAgdmFyIGV4dF9kYXRhX29iamVjdCA9IE9iamVjdC5hc3NpZ24oe30sIGRhdGFfb2JqZWN0LCB0cmlhbC5kYXRhLCBkZWZhdWx0X2RhdGEsIGRhdGFQcm9wZXJ0aWVzKTsKCiAgICBhbGxEYXRhLnB1c2goZXh0X2RhdGFfb2JqZWN0KTsKICB9OwoKICBtb2R1bGUuYWRkUHJvcGVydGllcyA9IGZ1bmN0aW9uKHByb3BlcnRpZXMpIHsKCiAgICAvLyBmaXJzdCwgYWRkIHRoZSBwcm9wZXJ0aWVzIHRvIGFsbCBkYXRhIHRoYXQncyBhbHJlYWR5IHN0b3JlZAogICAgYWxsRGF0YS5hZGRUb0FsbChwcm9wZXJ0aWVzKTsKCiAgICAvLyBub3cgYWRkIHRvIGxpc3Qgc28gdGhhdCBpdCBnZXRzIGFwcGVuZGVkIHRvIGFsbCBmdXR1cmUgZGF0YQogICAgZGF0YVByb3BlcnRpZXMgPSBPYmplY3QuYXNzaWduKHt9LCBkYXRhUHJvcGVydGllcywgcHJvcGVydGllcyk7CgogIH07CgogIG1vZHVsZS5hZGREYXRhVG9MYXN0VHJpYWwgPSBmdW5jdGlvbihkYXRhKSB7CiAgICBhbGxEYXRhLmFkZFRvTGFzdChkYXRhKTsKICB9CgogIG1vZHVsZS5nZXREYXRhQnlUaW1lbGluZU5vZGUgPSBmdW5jdGlvbihub2RlX2lkKSB7CiAgICB2YXIgZGF0YSA9IGFsbERhdGEuZmlsdGVyQ3VzdG9tKGZ1bmN0aW9uKHgpewogICAgICByZXR1cm4geC5pbnRlcm5hbF9ub2RlX2lkLnNsaWNlKDAsIG5vZGVfaWQubGVuZ3RoKSA9PT0gbm9kZV9pZDsKICAgIH0pOwoKICAgIHJldHVybiBkYXRhOwogIH07CgogIG1vZHVsZS5nZXRMYXN0VHJpYWxEYXRhID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gYWxsRGF0YS50b3AoKTsKICB9OwoKICBtb2R1bGUuZ2V0TGFzdFRpbWVsaW5lRGF0YSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGxhc3R0cmlhbCA9IG1vZHVsZS5nZXRMYXN0VHJpYWxEYXRhKCk7CiAgICB2YXIgbm9kZV9pZCA9IGxhc3R0cmlhbC5zZWxlY3QoJ2ludGVybmFsX25vZGVfaWQnKS52YWx1ZXNbMF07CiAgICBpZiAodHlwZW9mIG5vZGVfaWQgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHJldHVybiBEYXRhQ29sbGVjdGlvbigpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIHBhcmVudF9ub2RlX2lkID0gbm9kZV9pZC5zdWJzdHIoMCxub2RlX2lkLmxhc3RJbmRleE9mKCctJykpOwogICAgICB2YXIgbGFzdG5vZGVkYXRhID0gbW9kdWxlLmdldERhdGFCeVRpbWVsaW5lTm9kZShwYXJlbnRfbm9kZV9pZCk7CiAgICAgIHJldHVybiBsYXN0bm9kZWRhdGE7CiAgICB9CiAgfQoKICBtb2R1bGUuZGlzcGxheURhdGEgPSBmdW5jdGlvbihmb3JtYXQpIHsKICAgIGZvcm1hdCA9ICh0eXBlb2YgZm9ybWF0ID09PSAndW5kZWZpbmVkJykgPyAianNvbiIgOiBmb3JtYXQudG9Mb3dlckNhc2UoKTsKICAgIGlmIChmb3JtYXQgIT0gImpzb24iICYmIGZvcm1hdCAhPSAiY3N2IikgewogICAgICBjb25zb2xlLmxvZygnSW52YWxpZCBmb3JtYXQgZGVjbGFyZWQgZm9yIGRpc3BsYXlEYXRhIGZ1bmN0aW9uLiBVc2luZyBqc29uIGFzIGRlZmF1bHQuJyk7CiAgICAgIGZvcm1hdCA9ICJqc29uIjsKICAgIH0KCiAgICB2YXIgZGF0YV9zdHJpbmc7CgogICAgaWYgKGZvcm1hdCA9PSAnanNvbicpIHsKICAgICAgZGF0YV9zdHJpbmcgPSBhbGxEYXRhLmpzb24odHJ1ZSk7IC8vIHRydWUgPSBwcmV0dHkgcHJpbnQgd2l0aCB0YWJzCiAgICB9IGVsc2UgewogICAgICBkYXRhX3N0cmluZyA9IGFsbERhdGEuY3N2KCk7CiAgICB9CgogICAgdmFyIGRpc3BsYXlfZWxlbWVudCA9IGpzUHN5Y2guZ2V0RGlzcGxheUVsZW1lbnQoKTsKCiAgICBkaXNwbGF5X2VsZW1lbnQuaW5uZXJIVE1MID0gJzxwcmUgaWQ9ImpzcHN5Y2gtZGF0YS1kaXNwbGF5Ij48L3ByZT4nOwoKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqc3BzeWNoLWRhdGEtZGlzcGxheScpLnRleHRDb250ZW50ID0gZGF0YV9zdHJpbmc7CiAgfTsKCiAgbW9kdWxlLnVybFZhcmlhYmxlcyA9IGZ1bmN0aW9uKCkgewogICAgaWYodHlwZW9mIHF1ZXJ5X3N0cmluZyA9PSAndW5kZWZpbmVkJyl7CiAgICAgIHF1ZXJ5X3N0cmluZyA9IGdldFF1ZXJ5U3RyaW5nKCk7CiAgICB9CiAgICByZXR1cm4gcXVlcnlfc3RyaW5nOwogIH0KCiAgbW9kdWxlLmdldFVSTFZhcmlhYmxlID0gZnVuY3Rpb24od2hpY2h2YXIpewogICAgaWYodHlwZW9mIHF1ZXJ5X3N0cmluZyA9PSAndW5kZWZpbmVkJyl7CiAgICAgIHF1ZXJ5X3N0cmluZyA9IGdldFF1ZXJ5U3RyaW5nKCk7CiAgICB9CiAgICByZXR1cm4gcXVlcnlfc3RyaW5nW3doaWNodmFyXTsKICB9CgogIG1vZHVsZS5jcmVhdGVJbnRlcmFjdGlvbkxpc3RlbmVycyA9IGZ1bmN0aW9uKCl7CiAgICAvLyBibHVyIGV2ZW50IGNhcHR1cmUKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdibHVyJywgZnVuY3Rpb24oKXsKICAgICAgdmFyIGRhdGEgPSB7CiAgICAgICAgZXZlbnQ6ICdibHVyJywKICAgICAgICB0cmlhbDoganNQc3ljaC5wcm9ncmVzcygpLmN1cnJlbnRfdHJpYWxfZ2xvYmFsLAogICAgICAgIHRpbWU6IGpzUHN5Y2gudG90YWxUaW1lKCkKICAgICAgfTsKICAgICAgaW50ZXJhY3Rpb25EYXRhLnB1c2goZGF0YSk7CiAgICAgIGpzUHN5Y2guaW5pdFNldHRpbmdzKCkub25faW50ZXJhY3Rpb25fZGF0YV91cGRhdGUoZGF0YSk7CiAgICB9KTsKCiAgICAvLyBmb2N1cyBldmVudCBjYXB0dXJlCiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignZm9jdXMnLCBmdW5jdGlvbigpewogICAgICB2YXIgZGF0YSA9IHsKICAgICAgICBldmVudDogJ2ZvY3VzJywKICAgICAgICB0cmlhbDoganNQc3ljaC5wcm9ncmVzcygpLmN1cnJlbnRfdHJpYWxfZ2xvYmFsLAogICAgICAgIHRpbWU6IGpzUHN5Y2gudG90YWxUaW1lKCkKICAgICAgfTsKICAgICAgaW50ZXJhY3Rpb25EYXRhLnB1c2goZGF0YSk7CiAgICAgIGpzUHN5Y2guaW5pdFNldHRpbmdzKCkub25faW50ZXJhY3Rpb25fZGF0YV91cGRhdGUoZGF0YSk7CiAgICB9KTsKCiAgICAvLyBmdWxsc2NyZWVuIGNoYW5nZSBjYXB0dXJlCiAgICBmdW5jdGlvbiBmdWxsc2NyZWVuY2hhbmdlKCl7CiAgICAgIHZhciB0eXBlID0gKGRvY3VtZW50LmlzRnVsbFNjcmVlbiB8fCBkb2N1bWVudC53ZWJraXRJc0Z1bGxTY3JlZW4gfHwgZG9jdW1lbnQubW96SXNGdWxsU2NyZWVuIHx8IGRvY3VtZW50LmZ1bGxzY3JlZW5FbGVtZW50KSA/ICdmdWxsc2NyZWVuZW50ZXInIDogJ2Z1bGxzY3JlZW5leGl0JzsKICAgICAgdmFyIGRhdGEgPSB7CiAgICAgICAgZXZlbnQ6IHR5cGUsCiAgICAgICAgdHJpYWw6IGpzUHN5Y2gucHJvZ3Jlc3MoKS5jdXJyZW50X3RyaWFsX2dsb2JhbCwKICAgICAgICB0aW1lOiBqc1BzeWNoLnRvdGFsVGltZSgpCiAgICAgIH07CiAgICAgIGludGVyYWN0aW9uRGF0YS5wdXNoKGRhdGEpOwogICAgICBqc1BzeWNoLmluaXRTZXR0aW5ncygpLm9uX2ludGVyYWN0aW9uX2RhdGFfdXBkYXRlKGRhdGEpOwogICAgfQoKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2Z1bGxzY3JlZW5jaGFuZ2UnLCBmdWxsc2NyZWVuY2hhbmdlKTsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vemZ1bGxzY3JlZW5jaGFuZ2UnLCBmdWxsc2NyZWVuY2hhbmdlKTsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3dlYmtpdGZ1bGxzY3JlZW5jaGFuZ2UnLCBmdWxsc2NyZWVuY2hhbmdlKTsKICB9CgogIC8vIHB1YmxpYyBtZXRob2RzIGZvciB0ZXN0aW5nIHB1cnBvc2VzLiBub3QgcmVjb21tZW5kZWQgZm9yIHVzZS4KICBtb2R1bGUuX2N1c3RvbUluc2VydCA9IGZ1bmN0aW9uKGRhdGEpewogICAgYWxsRGF0YSA9IERhdGFDb2xsZWN0aW9uKGRhdGEpOwogIH0KCiAgbW9kdWxlLl9mdWxscmVzZXQgPSBmdW5jdGlvbigpewogICAgbW9kdWxlLnJlc2V0KCk7CiAgICBkYXRhUHJvcGVydGllcyA9IHt9OwogIH0KCiAgLy8gcHJpdmF0ZSBmdW5jdGlvbiB0byBzYXZlIHRleHQgZmlsZSBvbiBsb2NhbCBkcml2ZQogIGZ1bmN0aW9uIHNhdmVUZXh0VG9GaWxlKHRleHRzdHIsIGZpbGVuYW1lKSB7CiAgICB2YXIgYmxvYlRvU2F2ZSA9IG5ldyBCbG9iKFt0ZXh0c3RyXSwgewogICAgICB0eXBlOiAndGV4dC9wbGFpbicKICAgIH0pOwogICAgdmFyIGJsb2JVUkwgPSAiIjsKICAgIGlmICh0eXBlb2Ygd2luZG93LndlYmtpdFVSTCAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgYmxvYlVSTCA9IHdpbmRvdy53ZWJraXRVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2JUb1NhdmUpOwogICAgfSBlbHNlIHsKICAgICAgYmxvYlVSTCA9IHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2JUb1NhdmUpOwogICAgfQoKICAgIHZhciBkaXNwbGF5X2VsZW1lbnQgPSBqc1BzeWNoLmdldERpc3BsYXlFbGVtZW50KCk7CgogICAgZGlzcGxheV9lbGVtZW50Lmluc2VydEFkamFjZW50SFRNTCgnYmVmb3JlZW5kJywnPGEgaWQ9ImpzcHN5Y2gtZG93bmxvYWQtYXMtdGV4dC1saW5rIiBzdHlsZT0iZGlzcGxheTpub25lOyIgZG93bmxvYWQ9IicrZmlsZW5hbWUrJyIgaHJlZj0iJytibG9iVVJMKyciPmNsaWNrIHRvIGRvd25sb2FkPC9hPicpOwogICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2pzcHN5Y2gtZG93bmxvYWQtYXMtdGV4dC1saW5rJykuY2xpY2soKTsKICB9CgogIC8vCiAgLy8gQSBmZXcgaGVscGVyIGZ1bmN0aW9ucyB0byBoYW5kbGUgZGF0YSBmb3JtYXQgY29udmVyc2lvbgogIC8vCgogIC8vIHRoaXMgZnVuY3Rpb24gYmFzZWQgb24gY29kZSBzdWdnZXN0ZWQgYnkgU3RhY2tPdmVyZmxvdyB1c2VyczoKICAvLyBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vdXNlcnMvNjQ3NDEvemFjaGFyeQogIC8vIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS91c2Vycy8zMTcvam9zZXBoLXN0dXJ0ZXZhbnQKCiAgZnVuY3Rpb24gSlNPTjJDU1Yob2JqQXJyYXkpIHsKICAgIHZhciBhcnJheSA9IHR5cGVvZiBvYmpBcnJheSAhPSAnb2JqZWN0JyA/IEpTT04ucGFyc2Uob2JqQXJyYXkpIDogb2JqQXJyYXk7CiAgICB2YXIgbGluZSA9ICcnOwogICAgdmFyIHJlc3VsdCA9ICcnOwogICAgdmFyIGNvbHVtbnMgPSBbXTsKCiAgICB2YXIgaSA9IDA7CiAgICBmb3IgKHZhciBqID0gMDsgaiA8IGFycmF5Lmxlbmd0aDsgaisrKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBhcnJheVtqXSkgewogICAgICAgIHZhciBrZXlTdHJpbmcgPSBrZXkgKyAiIjsKICAgICAgICBrZXlTdHJpbmcgPSAnIicgKyBrZXlTdHJpbmcucmVwbGFjZSgvIi9nLCAnIiInKSArICciLCc7CiAgICAgICAgaWYgKCFjb2x1bW5zLmluY2x1ZGVzKGtleSkpIHsKICAgICAgICAgIGNvbHVtbnNbaV0gPSBrZXk7CiAgICAgICAgICBsaW5lICs9IGtleVN0cmluZzsKICAgICAgICAgIGkrKzsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBsaW5lID0gbGluZS5zbGljZSgwLCAtMSk7CiAgICByZXN1bHQgKz0gbGluZSArICdcclxuJzsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBsaW5lID0gJyc7CiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgY29sdW1ucy5sZW5ndGg7IGorKykgewogICAgICAgIHZhciB2YWx1ZSA9ICh0eXBlb2YgYXJyYXlbaV1bY29sdW1uc1tqXV0gPT09ICd1bmRlZmluZWQnKSA/ICcnIDogYXJyYXlbaV1bY29sdW1uc1tqXV07CiAgICAgICAgaWYodHlwZW9mIHZhbHVlID09ICdvYmplY3QnKSB7CiAgICAgICAgICB2YWx1ZSA9IEpTT04uc3RyaW5naWZ5KHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgdmFyIHZhbHVlU3RyaW5nID0gdmFsdWUgKyAiIjsKICAgICAgICBsaW5lICs9ICciJyArIHZhbHVlU3RyaW5nLnJlcGxhY2UoLyIvZywgJyIiJykgKyAnIiwnOwogICAgICB9CgogICAgICBsaW5lID0gbGluZS5zbGljZSgwLCAtMSk7CiAgICAgIHJlc3VsdCArPSBsaW5lICsgJ1xyXG4nOwogICAgfQoKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvLyB0aGlzIGZ1bmN0aW9uIGlzIG1vZGlmaWVkIGZyb20gU3RhY2tPdmVyZmxvdzoKICAvLyBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcG9zdHMvMzg1NTM5NAoKICBmdW5jdGlvbiBnZXRRdWVyeVN0cmluZygpIHsKICAgIHZhciBhID0gd2luZG93LmxvY2F0aW9uLnNlYXJjaC5zdWJzdHIoMSkuc3BsaXQoJyYnKTsKICAgIGlmIChhID09ICIiKSByZXR1cm4ge307CiAgICB2YXIgYiA9IHt9OwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhLmxlbmd0aDsgKytpKQogICAgewogICAgICAgIHZhciBwPWFbaV0uc3BsaXQoJz0nLCAyKTsKICAgICAgICBpZiAocC5sZW5ndGggPT0gMSkKICAgICAgICAgICAgYltwWzBdXSA9ICIiOwogICAgICAgIGVsc2UKICAgICAgICAgICAgYltwWzBdXSA9IGRlY29kZVVSSUNvbXBvbmVudChwWzFdLnJlcGxhY2UoL1wrL2csICIgIikpOwogICAgfQogICAgcmV0dXJuIGI7CiAgfQoKICByZXR1cm4gbW9kdWxlOwoKfSkoKTsKCmpzUHN5Y2gudHVyayA9IChmdW5jdGlvbigpIHsKCiAgdmFyIG1vZHVsZSA9IHt9OwoKICAvLyBjb3JlLnR1cmtJbmZvIGdldHMgaW5mb3JtYXRpb24gcmVsZXZhbnQgdG8gbWVjaGFuaWNhbCB0dXJrIGV4cGVyaW1lbnRzLiByZXR1cm5zIGFuIG9iamVjdAogIC8vIGNvbnRhaW5pbmcgdGhlIHdvcmtlcklELCBhc3NpZ25tZW50SUQsIGFuZCBoaXRJRCwgYW5kIHdoZXRoZXIgb3Igbm90IHRoZSBISVQgaXMgaW4KICAvLyBwcmV2aWV3IG1vZGUsIG1lYW5pbmcgdGhhdCB0aGV5IGhhdmVuJ3QgYWNjZXB0ZWQgdGhlIEhJVCB5ZXQuCiAgbW9kdWxlLnR1cmtJbmZvID0gZnVuY3Rpb24oKSB7CgogICAgdmFyIHR1cmsgPSB7fTsKCiAgICB2YXIgcGFyYW0gPSBmdW5jdGlvbih1cmwsIG5hbWUpIHsKICAgICAgbmFtZSA9IG5hbWUucmVwbGFjZSgvW1xbXS8sICJcXFxbIikucmVwbGFjZSgvW1xdXS8sICJcXFxdIik7CiAgICAgIHZhciByZWdleFMgPSAiW1xcPyZdIiArIG5hbWUgKyAiPShbXiYjXSopIjsKICAgICAgdmFyIHJlZ2V4ID0gbmV3IFJlZ0V4cChyZWdleFMpOwogICAgICB2YXIgcmVzdWx0cyA9IHJlZ2V4LmV4ZWModXJsKTsKICAgICAgcmV0dXJuIChyZXN1bHRzID09IG51bGwpID8gIiIgOiByZXN1bHRzWzFdOwogICAgfTsKCiAgICB2YXIgc3JjID0gcGFyYW0od2luZG93LmxvY2F0aW9uLmhyZWYsICJhc3NpZ25tZW50SWQiKSA/IHdpbmRvdy5sb2NhdGlvbi5ocmVmIDogZG9jdW1lbnQucmVmZXJyZXI7CgogICAgdmFyIGtleXMgPSBbImFzc2lnbm1lbnRJZCIsICJoaXRJZCIsICJ3b3JrZXJJZCIsICJ0dXJrU3VibWl0VG8iXTsKICAgIGtleXMubWFwKAoKICAgICAgZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgdHVya1trZXldID0gdW5lc2NhcGUocGFyYW0oc3JjLCBrZXkpKTsKICAgICAgfSk7CgogICAgdHVyay5wcmV2aWV3TW9kZSA9ICh0dXJrLmFzc2lnbm1lbnRJZCA9PSAiQVNTSUdOTUVOVF9JRF9OT1RfQVZBSUxBQkxFIik7CgogICAgdHVyay5vdXRzaWRlVHVyayA9ICghdHVyay5wcmV2aWV3TW9kZSAmJiB0dXJrLmhpdElkID09PSAiIiAmJiB0dXJrLmFzc2lnbm1lbnRJZCA9PSAiIiAmJiB0dXJrLndvcmtlcklkID09ICIiKQoKICAgIHR1cmtfaW5mbyA9IHR1cms7CgogICAgcmV0dXJuIHR1cms7CgogIH07CgogIC8vIGNvcmUuc3VibWl0VG9UdXJrIHdpbGwgc3VibWl0IGEgTWVjaGFuaWNhbFR1cmsgRXh0ZXJuYWxISVQgdHlwZQogIG1vZHVsZS5zdWJtaXRUb1R1cmsgPSBmdW5jdGlvbihkYXRhKSB7CgogICAgdmFyIHR1cmtJbmZvID0ganNQc3ljaC50dXJrLnR1cmtJbmZvKCk7CiAgICB2YXIgYXNzaWdubWVudElkID0gdHVya0luZm8uYXNzaWdubWVudElkOwogICAgdmFyIHR1cmtTdWJtaXRUbyA9IHR1cmtJbmZvLnR1cmtTdWJtaXRUbzsKCiAgICBpZiAoIWFzc2lnbm1lbnRJZCB8fCAhdHVya1N1Ym1pdFRvKSByZXR1cm47CgogICAgdmFyIGRhdGFTdHJpbmcgPSBbXTsKCiAgICBmb3IgKHZhciBrZXkgaW4gZGF0YSkgewoKICAgICAgaWYgKGRhdGEuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgIGRhdGFTdHJpbmcucHVzaChrZXkgKyAiPSIgKyBlc2NhcGUoZGF0YVtrZXldKSk7CiAgICAgIH0KICAgIH0KCiAgICBkYXRhU3RyaW5nLnB1c2goImFzc2lnbm1lbnRJZD0iICsgYXNzaWdubWVudElkKTsKCiAgICB2YXIgdXJsID0gdHVya1N1Ym1pdFRvICsgIi9tdHVyay9leHRlcm5hbFN1Ym1pdD8iICsgZGF0YVN0cmluZy5qb2luKCImIik7CgogICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSB1cmw7CiAgfTsKCiAgcmV0dXJuIG1vZHVsZTsKCn0pKCk7Cgpqc1BzeWNoLnJhbmRvbWl6YXRpb24gPSAoZnVuY3Rpb24oKSB7CgogIHZhciBtb2R1bGUgPSB7fTsKCiAgbW9kdWxlLnJlcGVhdCA9IGZ1bmN0aW9uKGFycmF5LCByZXBldGl0aW9ucywgdW5wYWNrKSB7CgogICAgdmFyIGFycl9pc0FycmF5ID0gQXJyYXkuaXNBcnJheShhcnJheSk7CiAgICB2YXIgcmVwX2lzQXJyYXkgPSBBcnJheS5pc0FycmF5KHJlcGV0aXRpb25zKTsKCiAgICAvLyBpZiBhcnJheSBpcyBub3QgYW4gYXJyYXksIHRoZW4gd2UganVzdCByZXBlYXQgdGhlIGl0ZW0KICAgIGlmICghYXJyX2lzQXJyYXkpIHsKICAgICAgaWYgKCFyZXBfaXNBcnJheSkgewogICAgICAgIGFycmF5ID0gW2FycmF5XTsKICAgICAgICByZXBldGl0aW9ucyA9IFtyZXBldGl0aW9uc107CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVwZXRpdGlvbnMgPSBbcmVwZXRpdGlvbnNbMF1dOwogICAgICAgIGNvbnNvbGUubG9nKCdVbmNsZWFyIHBhcmFtZXRlcnMgZ2l2ZW4gdG8gcmFuZG9taXphdGlvbi5yZXBlYXQuIE11bHRpcGxlIHNldCBzaXplcyBzcGVjaWZpZWQsIGJ1dCBvbmx5IG9uZSBpdGVtIGV4aXN0cyB0byBzYW1wbGUuIFByb2NlZWRpbmcgdXNpbmcgdGhlIGZpcnN0IHNldCBzaXplLicpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAoIXJlcF9pc0FycmF5KSB7CiAgICAgICAgdmFyIHJlcHMgPSBbXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICByZXBzLnB1c2gocmVwZXRpdGlvbnMpOwogICAgICAgIH0KICAgICAgICByZXBldGl0aW9ucyA9IHJlcHM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGFycmF5Lmxlbmd0aCAhPSByZXBldGl0aW9ucy5sZW5ndGgpIHsKICAgICAgICAgIGNvbnNvbGUud2FybmluZygnVW5jbGVhciBwYXJhbWV0ZXJzIGdpdmVuIHRvIHJhbmRvbWl6YXRpb24ucmVwZWF0LiBJdGVtcyBhbmQgcmVwZXRpdGlvbnMgYXJlIHVuZXF1YWwgbGVuZ3Rocy4gQmVoYXZpb3IgbWF5IG5vdCBiZSBhcyBleHBlY3RlZC4nKTsKICAgICAgICAgIC8vIHRocm93IHdhcm5pbmcgaWYgcmVwZXRpdGlvbnMgaXMgdG9vIHNob3J0LCB1c2UgZmlyc3QgcmVwIE9OTFkuCiAgICAgICAgICBpZiAocmVwZXRpdGlvbnMubGVuZ3RoIDwgYXJyYXkubGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciByZXBzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICByZXBzLnB1c2gocmVwZXRpdGlvbnMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlcGV0aXRpb25zID0gcmVwczsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIHRocm93IHdhcm5pbmcgaWYgdG9vIGxvbmcsIGFuZCB0aGVuIHVzZSB0aGUgZmlyc3QgTgogICAgICAgICAgICByZXBldGl0aW9ucyA9IHJlcGV0aXRpb25zLnNsaWNlKDAsIGFycmF5Lmxlbmd0aCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgLy8gc2hvdWxkIGJlIGNsZWFyIGF0IHRoaXMgcG9pbnQgdG8gYXNzdW1lIHRoYXQgYXJyYXkgYW5kIHJlcGV0aXRpb25zIGFyZSBhcnJheXMgd2l0aCA9PSBsZW5ndGgKICAgIHZhciBhbGxzYW1wbGVzID0gW107CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgcmVwZXRpdGlvbnNbaV07IGorKykgewogICAgICAgIGlmKGFycmF5W2ldID09IG51bGwgfHwgdHlwZW9mIGFycmF5W2ldICE9ICdvYmplY3QnKXsKICAgICAgICAgIGFsbHNhbXBsZXMucHVzaChhcnJheVtpXSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFsbHNhbXBsZXMucHVzaChPYmplY3QuYXNzaWduKHt9LCBhcnJheVtpXSkpOwogICAgICAgIH0KCiAgICAgIH0KICAgIH0KCiAgICB2YXIgb3V0ID0gc2h1ZmZsZShhbGxzYW1wbGVzKTsKCiAgICBpZiAodW5wYWNrKSB7CiAgICAgIG91dCA9IHVucGFja0FycmF5KG91dCk7CiAgICB9CgogICAgcmV0dXJuIG91dDsKICB9CgogIG1vZHVsZS5zaHVmZmxlID0gZnVuY3Rpb24oYXJyKSB7CiAgICBpZighQXJyYXkuaXNBcnJheShhcnIpKXsKICAgICAgY29uc29sZS5lcnJvcignQXJndW1lbnQgdG8ganNQc3ljaC5yYW5kb21pemF0aW9uLnNodWZmbGUoKSBtdXN0IGJlIGFuIGFycmF5LicpCiAgICB9CiAgICByZXR1cm4gc2h1ZmZsZShhcnIpOwogIH0KCiAgbW9kdWxlLnNodWZmbGVOb1JlcGVhdHMgPSBmdW5jdGlvbihhcnIsIGVxdWFsaXR5VGVzdCkgewogICAgaWYoIUFycmF5LmlzQXJyYXkoYXJyKSl7CiAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZpcnN0IGFyZ3VtZW50IHRvIGpzUHN5Y2gucmFuZG9taXphdGlvbi5zaHVmZmxlTm9SZXBlYXRzKCkgbXVzdCBiZSBhbiBhcnJheS4nKQogICAgfQogICAgaWYodHlwZW9mIGVxdWFsaXR5VGVzdCAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIGVxdWFsaXR5VGVzdCAhPT0gJ2Z1bmN0aW9uJyl7CiAgICAgIGNvbnNvbGUuZXJyb3IoJ1NlY29uZCBhcmd1bWVudCB0byBqc1BzeWNoLnJhbmRvbWl6YXRpb24uc2h1ZmZsZU5vUmVwZWF0cygpIG11c3QgYmUgYSBmdW5jdGlvbi4nKQogICAgfQogICAgLy8gZGVmaW5lIGEgZGVmYXVsdCBlcXVhbGl0eVRlc3QKICAgIGlmICh0eXBlb2YgZXF1YWxpdHlUZXN0ID09ICd1bmRlZmluZWQnKSB7CiAgICAgIGVxdWFsaXR5VGVzdCA9IGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICBpZiAoYSA9PT0gYikgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICB2YXIgcmFuZG9tX3NodWZmbGUgPSBzaHVmZmxlKGFycik7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJhbmRvbV9zaHVmZmxlLmxlbmd0aCAtIDE7IGkrKykgewogICAgICBpZiAoZXF1YWxpdHlUZXN0KHJhbmRvbV9zaHVmZmxlW2ldLCByYW5kb21fc2h1ZmZsZVtpICsgMV0pKSB7CiAgICAgICAgLy8gbmVpZ2hib3JzIGFyZSBlcXVhbCwgcGljayBhIG5ldyByYW5kb20gbmVpZ2hib3IgdG8gc3dhcCAobm90IHRoZSBmaXJzdCBvciBsYXN0IGVsZW1lbnQsIHRvIGF2b2lkIGVkZ2UgY2FzZXMpCiAgICAgICAgdmFyIHJhbmRvbV9waWNrID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogKHJhbmRvbV9zaHVmZmxlLmxlbmd0aCAtIDIpKSArIDE7CiAgICAgICAgLy8gdGVzdCB0byBtYWtlIHN1cmUgdGhlIG5ldyBuZWlnaGJvciBpc24ndCBlcXVhbCB0byB0aGUgb2xkIG9uZQogICAgICAgIHdoaWxlICgKICAgICAgICAgIGVxdWFsaXR5VGVzdChyYW5kb21fc2h1ZmZsZVtpICsgMV0sIHJhbmRvbV9zaHVmZmxlW3JhbmRvbV9waWNrXSkgfHwKICAgICAgICAgIChlcXVhbGl0eVRlc3QocmFuZG9tX3NodWZmbGVbaSArIDFdLCByYW5kb21fc2h1ZmZsZVtyYW5kb21fcGljayArIDFdKSB8fCBlcXVhbGl0eVRlc3QocmFuZG9tX3NodWZmbGVbaSArIDFdLCByYW5kb21fc2h1ZmZsZVtyYW5kb21fcGljayAtIDFdKSkKICAgICAgICApIHsKICAgICAgICAgIHJhbmRvbV9waWNrID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogKHJhbmRvbV9zaHVmZmxlLmxlbmd0aCAtIDIpKSArIDE7CiAgICAgICAgfQogICAgICAgIHZhciBuZXdfbmVpZ2hib3IgPSByYW5kb21fc2h1ZmZsZVtyYW5kb21fcGlja107CiAgICAgICAgcmFuZG9tX3NodWZmbGVbcmFuZG9tX3BpY2tdID0gcmFuZG9tX3NodWZmbGVbaSArIDFdOwogICAgICAgIHJhbmRvbV9zaHVmZmxlW2kgKyAxXSA9IG5ld19uZWlnaGJvcjsKICAgICAgfQogICAgfQoKICAgIHJldHVybiByYW5kb21fc2h1ZmZsZTsKICB9CgogIG1vZHVsZS5zaHVmZmxlQWx0ZXJuYXRlR3JvdXBzID0gZnVuY3Rpb24oYXJyX2dyb3VwcywgcmFuZG9tX2dyb3VwX29yZGVyKXsKICAgIGlmKHR5cGVvZiByYW5kb21fZ3JvdXBfb3JkZXIgPT0gJ3VuZGVmaW5lZCcpewogICAgICByYW5kb21fZ3JvdXBfb3JkZXIgPSBmYWxzZTsKICAgIH0KCiAgICB2YXIgbl9ncm91cHMgPSBhcnJfZ3JvdXBzLmxlbmd0aDsKICAgIGlmKG5fZ3JvdXBzID09IDEpewogICAgICBjb25zb2xlLndhcm4oJ2pzUHN5Y2gucmFuZG9taXphdGlvbi5zaHVmZmxlQWx0ZXJuYXRlR3JvdXBzIHdhcyBjYWxsZWQgd2l0aCBvbmx5IG9uZSBncm91cC4gRGVmYXVsdGluZyB0byBzaW1wbGUgc2h1ZmZsZS4nKTsKICAgICAgcmV0dXJuKG1vZHVsZS5zaHVmZmxlKGFycl9ncm91cHNbMF0pKTsKICAgIH0KCiAgICB2YXIgZ3JvdXBfb3JkZXIgPSBbXTsKICAgIGZvcih2YXIgaT0wOyBpPG5fZ3JvdXBzOyBpKyspewogICAgICBncm91cF9vcmRlci5wdXNoKGkpOwogICAgfQogICAgaWYocmFuZG9tX2dyb3VwX29yZGVyKXsKICAgICAgZ3JvdXBfb3JkZXIgPSBtb2R1bGUuc2h1ZmZsZShncm91cF9vcmRlcik7CiAgICB9CgogICAgdmFyIHJhbmRvbWl6ZWRfZ3JvdXBzID0gW107CiAgICB2YXIgbWluX2xlbmd0aCA9IG51bGw7CiAgICBmb3IodmFyIGk9MDsgaTxuX2dyb3VwczsgaSsrKXsKICAgICAgbWluX2xlbmd0aCA9IG1pbl9sZW5ndGggPT09IG51bGwgPyBhcnJfZ3JvdXBzW2ldLmxlbmd0aCA6IE1hdGgubWluKG1pbl9sZW5ndGgsIGFycl9ncm91cHNbaV0ubGVuZ3RoKTsKICAgICAgcmFuZG9taXplZF9ncm91cHMucHVzaChtb2R1bGUuc2h1ZmZsZShhcnJfZ3JvdXBzW2ldKSk7CiAgICB9CgogICAgdmFyIG91dCA9IFtdOwogICAgZm9yKHZhciBpPTA7IGk8bWluX2xlbmd0aDsgaSsrKXsKICAgICAgZm9yKHZhciBqPTA7IGo8Z3JvdXBfb3JkZXIubGVuZ3RoOyBqKyspewogICAgICAgIG91dC5wdXNoKHJhbmRvbWl6ZWRfZ3JvdXBzW2dyb3VwX29yZGVyW2pdXVtpXSkKICAgICAgfQogICAgfQoKICAgIHJldHVybiBvdXQ7CiAgfQoKICBtb2R1bGUuc2FtcGxlV2l0aG91dFJlcGxhY2VtZW50ID0gZnVuY3Rpb24oYXJyLCBzaXplKXsKICAgIGlmKCFBcnJheS5pc0FycmF5KGFycikpewogICAgICBjb25zb2xlLmVycm9yKCJGaXJzdCBhcmd1bWVudCB0byBqc1BzeWNoLnJhbmRvbWl6YXRpb24uc2FtcGxlV2l0aG91dFJlcGxhY2VtZW50KCkgbXVzdCBiZSBhbiBhcnJheSIpCiAgICB9CiAgICAKICAgIGlmIChzaXplID4gYXJyLmxlbmd0aCkgewogICAgICBjb25zb2xlLmVycm9yKCJDYW5ub3QgdGFrZSBhIHNhbXBsZSAiICsKICAgICAgICAibGFyZ2VyIHRoYW4gdGhlIHNpemUgb2YgdGhlIHNldCBvZiBpdGVtcyB0byBzYW1wbGUuIik7CiAgICB9CiAgICByZXR1cm4ganNQc3ljaC5yYW5kb21pemF0aW9uLnNodWZmbGUoYXJyKS5zbGljZSgwLHNpemUpOwogIH0KCiAgbW9kdWxlLnNhbXBsZVdpdGhSZXBsYWNlbWVudCA9IGZ1bmN0aW9uKGFyciwgc2l6ZSwgd2VpZ2h0cykgewogICAgaWYoIUFycmF5LmlzQXJyYXkoYXJyKSl7CiAgICAgIGNvbnNvbGUuZXJyb3IoIkZpcnN0IGFyZ3VtZW50IHRvIGpzUHN5Y2gucmFuZG9taXphdGlvbi5zYW1wbGVXaXRoUmVwbGFjZW1lbnQoKSBtdXN0IGJlIGFuIGFycmF5IikKICAgIH0KCiAgICB2YXIgbm9ybWFsaXplZF93ZWlnaHRzID0gW107CiAgICBpZih0eXBlb2Ygd2VpZ2h0cyAhPT0gJ3VuZGVmaW5lZCcpewogICAgICBpZih3ZWlnaHRzLmxlbmd0aCAhPT0gYXJyLmxlbmd0aCl7CiAgICAgICAgY29uc29sZS5lcnJvcignVGhlIGxlbmd0aCBvZiB0aGUgd2VpZ2h0cyBhcnJheSBtdXN0IGVxdWFsIHRoZSBsZW5ndGggb2YgdGhlIGFycmF5ICcrCiAgICAgICAgJ3RvIGJlIHNhbXBsZWQgZnJvbS4nKTsKICAgICAgfQogICAgICB2YXIgd2VpZ2h0X3N1bSA9IDA7CiAgICAgIGZvcih2YXIgaT0wOyBpPHdlaWdodHMubGVuZ3RoOyBpKyspewogICAgICAgIHdlaWdodF9zdW0gKz0gd2VpZ2h0c1tpXTsKICAgICAgfQogICAgICBmb3IodmFyIGk9MDsgaTx3ZWlnaHRzLmxlbmd0aDsgaSsrKXsKICAgICAgICBub3JtYWxpemVkX3dlaWdodHMucHVzaCggd2VpZ2h0c1tpXSAvIHdlaWdodF9zdW0gKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZm9yKHZhciBpPTA7IGk8YXJyLmxlbmd0aDsgaSsrKXsKICAgICAgICBub3JtYWxpemVkX3dlaWdodHMucHVzaCggMSAvIGFyci5sZW5ndGggKTsKICAgICAgfQogICAgfQoKICAgIHZhciBjdW11bGF0aXZlX3dlaWdodHMgPSBbbm9ybWFsaXplZF93ZWlnaHRzWzBdXTsKICAgIGZvcih2YXIgaT0xOyBpPG5vcm1hbGl6ZWRfd2VpZ2h0cy5sZW5ndGg7IGkrKyl7CiAgICAgIGN1bXVsYXRpdmVfd2VpZ2h0cy5wdXNoKG5vcm1hbGl6ZWRfd2VpZ2h0c1tpXSArIGN1bXVsYXRpdmVfd2VpZ2h0c1tpLTFdKTsKICAgIH0KCiAgICB2YXIgc2FtcCA9IFtdOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzaXplOyBpKyspIHsKICAgICAgdmFyIHJuZCA9IE1hdGgucmFuZG9tKCk7CiAgICAgIHZhciBpbmRleCA9IDA7CiAgICAgIHdoaWxlKHJuZCA+IGN1bXVsYXRpdmVfd2VpZ2h0c1tpbmRleF0pIHsgaW5kZXgrKzsgfQogICAgICBzYW1wLnB1c2goYXJyW2luZGV4XSk7CiAgICB9CiAgICByZXR1cm4gc2FtcDsKICB9CgogIG1vZHVsZS5mYWN0b3JpYWwgPSBmdW5jdGlvbihmYWN0b3JzLCByZXBldGl0aW9ucywgdW5wYWNrKSB7CgogICAgdmFyIGZhY3Rvck5hbWVzID0gT2JqZWN0LmtleXMoZmFjdG9ycyk7CgogICAgdmFyIGZhY3Rvcl9jb21iaW5hdGlvbnMgPSBbXTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZhY3RvcnNbZmFjdG9yTmFtZXNbMF1dLmxlbmd0aDsgaSsrKSB7CiAgICAgIGZhY3Rvcl9jb21iaW5hdGlvbnMucHVzaCh7fSk7CiAgICAgIGZhY3Rvcl9jb21iaW5hdGlvbnNbaV1bZmFjdG9yTmFtZXNbMF1dID0gZmFjdG9yc1tmYWN0b3JOYW1lc1swXV1baV07CiAgICB9CgogICAgZm9yICh2YXIgaSA9IDE7IGkgPCBmYWN0b3JOYW1lcy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgdG9BZGQgPSBmYWN0b3JzW2ZhY3Rvck5hbWVzW2ldXTsKICAgICAgdmFyIG4gPSBmYWN0b3JfY29tYmluYXRpb25zLmxlbmd0aDsKICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBuOyBqKyspIHsKICAgICAgICB2YXIgYmFzZSA9IGZhY3Rvcl9jb21iaW5hdGlvbnNbal07CiAgICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCB0b0FkZC5sZW5ndGg7IGsrKykgewogICAgICAgICAgdmFyIG5ld3BpZWNlID0ge307CiAgICAgICAgICBuZXdwaWVjZVtmYWN0b3JOYW1lc1tpXV0gPSB0b0FkZFtrXTsKICAgICAgICAgIGZhY3Rvcl9jb21iaW5hdGlvbnMucHVzaChPYmplY3QuYXNzaWduKHt9LCBiYXNlLCBuZXdwaWVjZSkpOwogICAgICAgIH0KICAgICAgfQogICAgICBmYWN0b3JfY29tYmluYXRpb25zLnNwbGljZSgwLCBuKTsKICAgIH0KCiAgICByZXBldGl0aW9ucyA9ICh0eXBlb2YgcmVwZXRpdGlvbnMgPT09ICd1bmRlZmluZWQnKSA/IDEgOiByZXBldGl0aW9uczsKICAgIHZhciB3aXRoX3JlcGV0aXRpb25zID0gbW9kdWxlLnJlcGVhdChmYWN0b3JfY29tYmluYXRpb25zLCByZXBldGl0aW9ucywgdW5wYWNrKTsKCiAgICByZXR1cm4gd2l0aF9yZXBldGl0aW9uczsKICB9CgogIG1vZHVsZS5yYW5kb21JRCA9IGZ1bmN0aW9uKGxlbmd0aCl7CiAgICB2YXIgcmVzdWx0ID0gJyc7CiAgICB2YXIgbGVuZ3RoID0gKHR5cGVvZiBsZW5ndGggPT0gJ3VuZGVmaW5lZCcpID8gMzIgOiBsZW5ndGg7CiAgICB2YXIgY2hhcnMgPSAnMDEyMzQ1Njc4OWFiY2RlZmdoamtsbW5vcHFyc3R1dnd4eXonOwogICAgZm9yKHZhciBpID0gMDsgaTxsZW5ndGg7IGkrKyl7CiAgICAgIHJlc3VsdCArPSBjaGFyc1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBjaGFycy5sZW5ndGgpXTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICBmdW5jdGlvbiB1bnBhY2tBcnJheShhcnJheSkgewoKICAgIHZhciBvdXQgPSB7fTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMoYXJyYXlbaV0pOwogICAgICBmb3IgKHZhciBrID0gMDsgayA8IGtleXMubGVuZ3RoOyBrKyspIHsKICAgICAgICBpZiAodHlwZW9mIG91dFtrZXlzW2tdXSA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgIG91dFtrZXlzW2tdXSA9IFtdOwogICAgICAgIH0KICAgICAgICBvdXRba2V5c1trXV0ucHVzaChhcnJheVtpXVtrZXlzW2tdXSk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gb3V0OwogIH0KCiAgZnVuY3Rpb24gc2h1ZmZsZShhcnJheSkgewogICAgdmFyIGNvcHlfYXJyYXkgPSBhcnJheS5zbGljZSgwKTsKICAgIHZhciBtID0gY29weV9hcnJheS5sZW5ndGgsCiAgICAgIHQsIGk7CgogICAgLy8gV2hpbGUgdGhlcmUgcmVtYWluIGVsZW1lbnRzIHRvIHNodWZmbGXigKYKICAgIHdoaWxlIChtKSB7CgogICAgICAvLyBQaWNrIGEgcmVtYWluaW5nIGVsZW1lbnTigKYKICAgICAgaSA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIG0tLSk7CgogICAgICAvLyBBbmQgc3dhcCBpdCB3aXRoIHRoZSBjdXJyZW50IGVsZW1lbnQuCiAgICAgIHQgPSBjb3B5X2FycmF5W21dOwogICAgICBjb3B5X2FycmF5W21dID0gY29weV9hcnJheVtpXTsKICAgICAgY29weV9hcnJheVtpXSA9IHQ7CiAgICB9CgogICAgcmV0dXJuIGNvcHlfYXJyYXk7CiAgfQoKICByZXR1cm4gbW9kdWxlOwoKfSkoKTsKCmpzUHN5Y2gucGx1Z2luQVBJID0gKGZ1bmN0aW9uKCkgewoKICB2YXIgbW9kdWxlID0ge307CgogIC8vIGtleWJvYXJkIGxpc3RlbmVycyAvLwoKICB2YXIga2V5Ym9hcmRfbGlzdGVuZXJzID0gW107CgogIHZhciBoZWxkX2tleXMgPSB7fTsKCiAgdmFyIHJvb3Rfa2V5ZG93bl9saXN0ZW5lciA9IGZ1bmN0aW9uKGUpewogICAgZm9yKHZhciBpPTA7IGk8a2V5Ym9hcmRfbGlzdGVuZXJzLmxlbmd0aDsgaSsrKXsKICAgICAga2V5Ym9hcmRfbGlzdGVuZXJzW2ldLmZuKGUpOwogICAgfQogICAgaGVsZF9rZXlzW2Uua2V5XSA9IHRydWU7CiAgfQogIHZhciByb290X2tleXVwX2xpc3RlbmVyID0gZnVuY3Rpb24oZSl7CiAgICBoZWxkX2tleXNbZS5rZXldID0gZmFsc2U7CiAgfQoKICBtb2R1bGUucmVzZXQgPSBmdW5jdGlvbihyb290X2VsZW1lbnQpewogICAga2V5Ym9hcmRfbGlzdGVuZXJzID0gW107CiAgICBoZWxkX2tleXMgPSB7fTsKICAgIHJvb3RfZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdrZXlkb3duJywgcm9vdF9rZXlkb3duX2xpc3RlbmVyKTsKICAgIHJvb3RfZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdrZXl1cCcsIHJvb3Rfa2V5dXBfbGlzdGVuZXIpOwogIH0KCiAgbW9kdWxlLmNyZWF0ZUtleWJvYXJkRXZlbnRMaXN0ZW5lcnMgPSBmdW5jdGlvbihyb290X2VsZW1lbnQpewogICAgcm9vdF9lbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCByb290X2tleWRvd25fbGlzdGVuZXIpOwogICAgcm9vdF9lbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleXVwJywgcm9vdF9rZXl1cF9saXN0ZW5lcik7CiAgfQoKICBtb2R1bGUuZ2V0S2V5Ym9hcmRSZXNwb25zZSA9IGZ1bmN0aW9uKHBhcmFtZXRlcnMpIHsKCiAgICAvL3BhcmFtZXRlcnMgYXJlOiBjYWxsYmFja19mdW5jdGlvbiwgdmFsaWRfcmVzcG9uc2VzLCBydF9tZXRob2QsIHBlcnNpc3QsIGF1ZGlvX2NvbnRleHQsIGF1ZGlvX2NvbnRleHRfc3RhcnRfdGltZSwgYWxsb3dfaGVsZF9rZXkKCiAgICBwYXJhbWV0ZXJzLnJ0X21ldGhvZCA9ICh0eXBlb2YgcGFyYW1ldGVycy5ydF9tZXRob2QgPT09ICd1bmRlZmluZWQnKSA/ICdwZXJmb3JtYW5jZScgOiBwYXJhbWV0ZXJzLnJ0X21ldGhvZDsKICAgIGlmIChwYXJhbWV0ZXJzLnJ0X21ldGhvZCAhPSAncGVyZm9ybWFuY2UnICYmIHBhcmFtZXRlcnMucnRfbWV0aG9kICE9ICdhdWRpbycpIHsKICAgICAgY29uc29sZS5sb2coJ0ludmFsaWQgUlQgbWV0aG9kIHNwZWNpZmllZCBpbiBnZXRLZXlib2FyZFJlc3BvbnNlLiBEZWZhdWx0aW5nIHRvICJwZXJmb3JtYW5jZSIgbWV0aG9kLicpOwogICAgICBwYXJhbWV0ZXJzLnJ0X21ldGhvZCA9ICdwZXJmb3JtYW5jZSc7CiAgICB9CgogICAgdmFyIHN0YXJ0X3RpbWU7CiAgICBpZiAocGFyYW1ldGVycy5ydF9tZXRob2QgPT0gJ3BlcmZvcm1hbmNlJykgewogICAgICBzdGFydF90aW1lID0gcGVyZm9ybWFuY2Uubm93KCk7CiAgICB9IGVsc2UgaWYgKHBhcmFtZXRlcnMucnRfbWV0aG9kID09PSAnYXVkaW8nKSB7CiAgICAgIHN0YXJ0X3RpbWUgPSBwYXJhbWV0ZXJzLmF1ZGlvX2NvbnRleHRfc3RhcnRfdGltZTsKICAgIH0KCiAgICB2YXIgY2FzZV9zZW5zaXRpdmUgPSAodHlwZW9mIGpzUHN5Y2guaW5pdFNldHRpbmdzKCkuY2FzZV9zZW5zaXRpdmVfcmVzcG9uc2VzID09PSAndW5kZWZpbmVkJykgPyBmYWxzZSA6IGpzUHN5Y2guaW5pdFNldHRpbmdzKCkuY2FzZV9zZW5zaXRpdmVfcmVzcG9uc2VzOwoKICAgIHZhciBsaXN0ZW5lcl9pZDsKCiAgICB2YXIgbGlzdGVuZXJfZnVuY3Rpb24gPSBmdW5jdGlvbihlKSB7CiAgICAgIHZhciBrZXlfdGltZTsKICAgICAgaWYgKHBhcmFtZXRlcnMucnRfbWV0aG9kID09ICdwZXJmb3JtYW5jZScpIHsKICAgICAgICBrZXlfdGltZSA9IHBlcmZvcm1hbmNlLm5vdygpOwogICAgICB9IGVsc2UgaWYgKHBhcmFtZXRlcnMucnRfbWV0aG9kID09PSAnYXVkaW8nKSB7CiAgICAgICAga2V5X3RpbWUgPSBwYXJhbWV0ZXJzLmF1ZGlvX2NvbnRleHQuY3VycmVudFRpbWUKICAgICAgfQogICAgICB2YXIgcnQgPSBrZXlfdGltZSAtIHN0YXJ0X3RpbWU7CgogICAgICAvLyBvdmVyaWRpbmcgdmlhIHBhcmFtZXRlcnMgZm9yIHRlc3RpbmcgcHVycG9zZXMuCiAgICAgIHZhciBtaW5pbXVtX3ZhbGlkX3J0ID0gcGFyYW1ldGVycy5taW5pbXVtX3ZhbGlkX3J0OwogICAgICBpZighbWluaW11bV92YWxpZF9ydCl7CiAgICAgICAgbWluaW11bV92YWxpZF9ydCA9IGpzUHN5Y2guaW5pdFNldHRpbmdzKCkubWluaW11bV92YWxpZF9ydCB8fCAwOwogICAgICB9CgogICAgICB2YXIgcnRfbXMgPSBydDsKICAgICAgaWYgKHBhcmFtZXRlcnMucnRfbWV0aG9kID09ICdhdWRpbycpIHsKICAgICAgICBydF9tcyA9IHJ0X21zICogMTAwMDsKICAgICAgfQogICAgICBpZihydF9tcyA8IG1pbmltdW1fdmFsaWRfcnQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciB2YWxpZF9yZXNwb25zZSA9IGZhbHNlOwogICAgICBpZiAodHlwZW9mIHBhcmFtZXRlcnMudmFsaWRfcmVzcG9uc2VzID09PSAndW5kZWZpbmVkJyl7CiAgICAgICAgdmFsaWRfcmVzcG9uc2UgPSB0cnVlOwogICAgICB9CiAgICAgIGVsc2UgaWYocGFyYW1ldGVycy52YWxpZF9yZXNwb25zZXMgPT0ganNQc3ljaC5BTExfS0VZUykgewogICAgICAgIHZhbGlkX3Jlc3BvbnNlID0gdHJ1ZTsKICAgICAgfSAKICAgICAgZWxzZSBpZihwYXJhbWV0ZXJzLnZhbGlkX3Jlc3BvbnNlcyAhPSBqc1BzeWNoLk5PX0tFWVMpewogICAgICAgIGlmKHBhcmFtZXRlcnMudmFsaWRfcmVzcG9uc2VzLmluY2x1ZGVzKGUua2V5KSl7CiAgICAgICAgICB2YWxpZF9yZXNwb25zZSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGlmKCFjYXNlX3NlbnNpdGl2ZSkgewogICAgICAgICAgdmFyIHZhbGlkX2xvd2VyID0gcGFyYW1ldGVycy52YWxpZF9yZXNwb25zZXMubWFwKGZ1bmN0aW9uKHYpIHtyZXR1cm4gdi50b0xvd2VyQ2FzZSgpO30pOwogICAgICAgICAgdmFyIGtleV9sb3dlciA9IGUua2V5LnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICBpZiAodmFsaWRfbG93ZXIuaW5jbHVkZXMoa2V5X2xvd2VyKSkgewogICAgICAgICAgICB2YWxpZF9yZXNwb25zZSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIAogICAgICAvLyBjaGVjayBpZiBrZXkgd2FzIGFscmVhZHkgaGVsZCBkb3duCiAgICAgIGlmICgoKHR5cGVvZiBwYXJhbWV0ZXJzLmFsbG93X2hlbGRfa2V5ID09PSAndW5kZWZpbmVkJykgfHwgIXBhcmFtZXRlcnMuYWxsb3dfaGVsZF9rZXkpICYmIHZhbGlkX3Jlc3BvbnNlKSB7CiAgICAgICAgaWYgKHR5cGVvZiBoZWxkX2tleXNbZS5rZXldICE9PSAndW5kZWZpbmVkJyAmJiBoZWxkX2tleXNbZS5rZXldID09IHRydWUpIHsKICAgICAgICAgIHZhbGlkX3Jlc3BvbnNlID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGlmICghY2FzZV9zZW5zaXRpdmUgJiYgdHlwZW9mIGhlbGRfa2V5c1tlLmtleS50b0xvd2VyQ2FzZSgpXSAhPT0gJ3VuZGVmaW5lZCcgJiYgaGVsZF9rZXlzW2Uua2V5LnRvTG93ZXJDYXNlKCldID09IHRydWUpIHsKICAgICAgICAgIHZhbGlkX3Jlc3BvbnNlID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodmFsaWRfcmVzcG9uc2UpIHsKICAgICAgICAvLyBpZiB0aGlzIGlzIGEgdmFsaWQgcmVzcG9uc2UsIHRoZW4gd2UgZG9uJ3Qgd2FudCB0aGUga2V5IGV2ZW50IHRvIHRyaWdnZXIgb3RoZXIgYWN0aW9ucwogICAgICAgIC8vIGxpa2Ugc2Nyb2xsaW5nIHZpYSB0aGUgc3BhY2ViYXIuCiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZhciBrZXkgPSBlLmtleTsKICAgICAgICBpZiAoIWNhc2Vfc2Vuc2l0aXZlKSB7CiAgICAgICAgICBrZXkgPSBrZXkudG9Mb3dlckNhc2UoKTsKICAgICAgICB9CiAgICAgICAgcGFyYW1ldGVycy5jYWxsYmFja19mdW5jdGlvbih7CiAgICAgICAgICBrZXk6IGtleSwKICAgICAgICAgIHJ0OiBydF9tcywKICAgICAgICB9KTsKCiAgICAgICAgaWYgKGtleWJvYXJkX2xpc3RlbmVycy5pbmNsdWRlcyhsaXN0ZW5lcl9pZCkpIHsKCiAgICAgICAgICBpZiAoIXBhcmFtZXRlcnMucGVyc2lzdCkgewogICAgICAgICAgICAvLyByZW1vdmUga2V5Ym9hcmQgbGlzdGVuZXIKICAgICAgICAgICAgbW9kdWxlLmNhbmNlbEtleWJvYXJkUmVzcG9uc2UobGlzdGVuZXJfaWQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICAvLyBjcmVhdGUgbGlzdGVuZXIgaWQgb2JqZWN0CiAgICBsaXN0ZW5lcl9pZCA9IHsKICAgICAgdHlwZTogJ2tleWRvd24nLAogICAgICBmbjogbGlzdGVuZXJfZnVuY3Rpb24KICAgIH07CgogICAgLy8gYWRkIHRoaXMga2V5Ym9hcmQgbGlzdGVuZXIgdG8gdGhlIGxpc3Qgb2YgbGlzdGVuZXJzCiAgICBrZXlib2FyZF9saXN0ZW5lcnMucHVzaChsaXN0ZW5lcl9pZCk7CgogICAgcmV0dXJuIGxpc3RlbmVyX2lkOwoKICB9OwoKICBtb2R1bGUuY2FuY2VsS2V5Ym9hcmRSZXNwb25zZSA9IGZ1bmN0aW9uKGxpc3RlbmVyKSB7CiAgICAvLyByZW1vdmUgdGhlIGxpc3RlbmVyIGZyb20gdGhlIGxpc3Qgb2YgbGlzdGVuZXJzCiAgICBpZiAoa2V5Ym9hcmRfbGlzdGVuZXJzLmluY2x1ZGVzKGxpc3RlbmVyKSkgewogICAgICBrZXlib2FyZF9saXN0ZW5lcnMuc3BsaWNlKGtleWJvYXJkX2xpc3RlbmVycy5pbmRleE9mKGxpc3RlbmVyKSwgMSk7CiAgICB9CiAgfTsKCiAgbW9kdWxlLmNhbmNlbEFsbEtleWJvYXJkUmVzcG9uc2VzID0gZnVuY3Rpb24oKSB7CiAgICBrZXlib2FyZF9saXN0ZW5lcnMgPSBbXTsKICB9OwoKICBtb2R1bGUuY29udmVydEtleUNoYXJhY3RlclRvS2V5Q29kZSA9IGZ1bmN0aW9uKGNoYXJhY3RlcikgewogICAgY29uc29sZS53YXJuKCdXYXJuaW5nOiBUaGUganNQc3ljaC5wbHVnaW5BUEkuY29udmVydEtleUNoYXJhY3RlclRvS2V5Q29kZSBmdW5jdGlvbiB3aWxsIGJlIHJlbW92ZWQgaW4gZnV0dXJlIGpzUHN5Y2ggcmVsZWFzZXMuICcrCiAgICAnV2UgcmVjb21tZW5kIHJlbW92aW5nIHRoaXMgZnVuY3Rpb24gYW5kIHVzaW5nIHN0cmluZ3MgdG8gaWRlbnRpZnkvY29tcGFyZSBrZXlzLicpOwogICAgdmFyIGNvZGU7CiAgICBjaGFyYWN0ZXIgPSBjaGFyYWN0ZXIudG9Mb3dlckNhc2UoKTsKICAgIGlmICh0eXBlb2Yga2V5bG9va3VwW2NoYXJhY3Rlcl0gIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIGNvZGUgPSBrZXlsb29rdXBbY2hhcmFjdGVyXTsKICAgIH0KICAgIHJldHVybiBjb2RlOwogIH0KCiAgbW9kdWxlLmNvbnZlcnRLZXlDb2RlVG9LZXlDaGFyYWN0ZXIgPSBmdW5jdGlvbihjb2RlKXsKICAgIGNvbnNvbGUud2FybignV2FybmluZzogVGhlIGpzUHN5Y2gucGx1Z2luQVBJLmNvbnZlcnRLZXlDb2RlVG9LZXlDaGFyYWN0ZXIgZnVuY3Rpb24gd2lsbCBiZSByZW1vdmVkIGluIGZ1dHVyZSBqc1BzeWNoIHJlbGVhc2VzLiAnKwogICAgJ1dlIHJlY29tbWVuZCByZW1vdmluZyB0aGlzIGZ1bmN0aW9uIGFuZCB1c2luZyBzdHJpbmdzIHRvIGlkZW50aWZ5L2NvbXBhcmUga2V5cy4nKTsKICAgIGZvcih2YXIgaSBpbiBPYmplY3Qua2V5cyhrZXlsb29rdXApKXsKICAgICAgaWYoa2V5bG9va3VwW09iamVjdC5rZXlzKGtleWxvb2t1cClbaV1dID09IGNvZGUpewogICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhrZXlsb29rdXApW2ldOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdW5kZWZpbmVkOwogIH0KCiAgbW9kdWxlLmNvbXBhcmVLZXlzID0gZnVuY3Rpb24oa2V5MSwga2V5Mil7CiAgICBpZiAoTnVtYmVyLmlzRmluaXRlKGtleTEpIHx8IE51bWJlci5pc0Zpbml0ZShrZXkyKSkgewogICAgICAvLyBpZiBlaXRoZXIgdmFsdWUgaXMgYSBudW1lcmljIGtleUNvZGUsIHRoZW4gY29udmVydCBib3RoIHRvIG51bWVyaWMga2V5Q29kZSB2YWx1ZXMgYW5kIGNvbXBhcmUgKG1haW50YWluZWQgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5KQogICAgICBpZih0eXBlb2Yga2V5MSA9PSAnc3RyaW5nJykgewogICAgICAgIGtleTEgPSBtb2R1bGUuY29udmVydEtleUNoYXJhY3RlclRvS2V5Q29kZShrZXkxKTsKICAgICAgfQogICAgICBpZih0eXBlb2Yga2V5MiA9PSAnc3RyaW5nJykgewogICAgICAgIGtleTIgPSBtb2R1bGUuY29udmVydEtleUNoYXJhY3RlclRvS2V5Q29kZShrZXkyKTsKICAgICAgfQogICAgICByZXR1cm4ga2V5MSA9PSBrZXkyOwogICAgfSBlbHNlIGlmICh0eXBlb2Yga2V5MSA9PT0gJ3N0cmluZycgJiYgdHlwZW9mIGtleTIgPT09ICdzdHJpbmcnKSB7CiAgICAgIC8vIGlmIGJvdGggdmFsdWVzIGFyZSBzdHJpbmdzLCB0aGVuIGNoZWNrIHdoZXRoZXIgb3Igbm90IGxldHRlciBjYXNlIHNob3VsZCBiZSBjb252ZXJ0ZWQgYmVmb3JlIGNvbXBhcmluZyAoY2FzZV9zZW5zaXRpdmVfcmVzcG9uc2VzIGluIGpzUHN5Y2guaW5pdCkKICAgICAgdmFyIGNhc2Vfc2Vuc2l0aXZlID0gKHR5cGVvZiBqc1BzeWNoLmluaXRTZXR0aW5ncygpLmNhc2Vfc2Vuc2l0aXZlX3Jlc3BvbnNlcyA9PT0gJ3VuZGVmaW5lZCcpID8gZmFsc2UgOiBqc1BzeWNoLmluaXRTZXR0aW5ncygpLmNhc2Vfc2Vuc2l0aXZlX3Jlc3BvbnNlczsKICAgICAgaWYgKGNhc2Vfc2Vuc2l0aXZlKSB7CiAgICAgICAgcmV0dXJuIGtleTEgPT0ga2V5MjsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4ga2V5MS50b0xvd2VyQ2FzZSgpID09IGtleTIudG9Mb3dlckNhc2UoKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChrZXkxID09PSBudWxsICYmICh0eXBlb2Yga2V5MiA9PT0gJ3N0cmluZycgfHwgTnVtYmVyLmlzRmluaXRlKGtleTIpKSB8fCBrZXkyID09PSBudWxsICYmICh0eXBlb2Yga2V5MSA9PT0gJ3N0cmluZycgfHwgTnVtYmVyLmlzRmluaXRlKGtleTEpKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9IGVsc2UgaWYgKGtleTEgPT09IG51bGwgJiYga2V5MiA9PT0gbnVsbCkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGluIGpzUHN5Y2gucGx1Z2luQVBJLmNvbXBhcmVLZXlzOiBhcmd1bWVudHMgbXVzdCBiZSBudW1lcmljIGtleSBjb2Rlcywga2V5IHN0cmluZ3MsIG9yIG51bGwuJyk7CiAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICB9CiAgfQoKICB2YXIga2V5bG9va3VwID0gewogICAgJ2JhY2tzcGFjZSc6IDgsCiAgICAndGFiJzogOSwKICAgICdlbnRlcic6IDEzLAogICAgJ3NoaWZ0JzogMTYsCiAgICAnY3RybCc6IDE3LAogICAgJ2FsdCc6IDE4LAogICAgJ3BhdXNlJzogMTksCiAgICAnY2Fwc2xvY2snOiAyMCwKICAgICdlc2MnOiAyNywKICAgICdzcGFjZSc6IDMyLAogICAgJ3NwYWNlYmFyJzogMzIsCiAgICAnICc6IDMyLAogICAgJ3BhZ2V1cCc6IDMzLAogICAgJ3BhZ2Vkb3duJzogMzQsCiAgICAnZW5kJzogMzUsCiAgICAnaG9tZSc6IDM2LAogICAgJ2xlZnRhcnJvdyc6IDM3LAogICAgJ3VwYXJyb3cnOiAzOCwKICAgICdyaWdodGFycm93JzogMzksCiAgICAnZG93bmFycm93JzogNDAsCiAgICAnaW5zZXJ0JzogNDUsCiAgICAnZGVsZXRlJzogNDYsCiAgICAnMCc6IDQ4LAogICAgJzEnOiA0OSwKICAgICcyJzogNTAsCiAgICAnMyc6IDUxLAogICAgJzQnOiA1MiwKICAgICc1JzogNTMsCiAgICAnNic6IDU0LAogICAgJzcnOiA1NSwKICAgICc4JzogNTYsCiAgICAnOSc6IDU3LAogICAgJ2EnOiA2NSwKICAgICdiJzogNjYsCiAgICAnYyc6IDY3LAogICAgJ2QnOiA2OCwKICAgICdlJzogNjksCiAgICAnZic6IDcwLAogICAgJ2cnOiA3MSwKICAgICdoJzogNzIsCiAgICAnaSc6IDczLAogICAgJ2onOiA3NCwKICAgICdrJzogNzUsCiAgICAnbCc6IDc2LAogICAgJ20nOiA3NywKICAgICduJzogNzgsCiAgICAnbyc6IDc5LAogICAgJ3AnOiA4MCwKICAgICdxJzogODEsCiAgICAncic6IDgyLAogICAgJ3MnOiA4MywKICAgICd0JzogODQsCiAgICAndSc6IDg1LAogICAgJ3YnOiA4NiwKICAgICd3JzogODcsCiAgICAneCc6IDg4LAogICAgJ3knOiA4OSwKICAgICd6JzogOTAsCiAgICAnMG51bXBhZCc6IDk2LAogICAgJzFudW1wYWQnOiA5NywKICAgICcybnVtcGFkJzogOTgsCiAgICAnM251bXBhZCc6IDk5LAogICAgJzRudW1wYWQnOiAxMDAsCiAgICAnNW51bXBhZCc6IDEwMSwKICAgICc2bnVtcGFkJzogMTAyLAogICAgJzdudW1wYWQnOiAxMDMsCiAgICAnOG51bXBhZCc6IDEwNCwKICAgICc5bnVtcGFkJzogMTA1LAogICAgJ211bHRpcGx5JzogMTA2LAogICAgJ3BsdXMnOiAxMDcsCiAgICAnbWludXMnOiAxMDksCiAgICAnZGVjaW1hbCc6IDExMCwKICAgICdkaXZpZGUnOiAxMTEsCiAgICAnZjEnOiAxMTIsCiAgICAnZjInOiAxMTMsCiAgICAnZjMnOiAxMTQsCiAgICAnZjQnOiAxMTUsCiAgICAnZjUnOiAxMTYsCiAgICAnZjYnOiAxMTcsCiAgICAnZjcnOiAxMTgsCiAgICAnZjgnOiAxMTksCiAgICAnZjknOiAxMjAsCiAgICAnZjEwJzogMTIxLAogICAgJ2YxMSc6IDEyMiwKICAgICdmMTInOiAxMjMsCiAgICAnPSc6IDE4NywKICAgICcsJzogMTg4LAogICAgJy4nOiAxOTAsCiAgICAnLyc6IDE5MSwKICAgICdgJzogMTkyLAogICAgJ1snOiAyMTksCiAgICAnXFwnOiAyMjAsCiAgICAnXSc6IDIyMQogIH07CgogIC8vIHRpbWVvdXQgcmVnaXN0cmF0aW9uCgogIHZhciB0aW1lb3V0X2hhbmRsZXJzID0gW107CgogIG1vZHVsZS5zZXRUaW1lb3V0ID0gZnVuY3Rpb24oY2FsbGJhY2ssIGRlbGF5KXsKICAgIHZhciBoYW5kbGUgPSBzZXRUaW1lb3V0KGNhbGxiYWNrLCBkZWxheSk7CiAgICB0aW1lb3V0X2hhbmRsZXJzLnB1c2goaGFuZGxlKTsKICAgIHJldHVybiBoYW5kbGU7CiAgfQoKICBtb2R1bGUuY2xlYXJBbGxUaW1lb3V0cyA9IGZ1bmN0aW9uKCl7CiAgICBmb3IodmFyIGk9MDtpPHRpbWVvdXRfaGFuZGxlcnMubGVuZ3RoOyBpKyspewogICAgICBjbGVhclRpbWVvdXQodGltZW91dF9oYW5kbGVyc1tpXSk7CiAgICB9CiAgICB0aW1lb3V0X2hhbmRsZXJzID0gW107CiAgfQoKICAvLyB2aWRlbyAvLwogICAgdmFyIHZpZGVvX2J1ZmZlcnMgPSB7fQogICAgbW9kdWxlLmdldFZpZGVvQnVmZmVyID0gZnVuY3Rpb24odmlkZW9JRCkgewogICAgICByZXR1cm4gdmlkZW9fYnVmZmVyc1t2aWRlb0lEXQogICAgfQoKICAvLyBhdWRpbyAvLwogIHZhciBjb250ZXh0ID0gbnVsbDsKICB2YXIgYXVkaW9fYnVmZmVycyA9IFtdOwoKICBtb2R1bGUuaW5pdEF1ZGlvID0gZnVuY3Rpb24oKXsKICAgIGNvbnRleHQgPSAoanNQc3ljaC5pbml0U2V0dGluZ3MoKS51c2Vfd2ViYXVkaW8gPT09IHRydWUpID8ganNQc3ljaC53ZWJhdWRpb19jb250ZXh0IDogbnVsbDsKICB9CgogIG1vZHVsZS5hdWRpb0NvbnRleHQgPSBmdW5jdGlvbigpewogICAgaWYoY29udGV4dCAhPT0gbnVsbCl7CiAgICAgIGlmKGNvbnRleHQuc3RhdGUgIT09ICdydW5uaW5nJyl7CiAgICAgICAgY29udGV4dC5yZXN1bWUoKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGNvbnRleHQ7CiAgfQoKICBtb2R1bGUuZ2V0QXVkaW9CdWZmZXIgPSBmdW5jdGlvbihhdWRpb0lEKSB7CgogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCl7CiAgICAgIC8vIGNoZWNrIHdoZXRoZXIgYXVkaW8gZmlsZSBhbHJlYWR5IHByZWxvYWRlZAogICAgICBpZih0eXBlb2YgYXVkaW9fYnVmZmVyc1thdWRpb0lEXSA9PSAndW5kZWZpbmVkJyB8fCBhdWRpb19idWZmZXJzW2F1ZGlvSURdID09ICd0bXAnKXsKICAgICAgICAgLy8gaWYgYXVkaW8gaXMgbm90IGFscmVhZHkgbG9hZGVkLCB0cnkgdG8gbG9hZCBpdAogICAgICAgIGZ1bmN0aW9uIGNvbXBsZXRlKCl7CiAgICAgICAgICByZXNvbHZlKGF1ZGlvX2J1ZmZlcnNbYXVkaW9JRF0pCiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVycm9yKGUpewogICAgICAgICAgcmVqZWN0KGUuZXJyb3IpOwogICAgICAgIH0KICAgICAgICBtb2R1bGUucHJlbG9hZEF1ZGlvKFthdWRpb0lEXSwgY29tcGxldGUsIGZ1bmN0aW9uKCl7fSwgZXJyb3IpCiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gYXVkaW8gaXMgYWxyZWFkeSBsb2FkZWQKICAgICAgICByZXNvbHZlKGF1ZGlvX2J1ZmZlcnNbYXVkaW9JRF0pOwogICAgICB9CiAgICB9KTsKCiAgfQoKICAvLyBwcmVsb2FkaW5nIHN0aW11bGkgLy8KCiAgdmFyIHByZWxvYWRzID0gW107CiAgdmFyIHByZWxvYWRfcmVxdWVzdHMgPSBbXTsKCiAgdmFyIGltZ19jYWNoZSA9IHt9OwoKICBtb2R1bGUucHJlbG9hZEF1ZGlvID0gZnVuY3Rpb24oZmlsZXMsIGNhbGxiYWNrX2NvbXBsZXRlLCBjYWxsYmFja19sb2FkLCBjYWxsYmFja19lcnJvcikgewoKICAgIGZpbGVzID0ganNQc3ljaC51dGlscy5mbGF0dGVuKGZpbGVzKTsKICAgIGZpbGVzID0ganNQc3ljaC51dGlscy51bmlxdWUoZmlsZXMpOwoKICAgIHZhciBuX2xvYWRlZCA9IDA7CiAgICB2YXIgbG9hZGZuID0gKHR5cGVvZiBjYWxsYmFja19sb2FkID09PSAndW5kZWZpbmVkJykgPyBmdW5jdGlvbigpIHt9IDogY2FsbGJhY2tfbG9hZDsKICAgIHZhciBmaW5pc2hmbiA9ICh0eXBlb2YgY2FsbGJhY2tfY29tcGxldGUgPT09ICd1bmRlZmluZWQnKSA/IGZ1bmN0aW9uKCkge30gOiBjYWxsYmFja19jb21wbGV0ZTsKICAgIHZhciBlcnJvcmZuID0gKHR5cGVvZiBjYWxsYmFja19lcnJvciA9PT0gJ3VuZGVmaW5lZCcpID8gZnVuY3Rpb24oKSB7fSA6IGNhbGxiYWNrX2Vycm9yOwoKICAgIGlmKGZpbGVzLmxlbmd0aD09MCl7CiAgICAgIGZpbmlzaGZuKCk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBmdW5jdGlvbiBsb2FkX2F1ZGlvX2ZpbGVfd2ViYXVkaW8oc291cmNlLCBjb3VudCl7CiAgICAgIGNvdW50ID0gY291bnQgfHwgMTsKICAgICAgdmFyIHJlcXVlc3QgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKICAgICAgcmVxdWVzdC5vcGVuKCdHRVQnLCBzb3VyY2UsIHRydWUpOwogICAgICByZXF1ZXN0LnJlc3BvbnNlVHlwZSA9ICdhcnJheWJ1ZmZlcic7CiAgICAgIHJlcXVlc3Qub25sb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgY29udGV4dC5kZWNvZGVBdWRpb0RhdGEocmVxdWVzdC5yZXNwb25zZSwgZnVuY3Rpb24oYnVmZmVyKSB7CiAgICAgICAgICBhdWRpb19idWZmZXJzW3NvdXJjZV0gPSBidWZmZXI7CiAgICAgICAgICBuX2xvYWRlZCsrOwogICAgICAgICAgbG9hZGZuKHNvdXJjZSk7CiAgICAgICAgICBpZihuX2xvYWRlZCA9PSBmaWxlcy5sZW5ndGgpIHsKICAgICAgICAgICAgZmluaXNoZm4oKTsKICAgICAgICAgIH0KICAgICAgICB9LCBmdW5jdGlvbihlKSB7CiAgICAgICAgICBlcnJvcmZuKHtzb3VyY2U6IHNvdXJjZSwgZXJyb3I6IGV9KTsKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXF1ZXN0Lm9uZXJyb3IgPSBmdW5jdGlvbihlKXsKICAgICAgICB2YXIgZXJyID0gZTsKICAgICAgICBpZih0aGlzLnN0YXR1cyA9PSA0MDQpIHsKICAgICAgICAgIGVyciA9ICI0MDQiOwogICAgICAgIH0KICAgICAgICBlcnJvcmZuKHtzb3VyY2U6IHNvdXJjZSwgZXJyb3I6IGVycn0pOwogICAgICB9CiAgICAgIHJlcXVlc3Qub25sb2FkZW5kID0gZnVuY3Rpb24oZSl7CiAgICAgICAgaWYodGhpcy5zdGF0dXMgPT0gNDA0KSB7CiAgICAgICAgICBlcnJvcmZuKHtzb3VyY2U6IHNvdXJjZSwgZXJyb3I6ICI0MDQifSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJlcXVlc3Quc2VuZCgpOwogICAgICBwcmVsb2FkX3JlcXVlc3RzLnB1c2gocmVxdWVzdCk7CiAgICB9CgogICAgZnVuY3Rpb24gbG9hZF9hdWRpb19maWxlX2h0bWw1YXVkaW8oc291cmNlLCBjb3VudCl7CiAgICAgIGNvdW50ID0gY291bnQgfHwgMTsKICAgICAgdmFyIGF1ZGlvID0gbmV3IEF1ZGlvKCk7CiAgICAgIGF1ZGlvLmFkZEV2ZW50TGlzdGVuZXIoJ2NhbnBsYXl0aHJvdWdoJywgZnVuY3Rpb24gaGFuZGxlQ2FuUGxheVRocm91Z2goKXsKICAgICAgICBhdWRpb19idWZmZXJzW3NvdXJjZV0gPSBhdWRpbzsKICAgICAgICBuX2xvYWRlZCsrOwogICAgICAgIGxvYWRmbihzb3VyY2UpOwogICAgICAgIGlmKG5fbG9hZGVkID09IGZpbGVzLmxlbmd0aCl7CiAgICAgICAgICBmaW5pc2hmbigpOwogICAgICAgIH0KICAgICAgICBhdWRpby5yZW1vdmVFdmVudExpc3RlbmVyKCdjYW5wbGF5dGhyb3VnaCcsIGhhbmRsZUNhblBsYXlUaHJvdWdoKTsKICAgICAgfSk7CiAgICAgIGF1ZGlvLmFkZEV2ZW50TGlzdGVuZXIoJ2Vycm9yJywgZnVuY3Rpb24gaGFuZGxlRXJyb3IoZSl7CiAgICAgICAgZXJyb3Jmbih7c291cmNlOiBhdWRpby5zcmMsIGVycm9yOiBlfSk7CiAgICAgICAgYXVkaW8ucmVtb3ZlRXZlbnRMaXN0ZW5lcignZXJyb3InLCBoYW5kbGVFcnJvcik7CiAgICAgIH0pOwogICAgICBhdWRpby5hZGRFdmVudExpc3RlbmVyKCdhYm9ydCcsIGZ1bmN0aW9uIGhhbmRsZUFib3J0KGUpewogICAgICAgIGVycm9yZm4oe3NvdXJjZTogYXVkaW8uc3JjLCBlcnJvcjogZX0pOwogICAgICAgIGF1ZGlvLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2Fib3J0JywgaGFuZGxlQWJvcnQpOwogICAgICB9KTsKICAgICAgYXVkaW8uc3JjID0gc291cmNlOwogICAgICBwcmVsb2FkX3JlcXVlc3RzLnB1c2goYXVkaW8pOwogICAgfQoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZmlsZXMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGJ1ZmZlcklEID0gZmlsZXNbaV07CiAgICAgIGlmICh0eXBlb2YgYXVkaW9fYnVmZmVyc1tidWZmZXJJRF0gIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgbl9sb2FkZWQrKzsKICAgICAgICBsb2FkZm4oYnVmZmVySUQpOwogICAgICAgIGlmKG5fbG9hZGVkID09IGZpbGVzLmxlbmd0aCkgewogICAgICAgICAgZmluaXNoZm4oKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYXVkaW9fYnVmZmVyc1tidWZmZXJJRF0gPSAndG1wJzsKICAgICAgICBpZihtb2R1bGUuYXVkaW9Db250ZXh0KCkgIT09IG51bGwpewogICAgICAgICAgbG9hZF9hdWRpb19maWxlX3dlYmF1ZGlvKGJ1ZmZlcklEKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbG9hZF9hdWRpb19maWxlX2h0bWw1YXVkaW8oYnVmZmVySUQpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICB9CgogIG1vZHVsZS5wcmVsb2FkSW1hZ2VzID0gZnVuY3Rpb24oaW1hZ2VzLCBjYWxsYmFja19jb21wbGV0ZSwgY2FsbGJhY2tfbG9hZCwgY2FsbGJhY2tfZXJyb3IpIHsKCiAgICAvLyBmbGF0dGVuIHRoZSBpbWFnZXMgYXJyYXkKICAgIGltYWdlcyA9IGpzUHN5Y2gudXRpbHMuZmxhdHRlbihpbWFnZXMpOwogICAgaW1hZ2VzID0ganNQc3ljaC51dGlscy51bmlxdWUoaW1hZ2VzKTsKCiAgICB2YXIgbl9sb2FkZWQgPSAwOwogICAgdmFyIGZpbmlzaGZuID0gKHR5cGVvZiBjYWxsYmFja19jb21wbGV0ZSA9PT0gJ3VuZGVmaW5lZCcpID8gZnVuY3Rpb24oKSB7fSA6IGNhbGxiYWNrX2NvbXBsZXRlOwogICAgdmFyIGxvYWRmbiA9ICh0eXBlb2YgY2FsbGJhY2tfbG9hZCA9PT0gJ3VuZGVmaW5lZCcpID8gZnVuY3Rpb24oKSB7fSA6IGNhbGxiYWNrX2xvYWQ7CiAgICB2YXIgZXJyb3JmbiA9ICh0eXBlb2YgY2FsbGJhY2tfZXJyb3IgPT09ICd1bmRlZmluZWQnKSA/IGZ1bmN0aW9uKCkge30gOiBjYWxsYmFja19lcnJvcjsKCiAgICBpZihpbWFnZXMubGVuZ3RoID09PSAwKXsKICAgICAgZmluaXNoZm4oKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGZ1bmN0aW9uIHByZWxvYWRfaW1hZ2Uoc291cmNlKXsKICAgICAgdmFyIGltZyA9IG5ldyBJbWFnZSgpOwoKICAgICAgaW1nLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgIG5fbG9hZGVkKys7CiAgICAgICAgbG9hZGZuKGltZy5zcmMpOwogICAgICAgIGlmIChuX2xvYWRlZCA9PT0gaW1hZ2VzLmxlbmd0aCkgewogICAgICAgICAgZmluaXNoZm4oKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICBpbWcub25lcnJvciA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICBlcnJvcmZuKHtzb3VyY2U6IGltZy5zcmMsIGVycm9yOiBlfSk7CiAgICAgIH0KCiAgICAgIGltZy5zcmMgPSBzb3VyY2U7CgogICAgICBpbWdfY2FjaGVbc291cmNlXSA9IGltZzsKICAgICAgcHJlbG9hZF9yZXF1ZXN0cy5wdXNoKGltZyk7CiAgICB9CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbWFnZXMubGVuZ3RoOyBpKyspIHsKICAgICAgcHJlbG9hZF9pbWFnZShpbWFnZXNbaV0pOwogICAgfQoKICB9OwoKICBtb2R1bGUucHJlbG9hZFZpZGVvID0gZnVuY3Rpb24odmlkZW8sIGNhbGxiYWNrX2NvbXBsZXRlLCBjYWxsYmFja19sb2FkLCBjYWxsYmFja19lcnJvcikgewoKICAgICAgLy8gZmxhdHRlbiB0aGUgdmlkZW8gYXJyYXkKICAgICAgdmlkZW8gPSBqc1BzeWNoLnV0aWxzLmZsYXR0ZW4odmlkZW8pOwogICAgICB2aWRlbyA9IGpzUHN5Y2gudXRpbHMudW5pcXVlKHZpZGVvKTsKCiAgICAgIHZhciBuX2xvYWRlZCA9IDA7CiAgICAgIHZhciBmaW5pc2hmbiA9ICFjYWxsYmFja19jb21wbGV0ZSA/IGZ1bmN0aW9uKCkge30gOiBjYWxsYmFja19jb21wbGV0ZTsKICAgICAgdmFyIGxvYWRmbiA9ICFjYWxsYmFja19sb2FkID8gZnVuY3Rpb24oKSB7fSA6IGNhbGxiYWNrX2xvYWQ7CiAgICAgIHZhciBlcnJvcmZuID0gKHR5cGVvZiBjYWxsYmFja19lcnJvciA9PT0gJ3VuZGVmaW5lZCcpID8gZnVuY3Rpb24oKSB7fSA6IGNhbGxiYWNrX2Vycm9yOwoKICAgICAgaWYodmlkZW8ubGVuZ3RoPT09MCl7CiAgICAgICAgICBmaW5pc2hmbigpOwogICAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBmdW5jdGlvbiBwcmVsb2FkX3ZpZGVvKHNvdXJjZSwgY291bnQpewogICAgICAgIGNvdW50ID0gY291bnQgfHwgMTsKICAgICAgICAvL2Jhc2VkIG9uIG9wdGlvbiA0IGhlcmU6IGh0dHA6Ly9kaW5icm9yLmRrL2Jsb2cvaG93LXRvLXByZWxvYWQtZW50aXJlLWh0bWw1LXZpZGVvLWJlZm9yZS1wbGF5LXNvbHZlZC8KICAgICAgICB2YXIgcmVxdWVzdCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgICAgIHJlcXVlc3Qub3BlbignR0VUJywgc291cmNlLCB0cnVlKTsKICAgICAgICByZXF1ZXN0LnJlc3BvbnNlVHlwZSA9ICdibG9iJzsKICAgICAgICByZXF1ZXN0Lm9ubG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKHRoaXMuc3RhdHVzID09PSAyMDAgfHwgdGhpcy5zdGF0dXMgPT09IDApIHsKICAgICAgICAgICAgdmFyIHZpZGVvQmxvYiA9IHRoaXMucmVzcG9uc2U7CiAgICAgICAgICAgIHZpZGVvX2J1ZmZlcnNbc291cmNlXSA9IFVSTC5jcmVhdGVPYmplY3RVUkwodmlkZW9CbG9iKTsgLy8gSUUxMCsKICAgICAgICAgICAgbl9sb2FkZWQrKzsKICAgICAgICAgICAgbG9hZGZuKHNvdXJjZSk7CiAgICAgICAgICAgIGlmIChuX2xvYWRlZCA9PT0gdmlkZW8ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgZmluaXNoZm4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgcmVxdWVzdC5vbmVycm9yID0gZnVuY3Rpb24oZSl7CiAgICAgICAgICB2YXIgZXJyID0gZTsKICAgICAgICAgIGlmKHRoaXMuc3RhdHVzID09IDQwNCkgewogICAgICAgICAgICBlcnIgPSAiNDA0IjsKICAgICAgICAgIH0KICAgICAgICAgIGVycm9yZm4oe3NvdXJjZTogc291cmNlLCBlcnJvcjogZXJyfSk7CiAgICAgICAgfQogICAgICAgIHJlcXVlc3Qub25sb2FkZW5kID0gZnVuY3Rpb24oZSl7CiAgICAgICAgICBpZih0aGlzLnN0YXR1cyA9PSA0MDQpIHsKICAgICAgICAgICAgZXJyb3Jmbih7c291cmNlOiBzb3VyY2UsIGVycm9yOiAiNDA0In0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXF1ZXN0LnNlbmQoKTsKICAgICAgICBwcmVsb2FkX3JlcXVlc3RzLnB1c2gocmVxdWVzdCk7CiAgICAgIH0KCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdmlkZW8ubGVuZ3RoOyBpKyspIHsKICAgICAgICBwcmVsb2FkX3ZpZGVvKHZpZGVvW2ldKTsKICAgICAgfQoKICB9OwoKICBtb2R1bGUucmVnaXN0ZXJQcmVsb2FkID0gZnVuY3Rpb24ocGx1Z2luX25hbWUsIHBhcmFtZXRlciwgbWVkaWFfdHlwZSkgewogICAgaWYgKFsnYXVkaW8nLCAnaW1hZ2UnLCAndmlkZW8nXS5pbmRleE9mKG1lZGlhX3R5cGUpPT09LTEpIHsKICAgICAgY29uc29sZS5lcnJvcignSW52YWxpZCBtZWRpYV90eXBlIHBhcmFtZXRlciBmb3IganNQc3ljaC5wbHVnaW5BUEkucmVnaXN0ZXJQcmVsb2FkLiBQbGVhc2UgY2hlY2sgdGhlIHBsdWdpbiBmaWxlLicpOwogICAgfQoKICAgIHZhciBwcmVsb2FkID0gewogICAgICBwbHVnaW46IHBsdWdpbl9uYW1lLAogICAgICBwYXJhbWV0ZXI6IHBhcmFtZXRlciwKICAgICAgbWVkaWFfdHlwZTogbWVkaWFfdHlwZQogICAgfQoKICAgIHByZWxvYWRzLnB1c2gocHJlbG9hZCk7CiAgfQoKICBtb2R1bGUuZ2V0QXV0b1ByZWxvYWRMaXN0ID0gZnVuY3Rpb24odGltZWxpbmVfZGVzY3JpcHRpb24pewoKICAgIGZ1bmN0aW9uIGdldFRyaWFsc09mVHlwZUZyb21UaW1lbGluZURlc2NyaXB0aW9uKHRkLCB0YXJnZXRfdHlwZSwgaW5oZXJpdGVkX3R5cGUpewogICAgICB2YXIgdHJpYWxzID0gW107CgogICAgICBmb3IodmFyIGk9MDsgaTx0ZC5sZW5ndGg7IGkrKyl7CiAgICAgICAgdmFyIG5vZGUgPSB0ZFtpXTsKICAgICAgICBpZihBcnJheS5pc0FycmF5KG5vZGUudGltZWxpbmUpKXsKICAgICAgICAgIGlmKHR5cGVvZiBub2RlLnR5cGUgIT09ICd1bmRlZmluZWQnKXsKICAgICAgICAgICAgaW5oZXJpdGVkX3R5cGUgPSBub2RlLnR5cGU7CiAgICAgICAgICB9CiAgICAgICAgICB0cmlhbHMgPSB0cmlhbHMuY29uY2F0KGdldFRyaWFsc09mVHlwZUZyb21UaW1lbGluZURlc2NyaXB0aW9uKG5vZGUudGltZWxpbmUsIHRhcmdldF90eXBlLCBpbmhlcml0ZWRfdHlwZSkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZih0eXBlb2Ygbm9kZS50eXBlICE9PSAndW5kZWZpbmVkJyAmJiBub2RlLnR5cGUgPT0gdGFyZ2V0X3R5cGUpewogICAgICAgICAgICB0cmlhbHMucHVzaChub2RlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmKHR5cGVvZiBub2RlLnR5cGUgPT0gJ3VuZGVmaW5lZCcgJiYgaW5oZXJpdGVkX3R5cGUgPT0gdGFyZ2V0X3R5cGUpewogICAgICAgICAgICB0cmlhbHMucHVzaChPYmplY3QuYXNzaWduKHt9LCB7dHlwZTogdGFyZ2V0X3R5cGV9LCBub2RlKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdHJpYWxzOwogICAgfQoKICAgIGlmKHR5cGVvZiB0aW1lbGluZV9kZXNjcmlwdGlvbiA9PSAndW5kZWZpbmVkJyl7CiAgICAgIHRpbWVsaW5lX2Rlc2NyaXB0aW9uID0ganNQc3ljaC5pbml0U2V0dGluZ3MoKS50aW1lbGluZTsKICAgIH0KCiAgICAvLyBsaXN0IG9mIGl0ZW1zIHRvIHByZWxvYWQKICAgIHZhciBpbWFnZXMgPSBbXTsKICAgIHZhciBhdWRpbyA9IFtdOwogICAgdmFyIHZpZGVvID0gW107CgogICAgLy8gY29uc3RydWN0IGxpc3QKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJlbG9hZHMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIHR5cGUgPSBwcmVsb2Fkc1tpXS5wbHVnaW47CiAgICAgIHZhciBwYXJhbSA9IHByZWxvYWRzW2ldLnBhcmFtZXRlcjsKICAgICAgdmFyIG1lZGlhID0gcHJlbG9hZHNbaV0ubWVkaWFfdHlwZTsKCiAgICAgIHZhciB0cmlhbHMgPSBnZXRUcmlhbHNPZlR5cGVGcm9tVGltZWxpbmVEZXNjcmlwdGlvbih0aW1lbGluZV9kZXNjcmlwdGlvbiwgdHlwZSk7CiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgdHJpYWxzLmxlbmd0aDsgaisrKSB7CgogICAgICAgIGlmICh0eXBlb2YgdHJpYWxzW2pdW3BhcmFtXSA9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgY29uc29sZS53YXJuKCJqc1BzeWNoIGZhaWxlZCB0byBhdXRvIHByZWxvYWQgb25lIG9yIG1vcmUgZmlsZXM6Iik7CiAgICAgICAgICBjb25zb2xlLndhcm4oIm5vIHBhcmFtZXRlciBjYWxsZWQgIitwYXJhbSsiIGluIHBsdWdpbiAiK3R5cGUpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHRyaWFsc1tqXVtwYXJhbV0gIT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIGlmIChtZWRpYSA9PT0gJ2ltYWdlJykgewogICAgICAgICAgICBpbWFnZXMgPSBpbWFnZXMuY29uY2F0KGpzUHN5Y2gudXRpbHMuZmxhdHRlbihbdHJpYWxzW2pdW3BhcmFtXV0pKTsKICAgICAgICAgIH0gZWxzZSBpZiAobWVkaWEgPT09ICdhdWRpbycpIHsKICAgICAgICAgICAgYXVkaW8gPSBhdWRpby5jb25jYXQoanNQc3ljaC51dGlscy5mbGF0dGVuKFt0cmlhbHNbal1bcGFyYW1dXSkpOwogICAgICAgICAgfSBlbHNlIGlmIChtZWRpYSA9PT0gJ3ZpZGVvJykgewogICAgICAgICAgICB2aWRlbyA9IHZpZGVvLmNvbmNhdChqc1BzeWNoLnV0aWxzLmZsYXR0ZW4oW3RyaWFsc1tqXVtwYXJhbV1dKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaW1hZ2VzID0ganNQc3ljaC51dGlscy51bmlxdWUoanNQc3ljaC51dGlscy5mbGF0dGVuKGltYWdlcykpOwogICAgYXVkaW8gID0ganNQc3ljaC51dGlscy51bmlxdWUoanNQc3ljaC51dGlscy5mbGF0dGVuKGF1ZGlvKSk7CiAgICB2aWRlbyAgPSBqc1BzeWNoLnV0aWxzLnVuaXF1ZShqc1BzeWNoLnV0aWxzLmZsYXR0ZW4odmlkZW8pKTsKCiAgICAvLyByZW1vdmUgYW55IG51bGxzIGZhbHNlIHZhbHVlcwogICAgaW1hZ2VzID0gaW1hZ2VzLmZpbHRlcihmdW5jdGlvbih4KSB7IHJldHVybiB4ICE9IGZhbHNlICYmIHggIT0gbnVsbH0pCiAgICBhdWRpbyA9IGF1ZGlvLmZpbHRlcihmdW5jdGlvbih4KSB7IHJldHVybiB4ICE9IGZhbHNlICYmIHggIT0gbnVsbH0pCiAgICB2aWRlbyA9IHZpZGVvLmZpbHRlcihmdW5jdGlvbih4KSB7IHJldHVybiB4ICE9IGZhbHNlICYmIHggIT0gbnVsbH0pCgogICAgcmV0dXJuIHsKICAgICAgaW1hZ2VzLCBhdWRpbywgdmlkZW8KICAgIH0KICB9CgogIG1vZHVsZS5jYW5jZWxQcmVsb2FkcyA9IGZ1bmN0aW9uKCkgewogICAgZm9yKHZhciBpPTA7aTxwcmVsb2FkX3JlcXVlc3RzLmxlbmd0aDsgaSsrKXsKICAgICAgcHJlbG9hZF9yZXF1ZXN0c1tpXS5vbmxvYWQgPSBmdW5jdGlvbigpIHt9OwogICAgICBwcmVsb2FkX3JlcXVlc3RzW2ldLm9uZXJyb3IgPSBmdW5jdGlvbigpIHt9OwogICAgICBwcmVsb2FkX3JlcXVlc3RzW2ldLm9uY2FucGxheXRocm91Z2ggPSBmdW5jdGlvbigpIHt9OwogICAgICBwcmVsb2FkX3JlcXVlc3RzW2ldLm9uYWJvcnQgPSBmdW5jdGlvbigpIHt9OwogICAgfQogICAgcHJlbG9hZF9yZXF1ZXN0cyA9IFtdOwogIH0KCiAgLyoqCiAgICogQWxsb3dzIGNvbW11bmljYXRpb24gd2l0aCB1c2VyIGhhcmR3YXJlIHRocm91Z2ggb3VyIGN1c3RvbSBHb29nbGUgQ2hyb21lIGV4dGVuc2lvbiArIG5hdGl2ZSBDKysgcHJvZ3JhbQogICAqIEBwYXJhbQkJe29iamVjdH0JbWVzcwlUaGUgbWVzc2FnZSB0byBiZSBwYXNzZWQgdG8gb3VyIGV4dGVuc2lvbiwgc2VlIGl0cyBkb2N1bWVudGF0aW9uIGZvciB0aGUgZXhwZWN0ZWQgbWVtYmVycyBvZiB0aGlzIG9iamVjdC4KICAgKiBAYXV0aG9yCURhbmllbCBSaXZhcwogICAqCiAgICovCiAgbW9kdWxlLmhhcmR3YXJlID0gZnVuY3Rpb24gaGFyZHdhcmUobWVzcyl7CgkgIC8vc2luY2UgQ2hyb21lIGV4dGVuc2lvbiBjb250ZW50LXNjcmlwdHMgZG8gbm90IHNoYXJlIHRoZSBqYXZhc2NyaXB0IGVudmlyb25tZW50IHdpdGggdGhlIHBhZ2Ugc2NyaXB0IHRoYXQgbG9hZGVkIGpzcHN5Y2gsCgkgIC8vd2Ugd2lsbCBuZWVkIHRvIHVzZSBoYWNreSBtZXRob2RzIGxpa2UgY29tbXVuaWNhdGluZyB0aHJvdWdoIERPTSBldmVudHMuCgkgIHZhciBqc3BzeWNoRXZ0ID0gbmV3IEN1c3RvbUV2ZW50KCdqc3BzeWNoJywge2RldGFpbDogbWVzc30pOwoJICBkb2N1bWVudC5kaXNwYXRjaEV2ZW50KGpzcHN5Y2hFdnQpOwoJICAvL0FuZCB2b2lsYSEgaXQgd2lsbCBiZSB0aGUgam9iIG9mIHRoZSBjb250ZW50IHNjcmlwdCBpbmplY3RlZCBieSB0aGUgZXh0ZW5zaW9uIHRvIGxpc3RlbiBmb3IgdGhlIGV2ZW50IGFuZCBkbyB0aGUgYXBwcm9wcmlhdGUgYWN0aW9ucy4KICB9OwoKICAvKioge2Jvb2xlYW59IEluZGljYXRlcyB3aGV0aGVyIHRoaXMgaW5zdGFuY2Ugb2YganNwc3ljaCBoYXMgb3BlbmVkIGEgaGFyZHdhcmUgY29ubmVjdGlvbiB0aHJvdWdoIG91ciBicm93c2VyIGV4dGVuc2lvbiAqLwogIG1vZHVsZS5oYXJkd2FyZUNvbm5lY3RlZCA9IGZhbHNlOwoKCiAgLy9pdCBtaWdodCBiZSB1c2VmdWwgdG8gb3BlbiB1cCBhIGxpbmUgb2YgY29tbXVuaWNhdGlvbiBmcm9tIHRoZSBleHRlbnNpb24gYmFjayB0byB0aGlzIHBhZ2Ugc2NyaXB0LAogIC8vYWdhaW4sIHRoaXMgd2lsbCBoYXZlIHRvIHBhc3MgdGhyb3VnaCBET00gZXZlbnRzLiBGb3Igbm93IHNwZWVkIGlzIG9mIG5vIGNvbmNlcm4gc28gSSB3aWxsIHVzZSBqUXVlcnkKICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJqc3BzeWNoLWFjdGl2YXRlIiwgZnVuY3Rpb24oZXZ0KXsKCSAgbW9kdWxlLmhhcmR3YXJlQ29ubmVjdGVkID0gdHJ1ZTsKICB9KQoKCgogIHJldHVybiBtb2R1bGU7Cn0pKCk7CgovLyBtZXRob2RzIHVzZWQgaW4gbXVsdGlwbGUgbW9kdWxlcyAvLwpqc1BzeWNoLnV0aWxzID0gKGZ1bmN0aW9uKCkgewoKCXZhciBtb2R1bGUgPSB7fTsKCgltb2R1bGUuZmxhdHRlbiA9IGZ1bmN0aW9uKGFyciwgb3V0KSB7CgkJb3V0ID0gKHR5cGVvZiBvdXQgPT09ICd1bmRlZmluZWQnKSA/IFtdIDogb3V0OwoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7CgkJCWlmIChBcnJheS5pc0FycmF5KGFycltpXSkpIHsKCQkJCW1vZHVsZS5mbGF0dGVuKGFycltpXSwgb3V0KTsKCQkJfSBlbHNlIHsKCQkJCW91dC5wdXNoKGFycltpXSk7CgkJCX0KCQl9CgkJcmV0dXJuIG91dDsKCX0KCgltb2R1bGUudW5pcXVlID0gZnVuY3Rpb24oYXJyKSB7CgkJdmFyIG91dCA9IFtdOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7CgkJCWlmIChhcnIuaW5kZXhPZihhcnJbaV0pID09IGkpIHsKCQkJCW91dC5wdXNoKGFycltpXSk7CgkJCX0KCQl9CgkJcmV0dXJuIG91dDsKCX0KCgltb2R1bGUuZGVlcENvcHkgPSBmdW5jdGlvbihvYmopIHsKICAgIGlmKCFvYmopIHJldHVybiBvYmo7CiAgICB2YXIgb3V0OwogICAgaWYoQXJyYXkuaXNBcnJheShvYmopKXsKICAgICAgb3V0ID0gW107CiAgICAgIGZvcih2YXIgaSA9IDA7IGk8b2JqLmxlbmd0aDsgaSsrKXsKICAgICAgICBvdXQucHVzaChtb2R1bGUuZGVlcENvcHkob2JqW2ldKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIG91dDsKICAgIH0gZWxzZSBpZih0eXBlb2Ygb2JqID09PSAnb2JqZWN0Jyl7CiAgICAgIG91dCA9IHt9OwogICAgICBmb3IodmFyIGtleSBpbiBvYmopewogICAgICAgIGlmKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKXsKICAgICAgICAgIG91dFtrZXldID0gbW9kdWxlLmRlZXBDb3B5KG9ialtrZXldKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG91dDsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBvYmo7CiAgICB9CiAgfQoKCXJldHVybiBtb2R1bGU7Cn0pKCk7CgovLyBwb2x5ZmlsbCBmb3IgT2JqZWN0LmFzc2lnbiB0byBzdXBwb3J0IElFCmlmICh0eXBlb2YgT2JqZWN0LmFzc2lnbiAhPSAnZnVuY3Rpb24nKSB7CiAgT2JqZWN0LmFzc2lnbiA9IGZ1bmN0aW9uICh0YXJnZXQsIHZhckFyZ3MpIHsgLy8gLmxlbmd0aCBvZiBmdW5jdGlvbiBpcyAyCiAgICAndXNlIHN0cmljdCc7CiAgICBpZiAodGFyZ2V0ID09IG51bGwpIHsgLy8gVHlwZUVycm9yIGlmIHVuZGVmaW5lZCBvciBudWxsCiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjb252ZXJ0IHVuZGVmaW5lZCBvciBudWxsIHRvIG9iamVjdCcpOwogICAgfQoKICAgIHZhciB0byA9IE9iamVjdCh0YXJnZXQpOwoKICAgIGZvciAodmFyIGluZGV4ID0gMTsgaW5kZXggPCBhcmd1bWVudHMubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgIHZhciBuZXh0U291cmNlID0gYXJndW1lbnRzW2luZGV4XTsKCiAgICAgIGlmIChuZXh0U291cmNlICE9IG51bGwpIHsgLy8gU2tpcCBvdmVyIGlmIHVuZGVmaW5lZCBvciBudWxsCiAgICAgICAgZm9yICh2YXIgbmV4dEtleSBpbiBuZXh0U291cmNlKSB7CiAgICAgICAgICAvLyBBdm9pZCBidWdzIHdoZW4gaGFzT3duUHJvcGVydHkgaXMgc2hhZG93ZWQKICAgICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwobmV4dFNvdXJjZSwgbmV4dEtleSkpIHsKICAgICAgICAgICAgdG9bbmV4dEtleV0gPSBuZXh0U291cmNlW25leHRLZXldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIHRvOwogIH07Cn0KCi8vIHBvbHlmaWxsIGZvciBBcnJheS5pbmNsdWRlcyB0byBzdXBwb3J0IElFCmlmICghQXJyYXkucHJvdG90eXBlLmluY2x1ZGVzKSB7CiAgQXJyYXkucHJvdG90eXBlLmluY2x1ZGVzID0gZnVuY3Rpb24oc2VhcmNoRWxlbWVudCAvKiwgZnJvbUluZGV4Ki8pIHsKICAgICd1c2Ugc3RyaWN0JzsKICAgIGlmICh0aGlzID09IG51bGwpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQXJyYXkucHJvdG90eXBlLmluY2x1ZGVzIGNhbGxlZCBvbiBudWxsIG9yIHVuZGVmaW5lZCcpOwogICAgfQoKICAgIHZhciBPID0gT2JqZWN0KHRoaXMpOwogICAgdmFyIGxlbiA9IHBhcnNlSW50KE8ubGVuZ3RoLCAxMCkgfHwgMDsKICAgIGlmIChsZW4gPT09IDApIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgdmFyIG4gPSBwYXJzZUludChhcmd1bWVudHNbMV0sIDEwKSB8fCAwOwogICAgdmFyIGs7CiAgICBpZiAobiA+PSAwKSB7CiAgICAgIGsgPSBuOwogICAgfSBlbHNlIHsKICAgICAgayA9IGxlbiArIG47CiAgICAgIGlmIChrIDwgMCkge2sgPSAwO30KICAgIH0KICAgIHZhciBjdXJyZW50RWxlbWVudDsKICAgIHdoaWxlIChrIDwgbGVuKSB7CiAgICAgIGN1cnJlbnRFbGVtZW50ID0gT1trXTsKICAgICAgaWYgKHNlYXJjaEVsZW1lbnQgPT09IGN1cnJlbnRFbGVtZW50IHx8CiAgICAgICAgIChzZWFyY2hFbGVtZW50ICE9PSBzZWFyY2hFbGVtZW50ICYmIGN1cnJlbnRFbGVtZW50ICE9PSBjdXJyZW50RWxlbWVudCkpIHsgLy8gTmFOICE9PSBOYU4KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBrKys7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfTsKfQoKLy8gcG9seWZpbGwgZm9yIEFycmF5LmlzQXJyYXkKaWYgKCFBcnJheS5pc0FycmF5KSB7CiAgQXJyYXkuaXNBcnJheSA9IGZ1bmN0aW9uKGFyZykgewogICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChhcmcpID09PSAnW29iamVjdCBBcnJheV0nOwogIH07Cn0K"></script>
<script src="data:application/javascript; charset=utf-8;base64,LyoqCiAqIGpzcHN5Y2gtaHRtbC1rZXlib2FyZC1yZXNwb25zZQogKiBKb3NoIGRlIExlZXV3CiAqCiAqIHBsdWdpbiBmb3IgZGlzcGxheWluZyBhIHN0aW11bHVzIGFuZCBnZXR0aW5nIGEga2V5Ym9hcmQgcmVzcG9uc2UKICoKICogZG9jdW1lbnRhdGlvbjogZG9jcy5qc3BzeWNoLm9yZwogKgogKiovCgoKanNQc3ljaC5wbHVnaW5zWyJodG1sLWtleWJvYXJkLXJlc3BvbnNlIl0gPSAoZnVuY3Rpb24oKSB7CgogIHZhciBwbHVnaW4gPSB7fTsKCiAgcGx1Z2luLmluZm8gPSB7CiAgICBuYW1lOiAnaHRtbC1rZXlib2FyZC1yZXNwb25zZScsCiAgICBkZXNjcmlwdGlvbjogJycsCiAgICBwYXJhbWV0ZXJzOiB7CiAgICAgIHN0aW11bHVzOiB7CiAgICAgICAgdHlwZToganNQc3ljaC5wbHVnaW5zLnBhcmFtZXRlclR5cGUuSFRNTF9TVFJJTkcsCiAgICAgICAgcHJldHR5X25hbWU6ICdTdGltdWx1cycsCiAgICAgICAgZGVmYXVsdDogdW5kZWZpbmVkLAogICAgICAgIGRlc2NyaXB0aW9uOiAnVGhlIEhUTUwgc3RyaW5nIHRvIGJlIGRpc3BsYXllZCcKICAgICAgfSwKICAgICAgY2hvaWNlczogewogICAgICAgIHR5cGU6IGpzUHN5Y2gucGx1Z2lucy5wYXJhbWV0ZXJUeXBlLktFWSwKICAgICAgICBhcnJheTogdHJ1ZSwKICAgICAgICBwcmV0dHlfbmFtZTogJ0Nob2ljZXMnLAogICAgICAgIGRlZmF1bHQ6IGpzUHN5Y2guQUxMX0tFWVMsCiAgICAgICAgZGVzY3JpcHRpb246ICdUaGUga2V5cyB0aGUgc3ViamVjdCBpcyBhbGxvd2VkIHRvIHByZXNzIHRvIHJlc3BvbmQgdG8gdGhlIHN0aW11bHVzLicKICAgICAgfSwKICAgICAgcHJvbXB0OiB7CiAgICAgICAgdHlwZToganNQc3ljaC5wbHVnaW5zLnBhcmFtZXRlclR5cGUuU1RSSU5HLAogICAgICAgIHByZXR0eV9uYW1lOiAnUHJvbXB0JywKICAgICAgICBkZWZhdWx0OiBudWxsLAogICAgICAgIGRlc2NyaXB0aW9uOiAnQW55IGNvbnRlbnQgaGVyZSB3aWxsIGJlIGRpc3BsYXllZCBiZWxvdyB0aGUgc3RpbXVsdXMuJwogICAgICB9LAogICAgICBzdGltdWx1c19kdXJhdGlvbjogewogICAgICAgIHR5cGU6IGpzUHN5Y2gucGx1Z2lucy5wYXJhbWV0ZXJUeXBlLklOVCwKICAgICAgICBwcmV0dHlfbmFtZTogJ1N0aW11bHVzIGR1cmF0aW9uJywKICAgICAgICBkZWZhdWx0OiBudWxsLAogICAgICAgIGRlc2NyaXB0aW9uOiAnSG93IGxvbmcgdG8gaGlkZSB0aGUgc3RpbXVsdXMuJwogICAgICB9LAogICAgICB0cmlhbF9kdXJhdGlvbjogewogICAgICAgIHR5cGU6IGpzUHN5Y2gucGx1Z2lucy5wYXJhbWV0ZXJUeXBlLklOVCwKICAgICAgICBwcmV0dHlfbmFtZTogJ1RyaWFsIGR1cmF0aW9uJywKICAgICAgICBkZWZhdWx0OiBudWxsLAogICAgICAgIGRlc2NyaXB0aW9uOiAnSG93IGxvbmcgdG8gc2hvdyB0cmlhbCBiZWZvcmUgaXQgZW5kcy4nCiAgICAgIH0sCiAgICAgIHJlc3BvbnNlX2VuZHNfdHJpYWw6IHsKICAgICAgICB0eXBlOiBqc1BzeWNoLnBsdWdpbnMucGFyYW1ldGVyVHlwZS5CT09MLAogICAgICAgIHByZXR0eV9uYW1lOiAnUmVzcG9uc2UgZW5kcyB0cmlhbCcsCiAgICAgICAgZGVmYXVsdDogdHJ1ZSwKICAgICAgICBkZXNjcmlwdGlvbjogJ0lmIHRydWUsIHRyaWFsIHdpbGwgZW5kIHdoZW4gc3ViamVjdCBtYWtlcyBhIHJlc3BvbnNlLicKICAgICAgfSwKCiAgICB9CiAgfQoKICBwbHVnaW4udHJpYWwgPSBmdW5jdGlvbihkaXNwbGF5X2VsZW1lbnQsIHRyaWFsKSB7CgogICAgdmFyIG5ld19odG1sID0gJzxkaXYgaWQ9ImpzcHN5Y2gtaHRtbC1rZXlib2FyZC1yZXNwb25zZS1zdGltdWx1cyI+Jyt0cmlhbC5zdGltdWx1cysnPC9kaXY+JzsKCiAgICAvLyBhZGQgcHJvbXB0CiAgICBpZih0cmlhbC5wcm9tcHQgIT09IG51bGwpewogICAgICBuZXdfaHRtbCArPSB0cmlhbC5wcm9tcHQ7CiAgICB9CgogICAgLy8gZHJhdwogICAgZGlzcGxheV9lbGVtZW50LmlubmVySFRNTCA9IG5ld19odG1sOwoKICAgIC8vIHN0b3JlIHJlc3BvbnNlCiAgICB2YXIgcmVzcG9uc2UgPSB7CiAgICAgIHJ0OiBudWxsLAogICAgICBrZXk6IG51bGwKICAgIH07CgogICAgLy8gZnVuY3Rpb24gdG8gZW5kIHRyaWFsIHdoZW4gaXQgaXMgdGltZQogICAgdmFyIGVuZF90cmlhbCA9IGZ1bmN0aW9uKCkgewoKICAgICAgLy8ga2lsbCBhbnkgcmVtYWluaW5nIHNldFRpbWVvdXQgaGFuZGxlcnMKICAgICAganNQc3ljaC5wbHVnaW5BUEkuY2xlYXJBbGxUaW1lb3V0cygpOwoKICAgICAgLy8ga2lsbCBrZXlib2FyZCBsaXN0ZW5lcnMKICAgICAgaWYgKHR5cGVvZiBrZXlib2FyZExpc3RlbmVyICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIGpzUHN5Y2gucGx1Z2luQVBJLmNhbmNlbEtleWJvYXJkUmVzcG9uc2Uoa2V5Ym9hcmRMaXN0ZW5lcik7CiAgICAgIH0KCiAgICAgIC8vIGdhdGhlciB0aGUgZGF0YSB0byBzdG9yZSBmb3IgdGhlIHRyaWFsCiAgICAgIHZhciB0cmlhbF9kYXRhID0gewogICAgICAgIHJ0OiByZXNwb25zZS5ydCwKICAgICAgICBzdGltdWx1czogdHJpYWwuc3RpbXVsdXMsCiAgICAgICAgcmVzcG9uc2U6IHJlc3BvbnNlLmtleQogICAgICB9OwoKICAgICAgLy8gY2xlYXIgdGhlIGRpc3BsYXkKICAgICAgZGlzcGxheV9lbGVtZW50LmlubmVySFRNTCA9ICcnOwoKICAgICAgLy8gbW92ZSBvbiB0byB0aGUgbmV4dCB0cmlhbAogICAgICBqc1BzeWNoLmZpbmlzaFRyaWFsKHRyaWFsX2RhdGEpOwogICAgfTsKCiAgICAvLyBmdW5jdGlvbiB0byBoYW5kbGUgcmVzcG9uc2VzIGJ5IHRoZSBzdWJqZWN0CiAgICB2YXIgYWZ0ZXJfcmVzcG9uc2UgPSBmdW5jdGlvbihpbmZvKSB7CgogICAgICAvLyBhZnRlciBhIHZhbGlkIHJlc3BvbnNlLCB0aGUgc3RpbXVsdXMgd2lsbCBoYXZlIHRoZSBDU1MgY2xhc3MgJ3Jlc3BvbmRlZCcKICAgICAgLy8gd2hpY2ggY2FuIGJlIHVzZWQgdG8gcHJvdmlkZSB2aXN1YWwgZmVlZGJhY2sgdGhhdCBhIHJlc3BvbnNlIHdhcyByZWNvcmRlZAogICAgICBkaXNwbGF5X2VsZW1lbnQucXVlcnlTZWxlY3RvcignI2pzcHN5Y2gtaHRtbC1rZXlib2FyZC1yZXNwb25zZS1zdGltdWx1cycpLmNsYXNzTmFtZSArPSAnIHJlc3BvbmRlZCc7CgogICAgICAvLyBvbmx5IHJlY29yZCB0aGUgZmlyc3QgcmVzcG9uc2UKICAgICAgaWYgKHJlc3BvbnNlLmtleSA9PSBudWxsKSB7CiAgICAgICAgcmVzcG9uc2UgPSBpbmZvOwogICAgICB9CgogICAgICBpZiAodHJpYWwucmVzcG9uc2VfZW5kc190cmlhbCkgewogICAgICAgIGVuZF90cmlhbCgpOwogICAgICB9CiAgICB9OwoKICAgIC8vIHN0YXJ0IHRoZSByZXNwb25zZSBsaXN0ZW5lcgogICAgaWYgKHRyaWFsLmNob2ljZXMgIT0ganNQc3ljaC5OT19LRVlTKSB7CiAgICAgIHZhciBrZXlib2FyZExpc3RlbmVyID0ganNQc3ljaC5wbHVnaW5BUEkuZ2V0S2V5Ym9hcmRSZXNwb25zZSh7CiAgICAgICAgY2FsbGJhY2tfZnVuY3Rpb246IGFmdGVyX3Jlc3BvbnNlLAogICAgICAgIHZhbGlkX3Jlc3BvbnNlczogdHJpYWwuY2hvaWNlcywKICAgICAgICBydF9tZXRob2Q6ICdwZXJmb3JtYW5jZScsCiAgICAgICAgcGVyc2lzdDogZmFsc2UsCiAgICAgICAgYWxsb3dfaGVsZF9rZXk6IGZhbHNlCiAgICAgIH0pOwogICAgfQoKICAgIC8vIGhpZGUgc3RpbXVsdXMgaWYgc3RpbXVsdXNfZHVyYXRpb24gaXMgc2V0CiAgICBpZiAodHJpYWwuc3RpbXVsdXNfZHVyYXRpb24gIT09IG51bGwpIHsKICAgICAganNQc3ljaC5wbHVnaW5BUEkuc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICBkaXNwbGF5X2VsZW1lbnQucXVlcnlTZWxlY3RvcignI2pzcHN5Y2gtaHRtbC1rZXlib2FyZC1yZXNwb25zZS1zdGltdWx1cycpLnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJzsKICAgICAgfSwgdHJpYWwuc3RpbXVsdXNfZHVyYXRpb24pOwogICAgfQoKICAgIC8vIGVuZCB0cmlhbCBpZiB0cmlhbF9kdXJhdGlvbiBpcyBzZXQKICAgIGlmICh0cmlhbC50cmlhbF9kdXJhdGlvbiAhPT0gbnVsbCkgewogICAgICBqc1BzeWNoLnBsdWdpbkFQSS5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIGVuZF90cmlhbCgpOwogICAgICB9LCB0cmlhbC50cmlhbF9kdXJhdGlvbik7CiAgICB9CgogIH07CgogIHJldHVybiBwbHVnaW47Cn0pKCk7Cg=="></script>
<script src="data:application/javascript; charset=utf-8;base64,LyoqCiAqIGpzcHN5Y2gtaHRtbC1idXR0b24tcmVzcG9uc2UKICogSm9zaCBkZSBMZWV1dwogKgogKiBwbHVnaW4gZm9yIGRpc3BsYXlpbmcgYSBzdGltdWx1cyBhbmQgZ2V0dGluZyBhIGJ1dHRvbiByZXNwb25zZQogKgogKiBkb2N1bWVudGF0aW9uOiBkb2NzLmpzcHN5Y2gub3JnCiAqCiAqKi8KCmpzUHN5Y2gucGx1Z2luc1siaHRtbC1idXR0b24tcmVzcG9uc2UiXSA9IChmdW5jdGlvbigpIHsKCiAgdmFyIHBsdWdpbiA9IHt9OwoKICBwbHVnaW4uaW5mbyA9IHsKICAgIG5hbWU6ICdodG1sLWJ1dHRvbi1yZXNwb25zZScsCiAgICBkZXNjcmlwdGlvbjogJycsCiAgICBwYXJhbWV0ZXJzOiB7CiAgICAgIHN0aW11bHVzOiB7CiAgICAgICAgdHlwZToganNQc3ljaC5wbHVnaW5zLnBhcmFtZXRlclR5cGUuSFRNTF9TVFJJTkcsCiAgICAgICAgcHJldHR5X25hbWU6ICdTdGltdWx1cycsCiAgICAgICAgZGVmYXVsdDogdW5kZWZpbmVkLAogICAgICAgIGRlc2NyaXB0aW9uOiAnVGhlIEhUTUwgc3RyaW5nIHRvIGJlIGRpc3BsYXllZCcKICAgICAgfSwKICAgICAgY2hvaWNlczogewogICAgICAgIHR5cGU6IGpzUHN5Y2gucGx1Z2lucy5wYXJhbWV0ZXJUeXBlLlNUUklORywKICAgICAgICBwcmV0dHlfbmFtZTogJ0Nob2ljZXMnLAogICAgICAgIGRlZmF1bHQ6IHVuZGVmaW5lZCwKICAgICAgICBhcnJheTogdHJ1ZSwKICAgICAgICBkZXNjcmlwdGlvbjogJ1RoZSBsYWJlbHMgZm9yIHRoZSBidXR0b25zLicKICAgICAgfSwKICAgICAgYnV0dG9uX2h0bWw6IHsKICAgICAgICB0eXBlOiBqc1BzeWNoLnBsdWdpbnMucGFyYW1ldGVyVHlwZS5TVFJJTkcsCiAgICAgICAgcHJldHR5X25hbWU6ICdCdXR0b24gSFRNTCcsCiAgICAgICAgZGVmYXVsdDogJzxidXR0b24gY2xhc3M9ImpzcHN5Y2gtYnRuIj4lY2hvaWNlJTwvYnV0dG9uPicsCiAgICAgICAgYXJyYXk6IHRydWUsCiAgICAgICAgZGVzY3JpcHRpb246ICdUaGUgaHRtbCBvZiB0aGUgYnV0dG9uLiBDYW4gY3JlYXRlIG93biBzdHlsZS4nCiAgICAgIH0sCiAgICAgIHByb21wdDogewogICAgICAgIHR5cGU6IGpzUHN5Y2gucGx1Z2lucy5wYXJhbWV0ZXJUeXBlLlNUUklORywKICAgICAgICBwcmV0dHlfbmFtZTogJ1Byb21wdCcsCiAgICAgICAgZGVmYXVsdDogbnVsbCwKICAgICAgICBkZXNjcmlwdGlvbjogJ0FueSBjb250ZW50IGhlcmUgd2lsbCBiZSBkaXNwbGF5ZWQgdW5kZXIgdGhlIGJ1dHRvbi4nCiAgICAgIH0sCiAgICAgIHN0aW11bHVzX2R1cmF0aW9uOiB7CiAgICAgICAgdHlwZToganNQc3ljaC5wbHVnaW5zLnBhcmFtZXRlclR5cGUuSU5ULAogICAgICAgIHByZXR0eV9uYW1lOiAnU3RpbXVsdXMgZHVyYXRpb24nLAogICAgICAgIGRlZmF1bHQ6IG51bGwsCiAgICAgICAgZGVzY3JpcHRpb246ICdIb3cgbG9uZyB0byBoaWRlIHRoZSBzdGltdWx1cy4nCiAgICAgIH0sCiAgICAgIHRyaWFsX2R1cmF0aW9uOiB7CiAgICAgICAgdHlwZToganNQc3ljaC5wbHVnaW5zLnBhcmFtZXRlclR5cGUuSU5ULAogICAgICAgIHByZXR0eV9uYW1lOiAnVHJpYWwgZHVyYXRpb24nLAogICAgICAgIGRlZmF1bHQ6IG51bGwsCiAgICAgICAgZGVzY3JpcHRpb246ICdIb3cgbG9uZyB0byBzaG93IHRoZSB0cmlhbC4nCiAgICAgIH0sCiAgICAgIG1hcmdpbl92ZXJ0aWNhbDogewogICAgICAgIHR5cGU6IGpzUHN5Y2gucGx1Z2lucy5wYXJhbWV0ZXJUeXBlLlNUUklORywKICAgICAgICBwcmV0dHlfbmFtZTogJ01hcmdpbiB2ZXJ0aWNhbCcsCiAgICAgICAgZGVmYXVsdDogJzBweCcsCiAgICAgICAgZGVzY3JpcHRpb246ICdUaGUgdmVydGljYWwgbWFyZ2luIG9mIHRoZSBidXR0b24uJwogICAgICB9LAogICAgICBtYXJnaW5faG9yaXpvbnRhbDogewogICAgICAgIHR5cGU6IGpzUHN5Y2gucGx1Z2lucy5wYXJhbWV0ZXJUeXBlLlNUUklORywKICAgICAgICBwcmV0dHlfbmFtZTogJ01hcmdpbiBob3Jpem9udGFsJywKICAgICAgICBkZWZhdWx0OiAnOHB4JywKICAgICAgICBkZXNjcmlwdGlvbjogJ1RoZSBob3Jpem9udGFsIG1hcmdpbiBvZiB0aGUgYnV0dG9uLicKICAgICAgfSwKICAgICAgcmVzcG9uc2VfZW5kc190cmlhbDogewogICAgICAgIHR5cGU6IGpzUHN5Y2gucGx1Z2lucy5wYXJhbWV0ZXJUeXBlLkJPT0wsCiAgICAgICAgcHJldHR5X25hbWU6ICdSZXNwb25zZSBlbmRzIHRyaWFsJywKICAgICAgICBkZWZhdWx0OiB0cnVlLAogICAgICAgIGRlc2NyaXB0aW9uOiAnSWYgdHJ1ZSwgdGhlbiB0cmlhbCB3aWxsIGVuZCB3aGVuIHVzZXIgcmVzcG9uZHMuJwogICAgICB9LAogICAgfQogIH0KCiAgcGx1Z2luLnRyaWFsID0gZnVuY3Rpb24oZGlzcGxheV9lbGVtZW50LCB0cmlhbCkgewoKICAgIC8vIGRpc3BsYXkgc3RpbXVsdXMKICAgIHZhciBodG1sID0gJzxkaXYgaWQ9ImpzcHN5Y2gtaHRtbC1idXR0b24tcmVzcG9uc2Utc3RpbXVsdXMiPicrdHJpYWwuc3RpbXVsdXMrJzwvZGl2Pic7CgogICAgLy9kaXNwbGF5IGJ1dHRvbnMKICAgIHZhciBidXR0b25zID0gW107CiAgICBpZiAoQXJyYXkuaXNBcnJheSh0cmlhbC5idXR0b25faHRtbCkpIHsKICAgICAgaWYgKHRyaWFsLmJ1dHRvbl9odG1sLmxlbmd0aCA9PSB0cmlhbC5jaG9pY2VzLmxlbmd0aCkgewogICAgICAgIGJ1dHRvbnMgPSB0cmlhbC5idXR0b25faHRtbDsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBpbiBodG1sLWJ1dHRvbi1yZXNwb25zZSBwbHVnaW4uIFRoZSBsZW5ndGggb2YgdGhlIGJ1dHRvbl9odG1sIGFycmF5IGRvZXMgbm90IGVxdWFsIHRoZSBsZW5ndGggb2YgdGhlIGNob2ljZXMgYXJyYXknKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0cmlhbC5jaG9pY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgYnV0dG9ucy5wdXNoKHRyaWFsLmJ1dHRvbl9odG1sKTsKICAgICAgfQogICAgfQogICAgaHRtbCArPSAnPGRpdiBpZD0ianNwc3ljaC1odG1sLWJ1dHRvbi1yZXNwb25zZS1idG5ncm91cCI+JzsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdHJpYWwuY2hvaWNlcy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgc3RyID0gYnV0dG9uc1tpXS5yZXBsYWNlKC8lY2hvaWNlJS9nLCB0cmlhbC5jaG9pY2VzW2ldKTsKICAgICAgaHRtbCArPSAnPGRpdiBjbGFzcz0ianNwc3ljaC1odG1sLWJ1dHRvbi1yZXNwb25zZS1idXR0b24iIHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IG1hcmdpbjonK3RyaWFsLm1hcmdpbl92ZXJ0aWNhbCsnICcrdHJpYWwubWFyZ2luX2hvcml6b250YWwrJyIgaWQ9ImpzcHN5Y2gtaHRtbC1idXR0b24tcmVzcG9uc2UtYnV0dG9uLScgKyBpICsnIiBkYXRhLWNob2ljZT0iJytpKyciPicrc3RyKyc8L2Rpdj4nOwogICAgfQogICAgaHRtbCArPSAnPC9kaXY+JzsKCiAgICAvL3Nob3cgcHJvbXB0IGlmIHRoZXJlIGlzIG9uZQogICAgaWYgKHRyaWFsLnByb21wdCAhPT0gbnVsbCkgewogICAgICBodG1sICs9IHRyaWFsLnByb21wdDsKICAgIH0KICAgIGRpc3BsYXlfZWxlbWVudC5pbm5lckhUTUwgPSBodG1sOwoKICAgIC8vIHN0YXJ0IHRpbWUKICAgIHZhciBzdGFydF90aW1lID0gcGVyZm9ybWFuY2Uubm93KCk7CgogICAgLy8gYWRkIGV2ZW50IGxpc3RlbmVycyB0byBidXR0b25zCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRyaWFsLmNob2ljZXMubGVuZ3RoOyBpKyspIHsKICAgICAgZGlzcGxheV9lbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJyNqc3BzeWNoLWh0bWwtYnV0dG9uLXJlc3BvbnNlLWJ1dHRvbi0nICsgaSkuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbihlKXsKICAgICAgICB2YXIgY2hvaWNlID0gZS5jdXJyZW50VGFyZ2V0LmdldEF0dHJpYnV0ZSgnZGF0YS1jaG9pY2UnKTsgLy8gZG9uJ3QgdXNlIGRhdGFzZXQgZm9yIGpzZG9tIGNvbXBhdGliaWxpdHkKICAgICAgICBhZnRlcl9yZXNwb25zZShjaG9pY2UpOwogICAgICB9KTsKICAgIH0KCiAgICAvLyBzdG9yZSByZXNwb25zZQogICAgdmFyIHJlc3BvbnNlID0gewogICAgICBydDogbnVsbCwKICAgICAgYnV0dG9uOiBudWxsCiAgICB9OwoKICAgIC8vIGZ1bmN0aW9uIHRvIGhhbmRsZSByZXNwb25zZXMgYnkgdGhlIHN1YmplY3QKICAgIGZ1bmN0aW9uIGFmdGVyX3Jlc3BvbnNlKGNob2ljZSkgewoKICAgICAgLy8gbWVhc3VyZSBydAogICAgICB2YXIgZW5kX3RpbWUgPSBwZXJmb3JtYW5jZS5ub3coKTsKICAgICAgdmFyIHJ0ID0gZW5kX3RpbWUgLSBzdGFydF90aW1lOwogICAgICByZXNwb25zZS5idXR0b24gPSBwYXJzZUludChjaG9pY2UpOwogICAgICByZXNwb25zZS5ydCA9IHJ0OwoKICAgICAgLy8gYWZ0ZXIgYSB2YWxpZCByZXNwb25zZSwgdGhlIHN0aW11bHVzIHdpbGwgaGF2ZSB0aGUgQ1NTIGNsYXNzICdyZXNwb25kZWQnCiAgICAgIC8vIHdoaWNoIGNhbiBiZSB1c2VkIHRvIHByb3ZpZGUgdmlzdWFsIGZlZWRiYWNrIHRoYXQgYSByZXNwb25zZSB3YXMgcmVjb3JkZWQKICAgICAgZGlzcGxheV9lbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJyNqc3BzeWNoLWh0bWwtYnV0dG9uLXJlc3BvbnNlLXN0aW11bHVzJykuY2xhc3NOYW1lICs9ICcgcmVzcG9uZGVkJzsKCiAgICAgIC8vIGRpc2FibGUgYWxsIHRoZSBidXR0b25zIGFmdGVyIGEgcmVzcG9uc2UKICAgICAgdmFyIGJ0bnMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuanNwc3ljaC1odG1sLWJ1dHRvbi1yZXNwb25zZS1idXR0b24gYnV0dG9uJyk7CiAgICAgIGZvcih2YXIgaT0wOyBpPGJ0bnMubGVuZ3RoOyBpKyspewogICAgICAgIC8vYnRuc1tpXS5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycpOwogICAgICAgIGJ0bnNbaV0uc2V0QXR0cmlidXRlKCdkaXNhYmxlZCcsICdkaXNhYmxlZCcpOwogICAgICB9CgogICAgICBpZiAodHJpYWwucmVzcG9uc2VfZW5kc190cmlhbCkgewogICAgICAgIGVuZF90cmlhbCgpOwogICAgICB9CiAgICB9OwoKICAgIC8vIGZ1bmN0aW9uIHRvIGVuZCB0cmlhbCB3aGVuIGl0IGlzIHRpbWUKICAgIGZ1bmN0aW9uIGVuZF90cmlhbCgpIHsKCiAgICAgIC8vIGtpbGwgYW55IHJlbWFpbmluZyBzZXRUaW1lb3V0IGhhbmRsZXJzCiAgICAgIGpzUHN5Y2gucGx1Z2luQVBJLmNsZWFyQWxsVGltZW91dHMoKTsKCiAgICAgIC8vIGdhdGhlciB0aGUgZGF0YSB0byBzdG9yZSBmb3IgdGhlIHRyaWFsCiAgICAgIHZhciB0cmlhbF9kYXRhID0gewogICAgICAgIHJ0OiByZXNwb25zZS5ydCwKICAgICAgICBzdGltdWx1czogdHJpYWwuc3RpbXVsdXMsCiAgICAgICAgcmVzcG9uc2U6IHJlc3BvbnNlLmJ1dHRvbgogICAgICB9OwoKICAgICAgLy8gY2xlYXIgdGhlIGRpc3BsYXkKICAgICAgZGlzcGxheV9lbGVtZW50LmlubmVySFRNTCA9ICcnOwoKICAgICAgLy8gbW92ZSBvbiB0byB0aGUgbmV4dCB0cmlhbAogICAgICBqc1BzeWNoLmZpbmlzaFRyaWFsKHRyaWFsX2RhdGEpOwogICAgfTsKCiAgICAvLyBoaWRlIGltYWdlIGlmIHRpbWluZyBpcyBzZXQKICAgIGlmICh0cmlhbC5zdGltdWx1c19kdXJhdGlvbiAhPT0gbnVsbCkgewogICAgICBqc1BzeWNoLnBsdWdpbkFQSS5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIGRpc3BsYXlfZWxlbWVudC5xdWVyeVNlbGVjdG9yKCcjanNwc3ljaC1odG1sLWJ1dHRvbi1yZXNwb25zZS1zdGltdWx1cycpLnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJzsKICAgICAgfSwgdHJpYWwuc3RpbXVsdXNfZHVyYXRpb24pOwogICAgfQoKICAgIC8vIGVuZCB0cmlhbCBpZiB0aW1lIGxpbWl0IGlzIHNldAogICAgaWYgKHRyaWFsLnRyaWFsX2R1cmF0aW9uICE9PSBudWxsKSB7CiAgICAgIGpzUHN5Y2gucGx1Z2luQVBJLnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgZW5kX3RyaWFsKCk7CiAgICAgIH0sIHRyaWFsLnRyaWFsX2R1cmF0aW9uKTsKICAgIH0KCiAgfTsKCiAgcmV0dXJuIHBsdWdpbjsKfSkoKTsK"></script>
<script src="data:application/javascript; charset=utf-8;base64,LyoqCiAqIGpzcHN5Y2gtaW1hZ2Uta2V5Ym9hcmQtcmVzcG9uc2UKICogSm9zaCBkZSBMZWV1dwogKgogKiBwbHVnaW4gZm9yIGRpc3BsYXlpbmcgYSBzdGltdWx1cyBhbmQgZ2V0dGluZyBhIGtleWJvYXJkIHJlc3BvbnNlCiAqCiAqIGRvY3VtZW50YXRpb246IGRvY3MuanNwc3ljaC5vcmcKICoKICoqLwoKCmpzUHN5Y2gucGx1Z2luc1siaW1hZ2Uta2V5Ym9hcmQtcmVzcG9uc2UiXSA9IChmdW5jdGlvbigpIHsKCiAgdmFyIHBsdWdpbiA9IHt9OwoKICBqc1BzeWNoLnBsdWdpbkFQSS5yZWdpc3RlclByZWxvYWQoJ2ltYWdlLWtleWJvYXJkLXJlc3BvbnNlJywgJ3N0aW11bHVzJywgJ2ltYWdlJyk7CgogIHBsdWdpbi5pbmZvID0gewogICAgbmFtZTogJ2ltYWdlLWtleWJvYXJkLXJlc3BvbnNlJywKICAgIGRlc2NyaXB0aW9uOiAnJywKICAgIHBhcmFtZXRlcnM6IHsKICAgICAgc3RpbXVsdXM6IHsKICAgICAgICB0eXBlOiBqc1BzeWNoLnBsdWdpbnMucGFyYW1ldGVyVHlwZS5JTUFHRSwKICAgICAgICBwcmV0dHlfbmFtZTogJ1N0aW11bHVzJywKICAgICAgICBkZWZhdWx0OiB1bmRlZmluZWQsCiAgICAgICAgZGVzY3JpcHRpb246ICdUaGUgaW1hZ2UgdG8gYmUgZGlzcGxheWVkJwogICAgICB9LAogICAgICBzdGltdWx1c19oZWlnaHQ6IHsKICAgICAgICB0eXBlOiBqc1BzeWNoLnBsdWdpbnMucGFyYW1ldGVyVHlwZS5JTlQsCiAgICAgICAgcHJldHR5X25hbWU6ICdJbWFnZSBoZWlnaHQnLAogICAgICAgIGRlZmF1bHQ6IG51bGwsCiAgICAgICAgZGVzY3JpcHRpb246ICdTZXQgdGhlIGltYWdlIGhlaWdodCBpbiBwaXhlbHMnCiAgICAgIH0sCiAgICAgIHN0aW11bHVzX3dpZHRoOiB7CiAgICAgICAgdHlwZToganNQc3ljaC5wbHVnaW5zLnBhcmFtZXRlclR5cGUuSU5ULAogICAgICAgIHByZXR0eV9uYW1lOiAnSW1hZ2Ugd2lkdGgnLAogICAgICAgIGRlZmF1bHQ6IG51bGwsCiAgICAgICAgZGVzY3JpcHRpb246ICdTZXQgdGhlIGltYWdlIHdpZHRoIGluIHBpeGVscycKICAgICAgfSwKICAgICAgbWFpbnRhaW5fYXNwZWN0X3JhdGlvOiB7CiAgICAgICAgdHlwZToganNQc3ljaC5wbHVnaW5zLnBhcmFtZXRlclR5cGUuQk9PTCwKICAgICAgICBwcmV0dHlfbmFtZTogJ01haW50YWluIGFzcGVjdCByYXRpbycsCiAgICAgICAgZGVmYXVsdDogdHJ1ZSwKICAgICAgICBkZXNjcmlwdGlvbjogJ01haW50YWluIHRoZSBhc3BlY3QgcmF0aW8gYWZ0ZXIgc2V0dGluZyB3aWR0aCBvciBoZWlnaHQnCiAgICAgIH0sCiAgICAgIGNob2ljZXM6IHsKICAgICAgICB0eXBlOiBqc1BzeWNoLnBsdWdpbnMucGFyYW1ldGVyVHlwZS5LRVksCiAgICAgICAgYXJyYXk6IHRydWUsCiAgICAgICAgcHJldHR5X25hbWU6ICdDaG9pY2VzJywKICAgICAgICBkZWZhdWx0OiBqc1BzeWNoLkFMTF9LRVlTLAogICAgICAgIGRlc2NyaXB0aW9uOiAnVGhlIGtleXMgdGhlIHN1YmplY3QgaXMgYWxsb3dlZCB0byBwcmVzcyB0byByZXNwb25kIHRvIHRoZSBzdGltdWx1cy4nCiAgICAgIH0sCiAgICAgIHByb21wdDogewogICAgICAgIHR5cGU6IGpzUHN5Y2gucGx1Z2lucy5wYXJhbWV0ZXJUeXBlLlNUUklORywKICAgICAgICBwcmV0dHlfbmFtZTogJ1Byb21wdCcsCiAgICAgICAgZGVmYXVsdDogbnVsbCwKICAgICAgICBkZXNjcmlwdGlvbjogJ0FueSBjb250ZW50IGhlcmUgd2lsbCBiZSBkaXNwbGF5ZWQgYmVsb3cgdGhlIHN0aW11bHVzLicKICAgICAgfSwKICAgICAgc3RpbXVsdXNfZHVyYXRpb246IHsKICAgICAgICB0eXBlOiBqc1BzeWNoLnBsdWdpbnMucGFyYW1ldGVyVHlwZS5JTlQsCiAgICAgICAgcHJldHR5X25hbWU6ICdTdGltdWx1cyBkdXJhdGlvbicsCiAgICAgICAgZGVmYXVsdDogbnVsbCwKICAgICAgICBkZXNjcmlwdGlvbjogJ0hvdyBsb25nIHRvIGhpZGUgdGhlIHN0aW11bHVzLicKICAgICAgfSwKICAgICAgdHJpYWxfZHVyYXRpb246IHsKICAgICAgICB0eXBlOiBqc1BzeWNoLnBsdWdpbnMucGFyYW1ldGVyVHlwZS5JTlQsCiAgICAgICAgcHJldHR5X25hbWU6ICdUcmlhbCBkdXJhdGlvbicsCiAgICAgICAgZGVmYXVsdDogbnVsbCwKICAgICAgICBkZXNjcmlwdGlvbjogJ0hvdyBsb25nIHRvIHNob3cgdHJpYWwgYmVmb3JlIGl0IGVuZHMuJwogICAgICB9LAogICAgICByZXNwb25zZV9lbmRzX3RyaWFsOiB7CiAgICAgICAgdHlwZToganNQc3ljaC5wbHVnaW5zLnBhcmFtZXRlclR5cGUuQk9PTCwKICAgICAgICBwcmV0dHlfbmFtZTogJ1Jlc3BvbnNlIGVuZHMgdHJpYWwnLAogICAgICAgIGRlZmF1bHQ6IHRydWUsCiAgICAgICAgZGVzY3JpcHRpb246ICdJZiB0cnVlLCB0cmlhbCB3aWxsIGVuZCB3aGVuIHN1YmplY3QgbWFrZXMgYSByZXNwb25zZS4nCiAgICAgIH0sCiAgICAgIHJlbmRlcl9vbl9jYW52YXM6IHsKICAgICAgICB0eXBlOiBqc1BzeWNoLnBsdWdpbnMucGFyYW1ldGVyVHlwZS5CT09MLAogICAgICAgIHByZXR0eV9uYW1lOiAnUmVuZGVyIG9uIGNhbnZhcycsCiAgICAgICAgZGVmYXVsdDogdHJ1ZSwKICAgICAgICBkZXNjcmlwdGlvbjogJ0lmIHRydWUsIHRoZSBpbWFnZSB3aWxsIGJlIGRyYXduIG9udG8gYSBjYW52YXMgZWxlbWVudCAocHJldmVudHMgYmxhbmsgc2NyZWVuIGJldHdlZW4gY29uc2VjdXRpdmUgaW1hZ2VzIGluIHNvbWUgYnJvd3NlcnMpLicrCiAgICAgICAgICAnSWYgZmFsc2UsIHRoZSBpbWFnZSB3aWxsIGJlIHNob3duIHZpYSBhbiBpbWcgZWxlbWVudC4nCiAgICAgIH0KICAgIH0KICB9CgogIHBsdWdpbi50cmlhbCA9IGZ1bmN0aW9uKGRpc3BsYXlfZWxlbWVudCwgdHJpYWwpIHsKCiAgICB2YXIgaGVpZ2h0LCB3aWR0aDsKICAgIGlmICh0cmlhbC5yZW5kZXJfb25fY2FudmFzKSB7CiAgICAgIHZhciBpbWFnZV9kcmF3biA9IGZhbHNlOwogICAgICAvLyBmaXJzdCBjbGVhciB0aGUgZGlzcGxheSBlbGVtZW50IChiZWNhdXNlIHRoZSByZW5kZXJfb25fY2FudmFzIG1ldGhvZCBhcHBlbmRzIHRvIGRpc3BsYXlfZWxlbWVudCBpbnN0ZWFkIG9mIG92ZXJ3cml0aW5nIGl0IHdpdGggLmlubmVySFRNTCkKICAgICAgaWYgKGRpc3BsYXlfZWxlbWVudC5oYXNDaGlsZE5vZGVzKCkpIHsKICAgICAgICAvLyBjYW4ndCBsb29wIHRocm91Z2ggY2hpbGQgbGlzdCBiZWNhdXNlIHRoZSBsaXN0IHdpbGwgYmUgbW9kaWZpZWQgYnkgLnJlbW92ZUNoaWxkKCkKICAgICAgICB3aGlsZSAoZGlzcGxheV9lbGVtZW50LmZpcnN0Q2hpbGQpIHsKICAgICAgICAgIGRpc3BsYXlfZWxlbWVudC5yZW1vdmVDaGlsZChkaXNwbGF5X2VsZW1lbnQuZmlyc3RDaGlsZCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIGNyZWF0ZSBjYW52YXMgZWxlbWVudCBhbmQgaW1hZ2UKICAgICAgdmFyIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpOwogICAgICBjYW52YXMuaWQgPSAianNwc3ljaC1pbWFnZS1rZXlib2FyZC1yZXNwb25zZS1zdGltdWx1cyI7CiAgICAgIGNhbnZhcy5zdHlsZS5tYXJnaW4gPSAwOwogICAgICBjYW52YXMuc3R5bGUucGFkZGluZyA9IDA7CiAgICAgIHZhciBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgiMmQiKTsKICAgICAgdmFyIGltZyA9IG5ldyBJbWFnZSgpOyAgIAogICAgICBpbWcub25sb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gaWYgaW1hZ2Ugd2Fzbid0IHByZWxvYWRlZCwgdGhlbiBpdCB3aWxsIG5lZWQgdG8gYmUgZHJhd24gd2hlbmV2ZXIgaXQgZmluaXNoZXMgbG9hZGluZwogICAgICAgIGlmICghaW1hZ2VfZHJhd24pIHsKICAgICAgICAgIGdldEhlaWdodFdpZHRoKCk7IC8vIG9ubHkgcG9zc2libGUgdG8gZ2V0IHdpZHRoL2hlaWdodCBhZnRlciBpbWFnZSBsb2FkcwogICAgICAgICAgY3R4LmRyYXdJbWFnZShpbWcsMCwwLHdpZHRoLGhlaWdodCk7CiAgICAgICAgfQogICAgICB9OwogICAgICBpbWcuc3JjID0gdHJpYWwuc3RpbXVsdXM7CiAgICAgIC8vIGdldC9zZXQgaW1hZ2UgaGVpZ2h0IGFuZCB3aWR0aCAtIHRoaXMgY2FuIG9ubHkgYmUgZG9uZSBhZnRlciBpbWFnZSBsb2FkcyBiZWNhdXNlIHVzZXMgaW1hZ2UncyBuYXR1cmFsV2lkdGgvbmF0dXJhbEhlaWdodCBwcm9wZXJ0aWVzCiAgICAgIGZ1bmN0aW9uIGdldEhlaWdodFdpZHRoKCkgewogICAgICAgIGlmICh0cmlhbC5zdGltdWx1c19oZWlnaHQgIT09IG51bGwpIHsKICAgICAgICAgIGhlaWdodCA9IHRyaWFsLnN0aW11bHVzX2hlaWdodDsKICAgICAgICAgIGlmICh0cmlhbC5zdGltdWx1c193aWR0aCA9PSBudWxsICYmIHRyaWFsLm1haW50YWluX2FzcGVjdF9yYXRpbykgewogICAgICAgICAgICB3aWR0aCA9IGltZy5uYXR1cmFsV2lkdGggKiAodHJpYWwuc3RpbXVsdXNfaGVpZ2h0L2ltZy5uYXR1cmFsSGVpZ2h0KTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgaGVpZ2h0ID0gaW1nLm5hdHVyYWxIZWlnaHQ7CiAgICAgICAgfQogICAgICAgIGlmICh0cmlhbC5zdGltdWx1c193aWR0aCAhPT0gbnVsbCkgewogICAgICAgICAgd2lkdGggPSB0cmlhbC5zdGltdWx1c193aWR0aDsKICAgICAgICAgIGlmICh0cmlhbC5zdGltdWx1c19oZWlnaHQgPT0gbnVsbCAmJiB0cmlhbC5tYWludGFpbl9hc3BlY3RfcmF0aW8pIHsKICAgICAgICAgICAgaGVpZ2h0ID0gaW1nLm5hdHVyYWxIZWlnaHQgKiAodHJpYWwuc3RpbXVsdXNfd2lkdGgvaW1nLm5hdHVyYWxXaWR0aCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICghKHRyaWFsLnN0aW11bHVzX2hlaWdodCAhPT0gbnVsbCAmIHRyaWFsLm1haW50YWluX2FzcGVjdF9yYXRpbykpIHsKICAgICAgICAgIC8vIGlmIHN0aW11bHVzIHdpZHRoIGlzIG51bGwsIG9ubHkgdXNlIHRoZSBpbWFnZSdzIG5hdHVyYWwgd2lkdGggaWYgdGhlIHdpZHRoIHZhbHVlIHdhc24ndCBzZXQgCiAgICAgICAgICAvLyBpbiB0aGUgaWYgc3RhdGVtZW50IGFib3ZlLCBiYXNlZCBvbiBhIHNwZWNpZmllZCBoZWlnaHQgYW5kIG1haW50YWluX2FzcGVjdF9yYXRpbyA9IHRydWUKICAgICAgICAgIHdpZHRoID0gaW1nLm5hdHVyYWxXaWR0aDsKICAgICAgICB9CiAgICAgICAgY2FudmFzLmhlaWdodCA9IGhlaWdodDsKICAgICAgICBjYW52YXMud2lkdGggPSB3aWR0aDsKICAgICAgfQogICAgICBnZXRIZWlnaHRXaWR0aCgpOyAvLyBjYWxsIG5vdywgaW4gY2FzZSBpbWFnZSBsb2FkcyBpbW1lZGlhdGVseSAoaXMgY2FjaGVkKQogICAgICAvLyBhZGQgY2FudmFzIGFuZCBkcmF3IGltYWdlCiAgICAgIGRpc3BsYXlfZWxlbWVudC5pbnNlcnRCZWZvcmUoY2FudmFzLCBudWxsKTsKICAgICAgaWYgKGltZy5jb21wbGV0ZSAmJiBOdW1iZXIuaXNGaW5pdGUod2lkdGgpICYmIE51bWJlci5pc0Zpbml0ZShoZWlnaHQpKSB7CiAgICAgICAgLy8gaWYgaW1hZ2UgaGFzIGxvYWRlZCBhbmQgd2lkdGgvaGVpZ2h0IGhhdmUgYmVlbiBzZXQsIHRoZW4gZHJhdyBpdCBub3cKICAgICAgICAvLyAoZG9uJ3QgcmVseSBvbiBpbWcgb25sb2FkIGZ1bmN0aW9uIHRvIGRyYXcgaW1hZ2Ugd2hlbiBpbWFnZSBpcyBpbiB0aGUgY2FjaGUsIGJlY2F1c2UgdGhhdCBjYXVzZXMgYSBkZWxheSBpbiB0aGUgaW1hZ2UgcHJlc2VudGF0aW9uKQogICAgICAgIGN0eC5kcmF3SW1hZ2UoaW1nLDAsMCx3aWR0aCxoZWlnaHQpOwogICAgICAgIGltYWdlX2RyYXduID0gdHJ1ZTsgIAogICAgICB9CiAgICAgIC8vIGFkZCBwcm9tcHQgaWYgdGhlcmUgaXMgb25lCiAgICAgIGlmICh0cmlhbC5wcm9tcHQgIT09IG51bGwpIHsKICAgICAgICBkaXNwbGF5X2VsZW1lbnQuaW5zZXJ0QWRqYWNlbnRIVE1MKCdiZWZvcmVlbmQnLCB0cmlhbC5wcm9tcHQpOwogICAgICB9CgogICAgfSBlbHNlIHsKCiAgICAgIC8vIGRpc3BsYXkgc3RpbXVsdXMgYXMgYW4gaW1hZ2UgZWxlbWVudAogICAgICB2YXIgaHRtbCA9ICc8aW1nIHNyYz0iJyt0cmlhbC5zdGltdWx1cysnIiBpZD0ianNwc3ljaC1pbWFnZS1rZXlib2FyZC1yZXNwb25zZS1zdGltdWx1cyI+JzsKICAgICAgLy8gYWRkIHByb21wdAogICAgICBpZiAodHJpYWwucHJvbXB0ICE9PSBudWxsKXsKICAgICAgICBodG1sICs9IHRyaWFsLnByb21wdDsKICAgICAgfQogICAgICAvLyB1cGRhdGUgdGhlIHBhZ2UgY29udGVudAogICAgICBkaXNwbGF5X2VsZW1lbnQuaW5uZXJIVE1MID0gaHRtbDsKCiAgICAgIC8vIHNldCBpbWFnZSBkaW1lbnNpb25zIGFmdGVyIGltYWdlIGhhcyBsb2FkZWQgKHNvIHRoYXQgd2UgaGF2ZSBhY2Nlc3MgdG8gbmF0dXJhbEhlaWdodC9uYXR1cmFsV2lkdGgpCiAgICAgIHZhciBpbWcgPSBkaXNwbGF5X2VsZW1lbnQucXVlcnlTZWxlY3RvcignI2pzcHN5Y2gtaW1hZ2Uta2V5Ym9hcmQtcmVzcG9uc2Utc3RpbXVsdXMnKTsKICAgICAgaWYgKHRyaWFsLnN0aW11bHVzX2hlaWdodCAhPT0gbnVsbCkgewogICAgICAgIGhlaWdodCA9IHRyaWFsLnN0aW11bHVzX2hlaWdodDsKICAgICAgICBpZiAodHJpYWwuc3RpbXVsdXNfd2lkdGggPT0gbnVsbCAmJiB0cmlhbC5tYWludGFpbl9hc3BlY3RfcmF0aW8pIHsKICAgICAgICAgIHdpZHRoID0gaW1nLm5hdHVyYWxXaWR0aCAqICh0cmlhbC5zdGltdWx1c19oZWlnaHQvaW1nLm5hdHVyYWxIZWlnaHQpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBoZWlnaHQgPSBpbWcubmF0dXJhbEhlaWdodDsKICAgICAgfQogICAgICBpZiAodHJpYWwuc3RpbXVsdXNfd2lkdGggIT09IG51bGwpIHsKICAgICAgICB3aWR0aCA9IHRyaWFsLnN0aW11bHVzX3dpZHRoOwogICAgICAgIGlmICh0cmlhbC5zdGltdWx1c19oZWlnaHQgPT0gbnVsbCAmJiB0cmlhbC5tYWludGFpbl9hc3BlY3RfcmF0aW8pIHsKICAgICAgICAgIGhlaWdodCA9IGltZy5uYXR1cmFsSGVpZ2h0ICogKHRyaWFsLnN0aW11bHVzX3dpZHRoL2ltZy5uYXR1cmFsV2lkdGgpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICghKHRyaWFsLnN0aW11bHVzX2hlaWdodCAhPT0gbnVsbCAmIHRyaWFsLm1haW50YWluX2FzcGVjdF9yYXRpbykpIHsKICAgICAgICAvLyBpZiBzdGltdWx1cyB3aWR0aCBpcyBudWxsLCBvbmx5IHVzZSB0aGUgaW1hZ2UncyBuYXR1cmFsIHdpZHRoIGlmIHRoZSB3aWR0aCB2YWx1ZSB3YXNuJ3Qgc2V0IAogICAgICAgIC8vIGluIHRoZSBpZiBzdGF0ZW1lbnQgYWJvdmUsIGJhc2VkIG9uIGEgc3BlY2lmaWVkIGhlaWdodCBhbmQgbWFpbnRhaW5fYXNwZWN0X3JhdGlvID0gdHJ1ZQogICAgICAgIHdpZHRoID0gaW1nLm5hdHVyYWxXaWR0aDsKICAgICAgfQogICAgICBpbWcuc3R5bGUuaGVpZ2h0ID0gaGVpZ2h0LnRvU3RyaW5nKCkgKyAicHgiOwogICAgICBpbWcuc3R5bGUud2lkdGggPSB3aWR0aC50b1N0cmluZygpICsgInB4IjsKICAgIH0KCiAgICAvLyBzdG9yZSByZXNwb25zZQogICAgdmFyIHJlc3BvbnNlID0gewogICAgICBydDogbnVsbCwKICAgICAga2V5OiBudWxsCiAgICB9OwoKICAgIC8vIGZ1bmN0aW9uIHRvIGVuZCB0cmlhbCB3aGVuIGl0IGlzIHRpbWUKICAgIHZhciBlbmRfdHJpYWwgPSBmdW5jdGlvbigpIHsKCiAgICAgIC8vIGtpbGwgYW55IHJlbWFpbmluZyBzZXRUaW1lb3V0IGhhbmRsZXJzCiAgICAgIGpzUHN5Y2gucGx1Z2luQVBJLmNsZWFyQWxsVGltZW91dHMoKTsKCiAgICAgIC8vIGtpbGwga2V5Ym9hcmQgbGlzdGVuZXJzCiAgICAgIGlmICh0eXBlb2Yga2V5Ym9hcmRMaXN0ZW5lciAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICBqc1BzeWNoLnBsdWdpbkFQSS5jYW5jZWxLZXlib2FyZFJlc3BvbnNlKGtleWJvYXJkTGlzdGVuZXIpOwogICAgICB9CgogICAgICAvLyBnYXRoZXIgdGhlIGRhdGEgdG8gc3RvcmUgZm9yIHRoZSB0cmlhbAogICAgICB2YXIgdHJpYWxfZGF0YSA9IHsKICAgICAgICBydDogcmVzcG9uc2UucnQsCiAgICAgICAgc3RpbXVsdXM6IHRyaWFsLnN0aW11bHVzLAogICAgICAgIHJlc3BvbnNlOiByZXNwb25zZS5rZXkKICAgICAgfTsKCiAgICAgIC8vIGNsZWFyIHRoZSBkaXNwbGF5CiAgICAgIGRpc3BsYXlfZWxlbWVudC5pbm5lckhUTUwgPSAnJzsKCiAgICAgIC8vIG1vdmUgb24gdG8gdGhlIG5leHQgdHJpYWwKICAgICAganNQc3ljaC5maW5pc2hUcmlhbCh0cmlhbF9kYXRhKTsKICAgIH07CgogICAgLy8gZnVuY3Rpb24gdG8gaGFuZGxlIHJlc3BvbnNlcyBieSB0aGUgc3ViamVjdAogICAgdmFyIGFmdGVyX3Jlc3BvbnNlID0gZnVuY3Rpb24oaW5mbykgewoKICAgICAgLy8gYWZ0ZXIgYSB2YWxpZCByZXNwb25zZSwgdGhlIHN0aW11bHVzIHdpbGwgaGF2ZSB0aGUgQ1NTIGNsYXNzICdyZXNwb25kZWQnCiAgICAgIC8vIHdoaWNoIGNhbiBiZSB1c2VkIHRvIHByb3ZpZGUgdmlzdWFsIGZlZWRiYWNrIHRoYXQgYSByZXNwb25zZSB3YXMgcmVjb3JkZWQKICAgICAgZGlzcGxheV9lbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJyNqc3BzeWNoLWltYWdlLWtleWJvYXJkLXJlc3BvbnNlLXN0aW11bHVzJykuY2xhc3NOYW1lICs9ICcgcmVzcG9uZGVkJzsKCiAgICAgIC8vIG9ubHkgcmVjb3JkIHRoZSBmaXJzdCByZXNwb25zZQogICAgICBpZiAocmVzcG9uc2Uua2V5ID09IG51bGwpIHsKICAgICAgICByZXNwb25zZSA9IGluZm87CiAgICAgIH0KCiAgICAgIGlmICh0cmlhbC5yZXNwb25zZV9lbmRzX3RyaWFsKSB7CiAgICAgICAgZW5kX3RyaWFsKCk7CiAgICAgIH0KICAgIH07CgogICAgLy8gc3RhcnQgdGhlIHJlc3BvbnNlIGxpc3RlbmVyCiAgICBpZiAodHJpYWwuY2hvaWNlcyAhPSBqc1BzeWNoLk5PX0tFWVMpIHsKICAgICAgdmFyIGtleWJvYXJkTGlzdGVuZXIgPSBqc1BzeWNoLnBsdWdpbkFQSS5nZXRLZXlib2FyZFJlc3BvbnNlKHsKICAgICAgICBjYWxsYmFja19mdW5jdGlvbjogYWZ0ZXJfcmVzcG9uc2UsCiAgICAgICAgdmFsaWRfcmVzcG9uc2VzOiB0cmlhbC5jaG9pY2VzLAogICAgICAgIHJ0X21ldGhvZDogJ3BlcmZvcm1hbmNlJywKICAgICAgICBwZXJzaXN0OiBmYWxzZSwKICAgICAgICBhbGxvd19oZWxkX2tleTogZmFsc2UKICAgICAgfSk7CiAgICB9CgogICAgLy8gaGlkZSBzdGltdWx1cyBpZiBzdGltdWx1c19kdXJhdGlvbiBpcyBzZXQKICAgIGlmICh0cmlhbC5zdGltdWx1c19kdXJhdGlvbiAhPT0gbnVsbCkgewogICAgICBqc1BzeWNoLnBsdWdpbkFQSS5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIGRpc3BsYXlfZWxlbWVudC5xdWVyeVNlbGVjdG9yKCcjanNwc3ljaC1pbWFnZS1rZXlib2FyZC1yZXNwb25zZS1zdGltdWx1cycpLnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJzsKICAgICAgfSwgdHJpYWwuc3RpbXVsdXNfZHVyYXRpb24pOwogICAgfQoKICAgIC8vIGVuZCB0cmlhbCBpZiB0cmlhbF9kdXJhdGlvbiBpcyBzZXQKICAgIGlmICh0cmlhbC50cmlhbF9kdXJhdGlvbiAhPT0gbnVsbCkgewogICAgICBqc1BzeWNoLnBsdWdpbkFQSS5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIGVuZF90cmlhbCgpOwogICAgICB9LCB0cmlhbC50cmlhbF9kdXJhdGlvbik7CiAgICB9IGVsc2UgaWYgKHRyaWFsLnJlc3BvbnNlX2VuZHNfdHJpYWwgPT09IGZhbHNlKSB7CiAgICAgIGNvbnNvbGUud2FybigiVGhlIGV4cGVyaW1lbnQgbWF5IGJlIGRlYWRsb2NrZWQuIFRyeSBzZXR0aW5nIGEgdHJpYWwgZHVyYXRpb24gb3Igc2V0IHJlc3BvbnNlX2VuZHNfdHJpYWwgdG8gdHJ1ZS4iKTsKICAgIH0KICB9OwoKICByZXR1cm4gcGx1Z2luOwp9KSgpOwo="></script>
<script src="data:application/javascript; charset=utf-8;base64,LyoqCiAqIGpzcHN5Y2gtcHJlbG9hZAogKiBkb2N1bWVudGF0aW9uOiBkb2NzLmpzcHN5Y2gub3JnCiAqKi8KCmpzUHN5Y2gucGx1Z2luc1sncHJlbG9hZCddID0gKGZ1bmN0aW9uKCkgewoKICAgIHZhciBwbHVnaW4gPSB7fTsKICAKICAgIHBsdWdpbi5pbmZvID0gewogICAgICBuYW1lOiAncHJlbG9hZCcsCiAgICAgIGRlc2NyaXB0aW9uOiAnJywKICAgICAgcGFyYW1ldGVyczogewogICAgICAgIGF1dG9fcHJlbG9hZDogewogICAgICAgICAgdHlwZToganNQc3ljaC5wbHVnaW5zLnBhcmFtZXRlclR5cGUuQk9PTCwKICAgICAgICAgIGRlZmF1bHQ6IGZhbHNlLAogICAgICAgICAgZGVzY3JpcHRpb246ICdXaGV0aGVyIG9yIG5vdCB0byBhdXRvbWF0aWNhbGx5IHByZWxvYWQgYW55IG1lZGlhIGZpbGVzIGJhc2VkIG9uIHRoZSB0aW1lbGluZSBwYXNzZWQgdG8ganNQc3ljaC5pbml0LicKICAgICAgICB9LAogICAgICAgIHRyaWFsczogewogICAgICAgICAgdHlwZToganNQc3ljaC5wbHVnaW5zLnBhcmFtZXRlclR5cGUuVElNRUxJTkUsCiAgICAgICAgICBkZWZhdWx0OiBbXSwKICAgICAgICAgIGRlc2NyaXB0aW9uOiAnQXJyYXkgd2l0aCBhIHRpbWVsaW5lIG9mIHRyaWFscyB0byBhdXRvbWF0aWNhbGx5IHByZWxvYWQuIElmIG9uZSBvciBtb3JlIHRyaWFsIG9iamVjdHMgaXMgcHJvdmlkZWQsICcrCiAgICAgICAgICAndGhlbiB0aGUgcGx1Z2luIHdpbGwgYXR0ZW1wdCB0byBwcmVsb2FkIHRoZSBtZWRpYSBmaWxlcyB1c2VkIGluIHRoZSB0cmlhbChzKS4nCiAgICAgICAgfSwKICAgICAgICBpbWFnZXM6IHsKICAgICAgICAgIHR5cGU6IGpzUHN5Y2gucGx1Z2lucy5wYXJhbWV0ZXJUeXBlLlNUUklORywKICAgICAgICAgIGRlZmF1bHQ6IFtdLAogICAgICAgICAgZGVzY3JpcHRpb246ICdBcnJheSB3aXRoIG9uZSBvciBtb3JlIGltYWdlIGZpbGVzIHRvIGxvYWQuIFRoaXMgcGFyYW1ldGVyIGlzIG9mdGVuIHVzZWQgaW4gY2FzZXMgd2hlcmUgbWVkaWEgZmlsZXMgY2Fubm90ICcrCiAgICAgICAgICAnYmUgYXV0b21hdGljYWxseSBwcmVsb2FkZWQgYmFzZWQgb24gdGhlIHRpbWVsaW5lLCBlLmcuIGJlY2F1c2UgdGhlIG1lZGlhIGZpbGVzIGFyZSBwYXNzZWQgaW50byBhbiBpbWFnZSBwbHVnaW4vcGFyYW1ldGVyIHdpdGggJysKICAgICAgICAgICd0aW1lbGluZSB2YXJpYWJsZXMgb3IgZHluYW1pYyBwYXJhbWV0ZXJzLCBvciBiZWNhdXNlIHRoZSBpbWFnZSBpcyBlbWJlZGRlZCBpbiBhbiBIVE1MIHN0cmluZy4nCiAgICAgICAgfSwKICAgICAgICBhdWRpbzogewogICAgICAgICAgdHlwZToganNQc3ljaC5wbHVnaW5zLnBhcmFtZXRlclR5cGUuU1RSSU5HLAogICAgICAgICAgZGVmYXVsdDogW10sCiAgICAgICAgICBkZXNjcmlwdGlvbjogJ0FycmF5IHdpdGggb25lIG9yIG1vcmUgYXVkaW8gZmlsZXMgdG8gbG9hZC4gVGhpcyBwYXJhbWV0ZXIgaXMgb2Z0ZW4gdXNlZCBpbiBjYXNlcyB3aGVyZSBtZWRpYSBmaWxlcyBjYW5ub3QgJysKICAgICAgICAgICdiZSBhdXRvbWF0aWNhbGx5IHByZWxvYWRlZCBiYXNlZCBvbiB0aGUgdGltZWxpbmUsIGUuZy4gYmVjYXVzZSB0aGUgbWVkaWEgZmlsZXMgYXJlIHBhc3NlZCBpbnRvIGFuIGF1ZGlvIHBsdWdpbi9wYXJhbWV0ZXIgd2l0aCAnKwogICAgICAgICAgJ3RpbWVsaW5lIHZhcmlhYmxlcyBvciBkeW5hbWljIHBhcmFtZXRlcnMsIG9yIGJlY2F1c2UgdGhlIGF1ZGlvIGlzIGVtYmVkZGVkIGluIGFuIEhUTUwgc3RyaW5nLicKICAgICAgICB9LAogICAgICAgIHZpZGVvOiB7CiAgICAgICAgICB0eXBlOiBqc1BzeWNoLnBsdWdpbnMucGFyYW1ldGVyVHlwZS5TVFJJTkcsCiAgICAgICAgICBkZWZhdWx0OiBbXSwKICAgICAgICAgIGRlc2NyaXB0aW9uOiAnQXJyYXkgd2l0aCBvbmUgb3IgbW9yZSB2aWRlbyBmaWxlcyB0byBsb2FkLiBUaGlzIHBhcmFtZXRlciBpcyBvZnRlbiB1c2VkIGluIGNhc2VzIHdoZXJlIG1lZGlhIGZpbGVzIGNhbm5vdCAnKwogICAgICAgICAgJ2JlIGF1dG9tYXRpY2FsbHkgcHJlbG9hZGVkIGJhc2VkIG9uIHRoZSB0aW1lbGluZSwgZS5nLiBiZWNhdXNlIHRoZSBtZWRpYSBmaWxlcyBhcmUgcGFzc2VkIGludG8gYSB2aWRlbyBwbHVnaW4vcGFyYW1ldGVyIHdpdGggJysKICAgICAgICAgICd0aW1lbGluZSB2YXJpYWJsZXMgb3IgZHluYW1pYyBwYXJhbWV0ZXJzLCBvciBiZWNhdXNlIHRoZSB2aWRlbyBpcyBlbWJlZGRlZCBpbiBhbiBIVE1MIHN0cmluZy4nCiAgICAgICAgfSwKICAgICAgICBtZXNzYWdlOiB7CiAgICAgICAgICB0eXBlOiBqc1BzeWNoLnBsdWdpbnMucGFyYW1ldGVyVHlwZS5IVE1MX1NUUklORywKICAgICAgICAgIGRlZmF1bHQ6IG51bGwsCiAgICAgICAgICBkZXNjcmlwdGlvbjogJ0hUTUwtZm9ybWF0dGVkIG1lc3NhZ2UgdG8gYmUgc2hvd24gYWJvdmUgdGhlIHByb2dyZXNzIGJhciB3aGlsZSB0aGUgZmlsZXMgYXJlIGxvYWRpbmcuJwogICAgICAgIH0sCiAgICAgICAgc2hvd19wcm9ncmVzc19iYXI6IHsKICAgICAgICAgIHR5cGU6IGpzUHN5Y2gucGx1Z2lucy5wYXJhbWV0ZXJUeXBlLkJPT0wsCiAgICAgICAgICBkZWZhdWx0OiB0cnVlLAogICAgICAgICAgZGVzY3JpcHRpb246ICdXaGV0aGVyIG9yIG5vdCB0byBzaG93IHRoZSBsb2FkaW5nIHByb2dyZXNzIGJhci4nCiAgICAgICAgfSwKICAgICAgICBjb250aW51ZV9hZnRlcl9lcnJvcjogewogICAgICAgICAgdHlwZToganNQc3ljaC5wbHVnaW5zLnBhcmFtZXRlclR5cGUuQk9PTCwKICAgICAgICAgIGRlZmF1bHQ6IGZhbHNlLAogICAgICAgICAgZGVzY3JpcHRpb246ICdXaGV0aGVyIG9yIG5vdCB0byBjb250aW51ZSB3aXRoIHRoZSBleHBlcmltZW50IGlmIGEgbG9hZGluZyBlcnJvciBvY2N1cnMuIElmIGZhbHNlLCB0aGVuIGlmIGEgbG9hZGluZyBlcnJvciBvY2N1cnMsICcrCiAgICAgICAgICAndGhlIGVycm9yX21lc3NhZ2Ugd2lsbCBiZSBzaG93biBvbiB0aGUgcGFnZSBhbmQgdGhlIHRyaWFsIHdpbGwgbm90IGVuZC4gSWYgdHJ1ZSwgdGhlbiBpZiBpZiBhIGxvYWRpbmcgZXJyb3Igb2NjdXJzLCB0aGUgdHJpYWwgd2lsbCBlbmQgJysKICAgICAgICAgICdhbmQgcHJlbG9hZGluZyBmYWlsdXJlIHdpbGwgYmUgbG9nZ2VkIGluIHRoZSB0cmlhbCBkYXRhLicKICAgICAgICB9LAogICAgICAgIGVycm9yX21lc3NhZ2U6IHsKICAgICAgICAgIHR5cGU6IGpzUHN5Y2gucGx1Z2lucy5wYXJhbWV0ZXJUeXBlLkhUTUxfU1RSSU5HLAogICAgICAgICAgZGVmYXVsdDogJ1RoZSBleHBlcmltZW50IGZhaWxlZCB0byBsb2FkLicsCiAgICAgICAgICBkZXNjcmlwdGlvbjogJ0Vycm9yIG1lc3NhZ2UgdG8gc2hvdyBvbiB0aGUgcGFnZSBpbiBjYXNlIG9mIGFueSBsb2FkaW5nIGVycm9ycy4gVGhpcyBwYXJhbWV0ZXIgaXMgb25seSByZWxldmFudCB3aGVuIGNvbnRpbnVlX2FmdGVyX2Vycm9yIGlzIGZhbHNlLicKICAgICAgICB9LAogICAgICAgIHNob3dfZGV0YWlsZWRfZXJyb3JzOiB7CiAgICAgICAgICB0eXBlOiBqc1BzeWNoLnBsdWdpbnMucGFyYW1ldGVyVHlwZS5CT09MLAogICAgICAgICAgZGVmYXVsdDogZmFsc2UsCiAgICAgICAgICBkZXNjcmlwdGlvbjogJ1doZXRoZXIgb3Igbm90IHRvIHNob3cgYSBkZXRhaWxlZCBlcnJvciBtZXNzYWdlIG9uIHRoZSBwYWdlLiBJZiB0cnVlLCB0aGVuIGRldGFpbGVkIGVycm9yIG1lc3NhZ2VzIHdpbGwgYmUgc2hvd24gb24gdGhlICcrCiAgICAgICAgICAncGFnZSBmb3IgYWxsIGZpbGVzIHRoYXQgZmFpbGVkIHRvIGxvYWQsIGFsb25nIHdpdGggdGhlIGdlbmVyYWwgZXJyb3JfbWVzc2FnZS4gVGhpcyBwYXJhbWV0ZXIgaXMgb25seSByZWxldmFudCB3aGVuIGNvbnRpbnVlX2FmdGVyX2Vycm9yIGlzIGZhbHNlLicKICAgICAgICB9LAogICAgICAgIG1heF9sb2FkX3RpbWU6IHsKICAgICAgICAgIHR5cGU6IGpzUHN5Y2gucGx1Z2lucy5wYXJhbWV0ZXJUeXBlLklOVCwKICAgICAgICAgIGRlZmF1bHQ6IG51bGwsCiAgICAgICAgICBkZXNjcmlwdGlvbjogJ1RoZSBtYXhpbXVtIGFtb3VudCBvZiB0aW1lIHRoYXQgdGhlIHBsdWdpbiBzaG91bGQgd2FpdCBiZWZvcmUgc3RvcHBpbmcgdGhlIHByZWxvYWQgYW5kIGVpdGhlciBlbmRpbmcgdGhlIHRyaWFsICcrCiAgICAgICAgICAnKGlmIGNvbnRpbnVlX2FmdGVyX2Vycm9yIGlzIHRydWUpIG9yIHN0b3BwaW5nIHRoZSBleHBlcmltZW50IHdpdGggYW4gZXJyb3IgbWVzc2FnZSAoaWYgY29udGludWVfYWZ0ZXJfZXJyb3IgaXMgZmFsc2UpLiAnKwogICAgICAgICAgJ0lmIG51bGwsIHRoZSBwbHVnaW4gd2lsbCB3YWl0IGluZGVmaW50ZWx5IGZvciB0aGUgZmlsZXMgdG8gbG9hZC4nCiAgICAgICAgfSwKICAgICAgICBvbl9lcnJvcjogewogICAgICAgICAgdHlwZToganNQc3ljaC5wbHVnaW5zLnBhcmFtZXRlclR5cGUuRlVOQ1RJT04sCiAgICAgICAgICBkZWZhdWx0OiBudWxsLAogICAgICAgICAgZGVzY3JpcHRpb246ICdGdW5jdGlvbiB0byBiZSBjYWxsZWQgYWZ0ZXIgYSBmaWxlIGZhaWxzIHRvIGxvYWQuIFRoZSBmdW5jdGlvbiB0YWtlcyB0aGUgZmlsZSBuYW1lIGFzIGl0cyBvbmx5IGFyZ3VtZW50LicKICAgICAgICB9LAogICAgICAgIG9uX3N1Y2Nlc3M6IHsKICAgICAgICAgIHR5cGU6IGpzUHN5Y2gucGx1Z2lucy5wYXJhbWV0ZXJUeXBlLkZVTkNUSU9OLAogICAgICAgICAgZGVmYXVsdDogbnVsbCwKICAgICAgICAgIGRlc2NyaXB0aW9uOiAnRnVuY3Rpb24gdG8gYmUgY2FsbGVkIGFmdGVyIGEgZmlsZSBsb2FkcyBzdWNjZXNzZnVsbHkuIFRoZSBmdW5jdGlvbiB0YWtlcyB0aGUgZmlsZSBuYW1lIGFzIGl0cyBvbmx5IGFyZ3VtZW50LicKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAKICAgIHBsdWdpbi50cmlhbCA9IGZ1bmN0aW9uKGRpc3BsYXlfZWxlbWVudCwgdHJpYWwpIHsKCiAgICAgIHZhciBzdWNjZXNzID0gbnVsbDsKICAgICAgdmFyIHRpbWVvdXQgPSBmYWxzZTsKICAgICAgdmFyIGZhaWxlZF9pbWFnZXMgPSBbXTsKICAgICAgdmFyIGZhaWxlZF9hdWRpbyA9IFtdOwogICAgICB2YXIgZmFpbGVkX3ZpZGVvID0gW107CiAgICAgIHZhciBkZXRhaWxlZF9lcnJvcnMgPSBbXTsKICAgICAgdmFyIGluX3NhZmVfbW9kZSA9IGpzUHN5Y2guZ2V0U2FmZU1vZGVTdGF0dXMoKTsKCiAgICAgIC8vIGNyZWF0ZSBsaXN0IG9mIG1lZGlhIHRvIHByZWxvYWQgLy8KCiAgICAgIHZhciBpbWFnZXMgPSBbXTsKICAgICAgdmFyIGF1ZGlvID0gW107CiAgICAgIHZhciB2aWRlbyA9IFtdOwoKICAgICAgaWYodHJpYWwuYXV0b19wcmVsb2FkKXsKICAgICAgICB2YXIgYXV0b19wcmVsb2FkID0ganNQc3ljaC5wbHVnaW5BUEkuZ2V0QXV0b1ByZWxvYWRMaXN0KCk7CiAgICAgICAgaW1hZ2VzID0gaW1hZ2VzLmNvbmNhdChhdXRvX3ByZWxvYWQuaW1hZ2VzKTsKICAgICAgICBhdWRpbyA9IGF1ZGlvLmNvbmNhdChhdXRvX3ByZWxvYWQuYXVkaW8pOwogICAgICAgIHZpZGVvID0gdmlkZW8uY29uY2F0KGF1dG9fcHJlbG9hZC52aWRlbyk7CiAgICAgIH0KCiAgICAgIGlmKHRyaWFsLnRyaWFscy5sZW5ndGggPiAwKXsKICAgICAgICB2YXIgdHJpYWxfcHJlbG9hZHMgPSBqc1BzeWNoLnBsdWdpbkFQSS5nZXRBdXRvUHJlbG9hZExpc3QodHJpYWwudHJpYWxzKTsKICAgICAgICBpbWFnZXMgPSBpbWFnZXMuY29uY2F0KHRyaWFsX3ByZWxvYWRzLmltYWdlcyk7CiAgICAgICAgYXVkaW8gPSBhdWRpby5jb25jYXQodHJpYWxfcHJlbG9hZHMuYXVkaW8pOwogICAgICAgIHZpZGVvID0gdmlkZW8uY29uY2F0KHRyaWFsX3ByZWxvYWRzLnZpZGVvKTsKICAgICAgfQoKICAgICAgaW1hZ2VzID0gaW1hZ2VzLmNvbmNhdCh0cmlhbC5pbWFnZXMpOwogICAgICBhdWRpbyA9IGF1ZGlvLmNvbmNhdCh0cmlhbC5hdWRpbyk7CiAgICAgIHZpZGVvID0gdmlkZW8uY29uY2F0KHRyaWFsLnZpZGVvKTsKCiAgICAgIGltYWdlcyA9IGpzUHN5Y2gudXRpbHMudW5pcXVlKGpzUHN5Y2gudXRpbHMuZmxhdHRlbihpbWFnZXMpKTsKICAgICAgYXVkaW8gPSBqc1BzeWNoLnV0aWxzLnVuaXF1ZShqc1BzeWNoLnV0aWxzLmZsYXR0ZW4oYXVkaW8pKTsKICAgICAgdmlkZW8gPSBqc1BzeWNoLnV0aWxzLnVuaXF1ZShqc1BzeWNoLnV0aWxzLmZsYXR0ZW4odmlkZW8pKTsKCiAgICAgIGlmIChpbl9zYWZlX21vZGUpIHsKICAgICAgICAvLyBkb24ndCBwcmVsb2FkIHZpZGVvIGlmIGluIHNhZmUgbW9kZSAoZXhwZXJpbWVudCBpcyBydW5uaW5nIHZpYSBmaWxlIHByb3RvY29sKQogICAgICAgIHZpZGVvID0gW107CiAgICAgIH0KCiAgICAgIC8vIHJlbmRlciBkaXNwbGF5IG9mIG1lc3NhZ2UgYW5kIHByb2dyZXNzIGJhcgoKICAgICAgdmFyIGh0bWwgPSAnJzsKCiAgICAgIGlmKHRyaWFsLm1lc3NhZ2UgIT09IG51bGwpewogICAgICAgIGh0bWwgKz0gdHJpYWwubWVzc2FnZTsKICAgICAgfQoKICAgICAgaWYodHJpYWwuc2hvd19wcm9ncmVzc19iYXIpewogICAgICAgIGh0bWwgKz0gYAogICAgICAgICAgPGRpdiBpZD0nanNwc3ljaC1sb2FkaW5nLXByb2dyZXNzLWJhci1jb250YWluZXInIHN0eWxlPSdoZWlnaHQ6IDEwcHg7IHdpZHRoOiAzMDBweDsgYmFja2dyb3VuZC1jb2xvcjogI2RkZDsgbWFyZ2luOiBhdXRvOyc+CiAgICAgICAgICAgIDxkaXYgaWQ9J2pzcHN5Y2gtbG9hZGluZy1wcm9ncmVzcy1iYXInIHN0eWxlPSdoZWlnaHQ6IDEwcHg7IHdpZHRoOiAwJTsgYmFja2dyb3VuZC1jb2xvcjogIzc3NzsnPjwvZGl2PgogICAgICAgICAgPC9kaXY+YDsKICAgICAgfQoKICAgICAgZGlzcGxheV9lbGVtZW50LmlubmVySFRNTCA9IGh0bWw7CgogICAgICAvLyBkbyBwcmVsb2FkaW5nCgogICAgICBpZih0cmlhbC5tYXhfbG9hZF90aW1lICE9PSBudWxsKXsKICAgICAgICBqc1BzeWNoLnBsdWdpbkFQSS5zZXRUaW1lb3V0KG9uX3RpbWVvdXQsIHRyaWFsLm1heF9sb2FkX3RpbWUpOwogICAgICB9IAoKICAgICAgdmFyIHRvdGFsX24gPSBpbWFnZXMubGVuZ3RoICsgYXVkaW8ubGVuZ3RoICsgdmlkZW8ubGVuZ3RoOwogICAgICB2YXIgbG9hZGVkID0gMDsgIC8vIHN1Y2Nlc3Mgb3IgZXJyb3IgY291bnQKICAgICAgdmFyIGxvYWRlZF9zdWNjZXNzID0gMDsgLy8gc3VjY2VzcyBjb3VudAoKICAgICAgaWYgKHRvdGFsX24gPT0gMCkgewogICAgICAgIG9uX3N1Y2Nlc3MoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmdW5jdGlvbiBsb2FkX3ZpZGVvKGNiKXsKICAgICAgICAgIGpzUHN5Y2gucGx1Z2luQVBJLnByZWxvYWRWaWRlbyh2aWRlbywgY2IsIGZpbGVfbG9hZGluZ19zdWNjZXNzLCBmaWxlX2xvYWRpbmdfZXJyb3IpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsb2FkX2F1ZGlvKGNiKXsKICAgICAgICAgIGpzUHN5Y2gucGx1Z2luQVBJLnByZWxvYWRBdWRpbyhhdWRpbywgY2IsIGZpbGVfbG9hZGluZ19zdWNjZXNzLCBmaWxlX2xvYWRpbmdfZXJyb3IpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsb2FkX2ltYWdlcyhjYil7CiAgICAgICAgICBqc1BzeWNoLnBsdWdpbkFQSS5wcmVsb2FkSW1hZ2VzKGltYWdlcywgY2IsIGZpbGVfbG9hZGluZ19zdWNjZXNzLCBmaWxlX2xvYWRpbmdfZXJyb3IpOwogICAgICAgIH0KICAgICAgICBpZiAodmlkZW8ubGVuZ3RoID4gMCkgeyBsb2FkX3ZpZGVvKGZ1bmN0aW9uICgpIHsgfSkgfQogICAgICAgIGlmIChhdWRpby5sZW5ndGggPiAwKSB7IGxvYWRfYXVkaW8oZnVuY3Rpb24gKCkgeyB9KSB9CiAgICAgICAgaWYgKGltYWdlcy5sZW5ndGggPiAwKSB7IGxvYWRfaW1hZ2VzKGZ1bmN0aW9uICgpIHsgfSkgfQogICAgICB9CgogICAgICAvLyBoZWxwZXIgZnVuY3Rpb25zIGFuZCBjYWxsYmFja3MKCiAgICAgIGZ1bmN0aW9uIHVwZGF0ZV9sb2FkaW5nX3Byb2dyZXNzX2JhcigpewogICAgICAgIGxvYWRlZCsrOwogICAgICAgIGlmKHRyaWFsLnNob3dfcHJvZ3Jlc3NfYmFyKXsKICAgICAgICAgIHZhciBwZXJjZW50X2xvYWRlZCA9IChsb2FkZWQvdG90YWxfbikqMTAwOwogICAgICAgICAgdmFyIHByZWxvYWRfcHJvZ3Jlc3NfYmFyID0ganNQc3ljaC5nZXREaXNwbGF5RWxlbWVudCgpLnF1ZXJ5U2VsZWN0b3IoJyNqc3BzeWNoLWxvYWRpbmctcHJvZ3Jlc3MtYmFyJyk7CiAgICAgICAgICBpZiAocHJlbG9hZF9wcm9ncmVzc19iYXIgIT09IG51bGwpIHsKICAgICAgICAgICAgcHJlbG9hZF9wcm9ncmVzc19iYXIuc3R5bGUud2lkdGggPSBwZXJjZW50X2xvYWRlZCsiJSI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBjYWxsZWQgd2hlbiBhIHNpbmdsZSBmaWxlIGxvYWRpbmcgZmFpbHMKICAgICAgZnVuY3Rpb24gZmlsZV9sb2FkaW5nX2Vycm9yKGUpIHsKICAgICAgICAvLyB1cGRhdGUgcHJvZ3Jlc3MgYmFyIGV2ZW4gaWYgdGhlcmUncyBhbiBlcnJvcgogICAgICAgIHVwZGF0ZV9sb2FkaW5nX3Byb2dyZXNzX2JhcigpOwogICAgICAgIC8vIGNoYW5nZSBzdWNjZXNzIGZsYWcgYWZ0ZXIgZmlyc3QgZmlsZSBsb2FkaW5nIGVycm9yCiAgICAgICAgaWYgKHN1Y2Nlc3MgPT0gbnVsbCkgewogICAgICAgICAgc3VjY2VzcyA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICAvLyBhZGQgZmlsZSB0byBmYWlsZWQgbWVkaWEgbGlzdAogICAgICAgIHZhciBzb3VyY2UgPSAidW5rbm93biBmaWxlIjsKICAgICAgICBpZiAoZS5zb3VyY2UpIHsKICAgICAgICAgIHNvdXJjZSA9IGUuc291cmNlOwogICAgICAgIH0KICAgICAgICBpZiAoZS5lcnJvciAmJiBlLmVycm9yLnBhdGggJiYgZS5lcnJvci5wYXRoLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGlmIChlLmVycm9yLnBhdGhbMF0ubG9jYWxOYW1lID09ICJpbWciKSB7CiAgICAgICAgICAgIGZhaWxlZF9pbWFnZXMucHVzaChzb3VyY2UpOwogICAgICAgICAgfSBlbHNlIGlmIChlLmVycm9yLnBhdGhbMF0ubG9jYWxOYW1lID09ICJhdWRpbyIpIHsKICAgICAgICAgICAgZmFpbGVkX2F1ZGlvLnB1c2goc291cmNlKTsKICAgICAgICAgIH0gZWxzZSBpZiAoZS5lcnJvci5wYXRoWzBdLmxvY2FsTmFtZSA9PSAidmlkZW8iKSB7CiAgICAgICAgICAgIGZhaWxlZF92aWRlby5wdXNoKHNvdXJjZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIGNvbnN0cnVjdCBkZXRhaWxlZCBlcnJvciBtZXNzYWdlCiAgICAgICAgdmFyIGVycl9tc2cgPSAnPHA+PHN0cm9uZz5FcnJvciBsb2FkaW5nIGZpbGU6ICcrc291cmNlKyc8L3N0cm9uZz48YnI+JzsKICAgICAgICBpZiAoZS5lcnJvci5zdGF0dXNUZXh0KSB7CiAgICAgICAgICBlcnJfbXNnICs9ICdGaWxlIHJlcXVlc3QgcmVzcG9uc2Ugc3RhdHVzOiAnK2UuZXJyb3Iuc3RhdHVzVGV4dCsnPGJyPic7CiAgICAgICAgfQogICAgICAgIGlmIChlLmVycm9yID09ICI0MDQiKSB7CiAgICAgICAgICBlcnJfbXNnICs9ICc0MDQgLSBmaWxlIG5vdCBmb3VuZC48YnI+JzsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBlLmVycm9yLmxvYWRlZCAhPT0gJ3VuZGVmaW5lZCcgJiYgZS5lcnJvci5sb2FkZWQgIT09IG51bGwgJiYgZS5lcnJvci5sb2FkZWQgIT09IDApIHsKICAgICAgICAgIGVycl9tc2cgKz0gZS5lcnJvci5sb2FkZWQrJyBieXRlcyB0cmFuc2ZlcnJlZC4nOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBlcnJfbXNnICs9ICdGaWxlIGRpZCBub3QgYmVnaW4gbG9hZGluZy4gQ2hlY2sgdGhhdCBmaWxlIHBhdGggaXMgY29ycmVjdCBhbmQgcmVhY2hhYmxlIGJ5IHRoZSBicm93c2VyLDxicj4nKwogICAgICAgICAgJ2FuZCB0aGF0IGxvYWRpbmcgaXMgbm90IGJsb2NrZWQgYnkgY3Jvc3Mtb3JpZ2luIHJlc291cmNlIHNoYXJpbmcgKENPUlMpIGVycm9ycy4nOwogICAgICAgIH0KICAgICAgICBlcnJfbXNnICs9ICc8L3A+JzsKICAgICAgICBkZXRhaWxlZF9lcnJvcnMucHVzaChlcnJfbXNnKTsKICAgICAgICAvLyBjYWxsIHRyaWFsJ3Mgb25fZXJyb3IgZnVuY3Rpb24KICAgICAgICBhZnRlcl9lcnJvcihzb3VyY2UpOwogICAgICAgIC8vIGlmIHRoaXMgaXMgdGhlIGxhc3QgZmlsZQogICAgICAgIGlmIChsb2FkZWQgPT0gdG90YWxfbikgewogICAgICAgICAgaWYgKHRyaWFsLmNvbnRpbnVlX2FmdGVyX2Vycm9yKSB7CiAgICAgICAgICAgIC8vIGlmIGNvbnRpbnVlX2FmdGVyX2Vycm9yIGlzIGZhbHNlLCB0aGVuIHN0b3Agd2l0aCBhbiBlcnJvcgogICAgICAgICAgICBlbmRfdHJpYWwoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIG90aGVyd2lzZSBlbmQgdGhlIHRyaWFsIGFuZCBjb250aW51ZQogICAgICAgICAgICBzdG9wX3dpdGhfZXJyb3JfbWVzc2FnZSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gY2FsbGVkIHdoZW4gYSBzaW5nbGUgZmlsZSBsb2FkcyBzdWNjZXNzZnVsbHkKICAgICAgZnVuY3Rpb24gZmlsZV9sb2FkaW5nX3N1Y2Nlc3Moc291cmNlKSB7CiAgICAgICAgdXBkYXRlX2xvYWRpbmdfcHJvZ3Jlc3NfYmFyKCk7CiAgICAgICAgLy8gY2FsbCB0cmlhbCdzIG9uX3N1Y2Nlc3MgZnVuY3Rpb24KICAgICAgICBhZnRlcl9zdWNjZXNzKHNvdXJjZSk7CiAgICAgICAgbG9hZGVkX3N1Y2Nlc3MrKzsKICAgICAgICBpZiAobG9hZGVkX3N1Y2Nlc3MgPT0gdG90YWxfbikgewogICAgICAgICAgLy8gaWYgdGhpcyBpcyB0aGUgbGFzdCBmaWxlIGFuZCBhbGwgbG9hZGVkIHN1Y2Nlc3NmdWxseSwgY2FsbCBzdWNjZXNzIGZ1bmN0aW9uCiAgICAgICAgICBvbl9zdWNjZXNzKCk7CiAgICAgICAgfSBlbHNlIGlmIChsb2FkZWQgPT0gdG90YWxfbikgewogICAgICAgICAgLy8gaWYgdGhpcyBpcyB0aGUgbGFzdCBmaWxlIGFuZCB0aGVyZSB3YXMgYXQgbGVhc3Qgb25lIGVycm9yCiAgICAgICAgICBpZiAodHJpYWwuY29udGludWVfYWZ0ZXJfZXJyb3IpIHsKICAgICAgICAgICAgLy8gZW5kIHRoZSB0cmlhbCBhbmQgY29udGludWUgd2l0aCBleHBlcmltZW50CiAgICAgICAgICAgIGVuZF90cmlhbCgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gaWYgY29udGludWVfYWZ0ZXJfZXJyb3IgaXMgZmFsc2UsIHRoZW4gc3RvcCB3aXRoIGFuIGVycm9yCiAgICAgICAgICAgIHN0b3Bfd2l0aF9lcnJvcl9tZXNzYWdlKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBjYWxsZWQgaWYgYWxsIGZpbGVzIGxvYWQgc3VjY2Vzc2Z1bGx5CiAgICAgIGZ1bmN0aW9uIG9uX3N1Y2Nlc3MoKSB7CiAgICAgICAgaWYgKHR5cGVvZiB0aW1lb3V0ICE9PSAndW5kZWZpbmVkJyAmJiB0aW1lb3V0ID09PSBmYWxzZSkgewogICAgICAgICAgLy8gY2xlYXIgdGltZW91dCBpbW1lZGlhdGVseSBhZnRlciBmaW5pc2hpbmcsIHRvIGhhbmRsZSByYWNlIGNvbmRpdGlvbiB3aXRoIG1heF9sb2FkX3RpbWUKICAgICAgICAgIGpzUHN5Y2gucGx1Z2luQVBJLmNsZWFyQWxsVGltZW91dHMoKTsKICAgICAgICAgIC8vIG5lZWQgdG8gY2FsbCBjYW5jZWwgcHJlbG9hZCBmdW5jdGlvbiB0byBjbGVhciBnbG9iYWwganNQc3ljaCBwcmVsb2FkX3JlcXVlc3QgbGlzdCwgZXZlbiB3aGVuIHRoZXkndmUgYWxsIHN1Y2NlZWRlZAogICAgICAgICAganNQc3ljaC5wbHVnaW5BUEkuY2FuY2VsUHJlbG9hZHMoKTsKICAgICAgICAgIHN1Y2Nlc3MgPSB0cnVlOwogICAgICAgICAgZW5kX3RyaWFsKCk7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBjYWxsZWQgaWYgYWxsX2ZpbGVzIGhhdmVuJ3QgZmluaXNoZWQgbG9hZGluZyB3aGVuIG1heF9sb2FkX3RpbWUgaXMgcmVhY2hlZAogICAgICBmdW5jdGlvbiBvbl90aW1lb3V0KCkgewogICAgICAgIC8vY29uc29sZS5sb2coJ3RpbWVvdXQgZmlyZWQnKTsKICAgICAgICBqc1BzeWNoLnBsdWdpbkFQSS5jYW5jZWxQcmVsb2FkcygpOwogICAgICAgIGlmICh0eXBlb2Ygc3VjY2VzcyAhPT0gJ3VuZGVmaW5lZCcgJiYgKHN1Y2Nlc3MgPT09IGZhbHNlIHx8IHN1Y2Nlc3MgPT09IG51bGwpKSB7CiAgICAgICAgICB0aW1lb3V0ID0gdHJ1ZTsKICAgICAgICAgIGlmIChsb2FkZWRfc3VjY2VzcyA8IHRvdGFsX24pIHsKICAgICAgICAgICAgc3VjY2VzcyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgYWZ0ZXJfZXJyb3IoJ3RpbWVvdXQnKTsgLy8gY2FsbCB0cmlhbCdzIG9uX2Vycm9yIGV2ZW50IGhhbmRsZXIgaGVyZSwgaW4gY2FzZSBsb2FkaW5nIHRpbWVkIG91dCB3aXRoIG5vIGZpbGUgZXJyb3JzCiAgICAgICAgICBkZXRhaWxlZF9lcnJvcnMucHVzaCgnPHA+PHN0cm9uZz5Mb2FkaW5nIHRpbWVkIG91dC48L3N0cm9uZz48YnI+JysKICAgICAgICAgICAgICAnQ29uc2lkZXIgY29tcHJlc3NpbmcgeW91ciBzdGltdWxpIGZpbGVzLCBsb2FkaW5nIHlvdXIgZmlsZXMgaW4gc21hbGxlciBiYXRjaGVzLDxicj4nKwogICAgICAgICAgICAgICdhbmQvb3IgaW5jcmVhc2luZyB0aGUgPGk+bWF4X2xvYWRfdGltZTwvaT4gcGFyYW1ldGVyLjwvcD4nKTsKICAgICAgICAgIGlmICh0cmlhbC5jb250aW51ZV9hZnRlcl9lcnJvcikgewogICAgICAgICAgICBlbmRfdHJpYWwoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0b3Bfd2l0aF9lcnJvcl9tZXNzYWdlKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBzdG9wX3dpdGhfZXJyb3JfbWVzc2FnZSgpIHsKICAgICAgICBqc1BzeWNoLnBsdWdpbkFQSS5jbGVhckFsbFRpbWVvdXRzKCk7CiAgICAgICAganNQc3ljaC5wbHVnaW5BUEkuY2FuY2VsUHJlbG9hZHMoKTsKICAgICAgICAvLyBzaG93IGVycm9yIG1lc3NhZ2UKICAgICAgICBkaXNwbGF5X2VsZW1lbnQuaW5uZXJIVE1MID0gdHJpYWwuZXJyb3JfbWVzc2FnZTsKICAgICAgICAvLyBzaG93IGRldGFpbGVkIGVycm9ycywgaWYgbmVjZXNzYXJ5CiAgICAgICAgaWYgKHRyaWFsLnNob3dfZGV0YWlsZWRfZXJyb3JzKSB7CiAgICAgICAgICBkaXNwbGF5X2VsZW1lbnQuaW5uZXJIVE1MICs9ICc8cD48c3Ryb25nPkVycm9yIGRldGFpbHM6PC9zdHJvbmc+PC9wPic7CiAgICAgICAgICBkZXRhaWxlZF9lcnJvcnMuZm9yRWFjaChmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIGRpc3BsYXlfZWxlbWVudC5pbm5lckhUTUwgKz0gZTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gYWZ0ZXJfZXJyb3Ioc291cmNlKSB7CiAgICAgICAgLy8gY2FsbCBvbl9lcnJvciBmdW5jdGlvbiBhbmQgcGFzcyBmaWxlIG5hbWUKICAgICAgICBpZiAodHJpYWwub25fZXJyb3IgIT09IG51bGwpIHsKICAgICAgICAgIHRyaWFsLm9uX2Vycm9yKHNvdXJjZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIGFmdGVyX3N1Y2Nlc3Moc291cmNlKSB7CiAgICAgICAgLy8gY2FsbCBvbl9zdWNjZXNzIGZ1bmN0aW9uIGFuZCBwYXNzIGZpbGUgbmFtZQogICAgICAgIGlmICh0cmlhbC5vbl9zdWNjZXNzICE9PSBudWxsKSB7CiAgICAgICAgICB0cmlhbC5vbl9zdWNjZXNzKHNvdXJjZSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBlbmRfdHJpYWwoKXsKICAgICAgICAvLyBjbGVhciB0aW1lb3V0IGFnYWluIHdoZW4gZW5kX3RyaWFsIGlzIGNhbGxlZCwgdG8gaGFuZGxlIHJhY2UgY29uZGl0aW9uIHdpdGggbWF4X2xvYWRfdGltZQogICAgICAgIGpzUHN5Y2gucGx1Z2luQVBJLmNsZWFyQWxsVGltZW91dHMoKTsKICAgICAgICB2YXIgdHJpYWxfZGF0YSA9IHsKICAgICAgICAgIHN1Y2Nlc3M6IHN1Y2Nlc3MsCiAgICAgICAgICB0aW1lb3V0OiB0aW1lb3V0LAogICAgICAgICAgZmFpbGVkX2ltYWdlczogZmFpbGVkX2ltYWdlcywKICAgICAgICAgIGZhaWxlZF9hdWRpbzogZmFpbGVkX2F1ZGlvLAogICAgICAgICAgZmFpbGVkX3ZpZGVvOiBmYWlsZWRfdmlkZW8KICAgICAgICB9OwogICAgICAgIC8vIGNsZWFyIHRoZSBkaXNwbGF5CiAgICAgICAgZGlzcGxheV9lbGVtZW50LmlubmVySFRNTCA9ICcnOwogICAgICAgIGpzUHN5Y2guZmluaXNoVHJpYWwodHJpYWxfZGF0YSk7CiAgICAgIH0KICAgIH07CiAgCiAgICByZXR1cm4gcGx1Z2luOwogIH0pKCk7CiAg"></script>
<script src="data:application/javascript; charset=utf-8;base64,LyoganNwc3ljaC1mdWxsc2NyZWVuLmpzCiAqIEpvc2ggZGUgTGVldXcKICoKICogdG9nZ2xlIGZ1bGxzY3JlZW4gbW9kZSBpbiB0aGUgYnJvd3NlcgogKgogKi8KCmpzUHN5Y2gucGx1Z2lucy5mdWxsc2NyZWVuID0gKGZ1bmN0aW9uKCkgewoKICB2YXIgcGx1Z2luID0ge307CgogIHBsdWdpbi5pbmZvID0gewogICAgbmFtZTogJ2Z1bGxzY3JlZW4nLAogICAgZGVzY3JpcHRpb246ICcnLAogICAgcGFyYW1ldGVyczogewogICAgICBmdWxsc2NyZWVuX21vZGU6IHsKICAgICAgICB0eXBlOiBqc1BzeWNoLnBsdWdpbnMucGFyYW1ldGVyVHlwZS5CT09MLAogICAgICAgIHByZXR0eV9uYW1lOiAnRnVsbHNjcmVlbiBtb2RlJywKICAgICAgICBkZWZhdWx0OiB0cnVlLAogICAgICAgIGFycmF5OiBmYWxzZSwKICAgICAgICBkZXNjcmlwdGlvbjogJ0lmIHRydWUsIGV4cGVyaW1lbnQgd2lsbCBlbnRlciBmdWxsc2NyZWVuIG1vZGUuIElmIGZhbHNlLCB0aGUgYnJvd3NlciB3aWxsIGV4aXQgZnVsbHNjcmVlbiBtb2RlLicKICAgICAgfSwKICAgICAgbWVzc2FnZTogewogICAgICAgIHR5cGU6IGpzUHN5Y2gucGx1Z2lucy5wYXJhbWV0ZXJUeXBlLlNUUklORywKICAgICAgICBwcmV0dHlfbmFtZTogJ01lc3NhZ2UnLAogICAgICAgIGRlZmF1bHQ6ICc8cD5UaGUgZXhwZXJpbWVudCB3aWxsIHN3aXRjaCB0byBmdWxsIHNjcmVlbiBtb2RlIHdoZW4geW91IHByZXNzIHRoZSBidXR0b24gYmVsb3c8L3A+JywKICAgICAgICBhcnJheTogZmFsc2UsCiAgICAgICAgZGVzY3JpcHRpb246ICdIVE1MIGNvbnRlbnQgdG8gZGlzcGxheSBhYm92ZSB0aGUgYnV0dG9uIHRvIGVudGVyIGZ1bGxzY3JlZW4gbW9kZS4nCiAgICAgIH0sCiAgICAgIGJ1dHRvbl9sYWJlbDogewogICAgICAgIHR5cGU6IGpzUHN5Y2gucGx1Z2lucy5wYXJhbWV0ZXJUeXBlLlNUUklORywKICAgICAgICBwcmV0dHlfbmFtZTogJ0J1dHRvbiBsYWJlbCcsCiAgICAgICAgZGVmYXVsdDogICdDb250aW51ZScsCiAgICAgICAgYXJyYXk6IGZhbHNlLAogICAgICAgIGRlc2NyaXB0aW9uOiAnVGhlIHRleHQgdGhhdCBhcHBlYXJzIG9uIHRoZSBidXR0b24gdG8gZW50ZXIgZnVsbHNjcmVlbi4nCiAgICAgIH0sCiAgICAgIGRlbGF5X2FmdGVyOiB7CiAgICAgICAgdHlwZToganNQc3ljaC5wbHVnaW5zLnBhcmFtZXRlclR5cGUuSU5ULAogICAgICAgIHByZXR0eV9uYW1lOiAnRGVsYXkgYWZ0ZXInLAogICAgICAgIGRlZmF1bHQ6IDEwMDAsCiAgICAgICAgYXJyYXk6IGZhbHNlLAogICAgICAgIGRlc2NyaXB0aW9uOiAnVGhlIGxlbmd0aCBvZiB0aW1lIHRvIGRlbGF5IGFmdGVyIGVudGVyaW5nIGZ1bGxzY3JlZW4gbW9kZSBiZWZvcmUgZW5kaW5nIHRoZSB0cmlhbC4nCiAgICAgIH0sCiAgICB9CiAgfQoKICBwbHVnaW4udHJpYWwgPSBmdW5jdGlvbihkaXNwbGF5X2VsZW1lbnQsIHRyaWFsKSB7CgogICAgLy8gY2hlY2sgaWYga2V5cyBhcmUgYWxsb3dlZCBpbiBmdWxsc2NyZWVuIG1vZGUKICAgIHZhciBrZXlib2FyZE5vdEFsbG93ZWQgPSB0eXBlb2YgRWxlbWVudCAhPT0gJ3VuZGVmaW5lZCcgJiYgJ0FMTE9XX0tFWUJPQVJEX0lOUFVUJyBpbiBFbGVtZW50OwogICAgaWYgKGtleWJvYXJkTm90QWxsb3dlZCkgewogICAgICAvLyBUaGlzIGlzIFNhZmFyaSwgYW5kIGtleWJvYXJkIGV2ZW50cyB3aWxsIGJlIGRpc2FibGVkLiBEb24ndCBhbGxvdyBmdWxsc2NyZWVuIGhlcmUuCiAgICAgIC8vIGRvIHNvbWV0aGluZyBlbHNlPwogICAgICBlbmRUcmlhbCgpOwogICAgfSBlbHNlIHsKICAgICAgaWYodHJpYWwuZnVsbHNjcmVlbl9tb2RlKXsKICAgICAgICBkaXNwbGF5X2VsZW1lbnQuaW5uZXJIVE1MID0gdHJpYWwubWVzc2FnZSArICc8YnV0dG9uIGlkPSJqc3BzeWNoLWZ1bGxzY3JlZW4tYnRuIiBjbGFzcz0ianNwc3ljaC1idG4iPicrdHJpYWwuYnV0dG9uX2xhYmVsKyc8L2J1dHRvbj4nOwogICAgICAgIHZhciBsaXN0ZW5lciA9IGRpc3BsYXlfZWxlbWVudC5xdWVyeVNlbGVjdG9yKCcjanNwc3ljaC1mdWxsc2NyZWVuLWJ0bicpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKICAgICAgICAgIGlmIChlbGVtZW50LnJlcXVlc3RGdWxsc2NyZWVuKSB7CiAgICAgICAgICAgIGVsZW1lbnQucmVxdWVzdEZ1bGxzY3JlZW4oKTsKICAgICAgICAgIH0gZWxzZSBpZiAoZWxlbWVudC5tb3pSZXF1ZXN0RnVsbFNjcmVlbikgewogICAgICAgICAgICBlbGVtZW50Lm1velJlcXVlc3RGdWxsU2NyZWVuKCk7CiAgICAgICAgICB9IGVsc2UgaWYgKGVsZW1lbnQud2Via2l0UmVxdWVzdEZ1bGxzY3JlZW4pIHsKICAgICAgICAgICAgZWxlbWVudC53ZWJraXRSZXF1ZXN0RnVsbHNjcmVlbigpOwogICAgICAgICAgfSBlbHNlIGlmIChlbGVtZW50Lm1zUmVxdWVzdEZ1bGxzY3JlZW4pIHsKICAgICAgICAgICAgZWxlbWVudC5tc1JlcXVlc3RGdWxsc2NyZWVuKCk7CiAgICAgICAgICB9CiAgICAgICAgICBlbmRUcmlhbCgpOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICggZG9jdW1lbnQuZnVsbHNjcmVlbkVsZW1lbnQgfHwgZG9jdW1lbnQubW96RnVsbFNjcmVlbkVsZW1lbnQgfHwgZG9jdW1lbnQud2Via2l0RnVsbHNjcmVlbkVsZW1lbnQgKSB7CiAgICAgICAgICBpZiAoZG9jdW1lbnQuZXhpdEZ1bGxzY3JlZW4pIHsKICAgICAgICAgICAgZG9jdW1lbnQuZXhpdEZ1bGxzY3JlZW4oKTsKICAgICAgICAgIH0gZWxzZSBpZiAoZG9jdW1lbnQubXNFeGl0RnVsbHNjcmVlbikgewogICAgICAgICAgICBkb2N1bWVudC5tc0V4aXRGdWxsc2NyZWVuKCk7CiAgICAgICAgICB9IGVsc2UgaWYgKGRvY3VtZW50Lm1vekNhbmNlbEZ1bGxTY3JlZW4pIHsKICAgICAgICAgICAgZG9jdW1lbnQubW96Q2FuY2VsRnVsbFNjcmVlbigpOwogICAgICAgICAgfSBlbHNlIGlmIChkb2N1bWVudC53ZWJraXRFeGl0RnVsbHNjcmVlbikgewogICAgICAgICAgICBkb2N1bWVudC53ZWJraXRFeGl0RnVsbHNjcmVlbigpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbmRUcmlhbCgpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZW5kVHJpYWwoKSB7CgogICAgICBkaXNwbGF5X2VsZW1lbnQuaW5uZXJIVE1MID0gJyc7CgogICAgICBqc1BzeWNoLnBsdWdpbkFQSS5zZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CgogICAgICAgIHZhciB0cmlhbF9kYXRhID0gewogICAgICAgICAgc3VjY2VzczogIWtleWJvYXJkTm90QWxsb3dlZAogICAgICAgIH07CgogICAgICAgIGpzUHN5Y2guZmluaXNoVHJpYWwodHJpYWxfZGF0YSk7CgogICAgICB9LCB0cmlhbC5kZWxheV9hZnRlcik7CgogICAgfQoKICB9OwoKICByZXR1cm4gcGx1Z2luOwp9KSgpOwo="></script>
<script src="data:application/javascript; charset=utf-8;base64,Ly8ganNQc3ljaFNoZWV0IHYyIC0gQSBzaW1wbGUgSmF2YVNjcmlwdCBsaWJyYXJ5IHRvIHVzZSBqc1BzeWNoIGFuZCBHb29nbGUgU2hlZXQgdG8gcnVuIGJlaGF2aW9yYWwgZXhwZXJpbWVudHMgb25saW5lLgovLyBDcmVhdGVkIGJ5IFNoYXNoaSBLYW50IEd1cHRhLCBKdW5lIDA2LCAyMDIxLgoKZnVuY3Rpb24gc2hvd1VwbG9hZFN0YXR1cygpewogIHZhciBqc3BzeWNoX2NvbnRlbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgianNwc3ljaC1jb250ZW50Iik7CiAganNwc3ljaF9jb250ZW50LmlubmVySFRNTCA9ICdVcGxvYWRpbmcgeW91ciBkYXRhPGJyPjxicj48ZGl2IGNsYXNzPSJzcGlubmVyLWJvcmRlciIgcm9sZT0ic3RhdHVzIj48c3BhbiBjbGFzcz0ic3Itb25seSI+TG9hZGluZy4uLjwvc3Bhbj48L2Rpdj4nCn0KCmZ1bmN0aW9uIG9uVXBsb2FkU3VjY2VzcygpewogIHZhciBqc3BzeWNoX2NvbnRlbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgianNwc3ljaC1jb250ZW50Iik7CiAganNwc3ljaF9jb250ZW50LmlubmVySFRNTCA9ICdZb3VyIGRhdGEgaXMgc3VjY2Vzc2Z1bGx5IHVwbG9hZGVkIScKfQoKZnVuY3Rpb24gYWpheENhbGwodXJsLCBkYXRhX3Jvdywgc3ViSUQsIGxhc3RfaSwgaW5iZXR3ZWVuKXsKICBpZiAoZGF0YV9yb3cubGVuZ3RoLTIgPD0gbGFzdF9pKXsKICAgIGNvbnNvbGUubG9nKCdSZW1vdGUgc2hlZXQgdXBkYXRlZCEnLCBkYXRhX3Jvdy5sZW5ndGgsIGxhc3RfaSwgaW5iZXR3ZWVuKTsKICAgIGlmIChpbmJldHdlZW4gPT0gMCl7CiAgICAgIG9uVXBsb2FkU3VjY2VzcygpOwogICAgfQogIH1lbHNlIGlmICgoc3ViSUQgPT0gLTEpICYmIChsYXN0X2kgIT0wKSkgewogICAgalF1ZXJ5LmFqYXgoewogICAgICB1cmw6IHVybCwKICAgICAgbWV0aG9kOiAiR0VUIiwKICAgICAgZGF0YTogW3tuYW1lOiAiZ2V0U3ViSUQiLCB2YWx1ZTogMX1dLAogICAgfSkuZG9uZSgKICAgICAgZnVuY3Rpb24oX19lKXsKICAgICAgICBhamF4Q2FsbCh1cmwsIGRhdGFfcm93LCBfX2VbJ3N1YklEJ10sIGxhc3RfaSwgaW5iZXR3ZWVuKTsKICAgICAgfQogICAgKS5mYWlsKGZ1bmN0aW9uKF9fZSl7CiAgICAgIGNvbnNvbGUubG9nKCdSZW1vdGUgc2hlZXQgdXBkYXRlIGZhaWxlZCcsIF9fZSk7CiAgICAgIHJldHVybiAwOwogICAgfSk7CiAgfWVsc2V7CiAgICB2YXIgZGF0YSA9IFtdOwogICAgdmFyIGZsYWcgPSB0cnVlOwogICAgZGF0YS5wdXNoKGRhdGFfcm93WzBdKTsKICAgIHdoaWxlIChmbGFnKXsKICAgICAgaWYgKChsYXN0X2k8ZGF0YV9yb3cubGVuZ3RoLTIpICYmIChkYXRhLmpvaW4oIlxuIikubGVuZ3RoICsgZGF0YV9yb3dbbGFzdF9pKzFdLmxlbmd0aCA8IDM1MDApKXsKICAgICAgICBkYXRhLnB1c2goZGF0YV9yb3dbbGFzdF9pKzFdKQogICAgICAgIGxhc3RfaSA9IGxhc3RfaSArIDEKICAgICAgfWVsc2V7CiAgICAgICAgalF1ZXJ5LmFqYXgoewogICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICBtZXRob2Q6ICJHRVQiLAogICAgICAgICAgZGF0YTogW3tuYW1lOiAiZGF0YSIsIHZhbHVlOiBkYXRhLmpvaW4oIlxuIil9LCB7bmFtZTogInN1YklEIiwgdmFsdWU6IHN1YklEfV0sCiAgICAgICAgfSkuZG9uZSgKICAgICAgICAgIGZ1bmN0aW9uKF9fZSl7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKE1hdGguZmxvb3IoKGxhc3RfaS8oZGF0YV9yb3cubGVuZ3RoLTIpKSoxMDApLnRvU3RyaW5nKCkgKyAnJSBkYXRhIHNlbnQhJywgX19lKTsKICAgICAgICAgICAgYWpheENhbGwodXJsLCBkYXRhX3JvdywgX19lWydzdWJJRCddLCBsYXN0X2ksIGluYmV0d2Vlbik7CiAgICAgICAgICB9CiAgICAgICAgKS5mYWlsKGZ1bmN0aW9uKF9fZSl7CiAgICAgICAgICBjb25zb2xlLmxvZygnUmVtb3RlIHNoZWV0IHVwZGF0ZSBmYWlsZWQnLCBfX2UpOwogICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfSk7CgogICAgICAgIGZsYWcgPSBmYWxzZTsKICAgICAgfQogICAgfQogIH0KfQoKdmFyIGpzUHN5Y2hTaGVldCA9IHsKICBsYXN0cm93OiAwLAoKICB1cGxvYWRQYXJ0aWFsRGF0YTogZnVuY3Rpb24odXJsLCBkYXRhLCBpbmJldHdlZW49MSl7CiAgICB2YXIgZGF0YV9yb3cgPSBkYXRhLnNwbGl0KC9ccj9cbnxcci8pOwogICAgYWpheENhbGwodXJsLCBkYXRhX3JvdywgLTEsIHRoaXMubGFzdHJvdywgaW5iZXR3ZWVuKTsKICAgIHRoaXMubGFzdHJvdyA9IGRhdGFfcm93Lmxlbmd0aC0yOwogIH0sCgogIHVwbG9hZERhdGE6IGZ1bmN0aW9uKHVybCwgZGF0YSwgaW5iZXR3ZWVuPTApewogICAgaWYgKGluYmV0d2VlbiA9PSAwKXsKICAgICAgc2hvd1VwbG9hZFN0YXR1cygpOwogICAgfQoKICAgIHZhciBkYXRhX3JvdyA9IGRhdGEuc3BsaXQoL1xyP1xufFxyLyk7CiAgICBhamF4Q2FsbCh1cmwsIGRhdGFfcm93LCAtMSwgdGhpcy5sYXN0cm93LCBpbmJldHdlZW4pOwogICAgdGhpcy5sYXN0cm93ID0gZGF0YV9yb3cubGVuZ3RoLTI7CiAgfQp9Cg=="></script>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script type="text/javascript">
  /* create timeline */
  var timeline = [];

  /* define welcome message trial */
  var welcome = {
    type: "html-keyboard-response",
    stimulus: "Welcome to the experiment. Press any key to begin."
  };
  timeline.push(welcome);

  /* define instructions trial */
  var instructions = {
    type: "html-keyboard-response",
    stimulus: "<p>In this experiment, a circle will appear in the center " +
              "of the screen.</p><p>If the circle is <strong>blue</strong>, " +
              "press the letter F on the keyboard as fast as you can.</p>" +
              "<p>If the circle is <strong>orange</strong>, press the letter J " +
              "as fast as you can.</p>" +
              "<div style='width: 700px;'>"+
              "<div style='float: left;'><img src='https://tesla1879.github.io/jsPsychSheet/test2/jspsych-6.3.1/examples/img/blue.png'></img>" +
              "<p class='small'><strong>Press the F key</strong></p></div>" +
              "<div class='float: right;'><img src='https://tesla1879.github.io/jsPsychSheet/test2/jspsych-6.3.1/examples/img/orange.png'></img>" +
              "<p class='small'><strong>Press the J key</strong></p></div>" +
              "</div>"+
              "<p>Press any key to begin.</p>",
    post_trial_gap: 2000
  };
  timeline.push(instructions);

  /* test trials */
  var test_stimuli = [
    { stimulus: "https://tesla1879.github.io/jsPsychSheet/test2/jspsych-6.3.1/examples/img/blue.png", correct_response: 'f' },
    { stimulus: "https://tesla1879.github.io/jsPsychSheet/test2/jspsych-6.3.1/examples/img/orange.png", correct_response: 'j' }
  ];

  var fixation = {
    type: 'html-keyboard-response',
    stimulus: '<div style="font-size:60px;">+</div>',
    choices: jsPsych.NO_KEYS,
    trial_duration: function () {
      return jsPsych.randomization.sampleWithoutReplacement([250, 500, 750, 1000, 1250, 1500, 1750, 2000], 1)[0];
    },
    data: {
      task: 'fixation'
    }
  }

  var test = {
    type: "image-keyboard-response",
    stimulus: jsPsych.timelineVariable('stimulus'),
    choices: ['f', 'j'],
    data: {
      task: 'response',
      correct_response: jsPsych.timelineVariable('correct_response')
    },
    on_finish: function (data) {
      data.correct = jsPsych.pluginAPI.compareKeys(data.response, data.correct_response);
    }
  }

  var test_procedure = {
    timeline: [fixation, test],
    timeline_variables: test_stimuli,
    repetitions: 5,
    randomize_order: true
  }
  timeline.push(test_procedure);

  /* define debrief */

  var debrief_block = {
    type: "html-keyboard-response",
    stimulus: function () {

      var trials = jsPsych.data.get().filter({ task: 'response' });
      var correct_trials = trials.filter({ correct: true });
      var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
      var rt = Math.round(correct_trials.select('rt').mean());

      return "<p>You responded correctly on "+accuracy+"% of the trials.</p>"+
      "<p>Your average response time was "+rt+"ms.</p>"+
      "<p>Press any key to complete the experiment. Thank you!</p>";

    }
  };
  timeline.push(debrief_block);

  /* start the experiment */
  jsPsych.init({
    timeline: timeline,
    show_progress_bar: true,
    on_finish: function () {
      url="https://script.google.com/a/macros/komazawa-u.ac.jp/s/AKfycbzW-Dy6ZF8n3fZL5RH3Hv53GL2K7lXjE0vmrTZKWvgUMoBSH_d1bQhTn_3XmgRYZiKodQ/exec";
      jsPsychSheet.uploadData(jsPsych.data.get().csv());
    }
  });
</script>



<!-- code folding -->



</body>
</html>
